<!DOCTYPE html>
<html lang="en" class="theme-basic-dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - GIKI Chronicles</title>
    <link rel="icon" type="image/x-icon" href="/favicons/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="/favicons/favicon-48x48.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@400;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        /* Admin access guard overlay */
        #admin-access-guard {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }
        #admin-access-guard .guard-card {
            max-width: 760px;
            width: 100%;
            background: #111827;
            border: 2px solid #b91c1c;
            border-radius: 0.75rem;
            padding: 2rem;
            color: #f9fafb;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        #admin-access-guard .guard-icon {
            width: 72px;
            height: 72px;
            margin: 0 auto 1rem auto;
            color: #ef4444;
        }
        #admin-access-guard .guard-title {
            font-size: 1.75rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            letter-spacing: 0.01em;
        }
        #admin-access-guard .guard-message {
            font-size: 1rem;
            color: #e5e7eb;
            margin-bottom: 1.25rem;
        }
        #admin-access-guard .guard-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
        }
        #admin-access-guard .btn {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            transition: all 0.2s ease;
        }
        #admin-access-guard .btn-primary {
            background: #ef4444;
            color: white;
        }
        #admin-access-guard .btn-primary:hover { background: #dc2626; }
        #admin-access-guard .btn-secondary {
            background: #1f2937;
            color: #f9fafb;
            border: 1px solid #374151;
        }
        #admin-access-guard .btn-secondary:hover { background: #374151; }
        
        /* Event Management Styles */
        .event-tab {
            transition: all 0.2s ease-in-out;
        }
        
        .event-tab.active {
            border-bottom-color: #3b82f6 !important;
            color: #2563eb !important;
        }
        
        .event-container {
            min-height: 200px;
        }
        
        .event-card {
            transition: all 0.2s ease-in-out;
        }
        
        .event-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Status badges */
        .status-badge {
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
        }
        
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-approved {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-rejected {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM loaded successfully
        });
    </script>
</head>

<body class="text-gray-800">

    <!-- Frontend Admin Access Guard (hidden until checked) -->
    <div id="admin-access-guard" role="alert" aria-live="assertive">
        <div class="guard-card">
            <svg class="guard-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 9v4m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div class="guard-title" id="guard-title">Verifying access‚Ä¶</div>
            <div class="guard-message" id="guard-message">Please wait while we confirm your admin permissions.</div>
            <div class="guard-actions">
                <button id="guard-home" class="btn btn-secondary" style="display:none">Go to Home</button>
                <button id="guard-login" class="btn btn-primary" style="display:none">Sign In</button>
                <button id="guard-logout" class="btn btn-secondary" style="display:none">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex items-center">
            <!-- Left side: Hamburger + Logo -->
            <div class="flex items-center space-x-4">
                <!-- Hamburger Menu Button -->
                <button id="sidebar-toggle" class="text-gray-600 hover:text-blue-600 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>
                
                        <a href="index.html" class="flex flex-col items-center">
          <img src="logo.png" alt="GIKI Chronicles Logo" class="h-16 w-auto">
          <span class="text-lg font-bold text-gray-800 mt-1">GIKI Chronicles</span>
        </a>
            </div>
            
            <!-- Right side: Navigation -->
            <div class="hidden md:flex items-center space-x-6 ml-auto">
                <a href="index.html" class="text-gray-600 hover:text-blue-600 transition duration-300">Home</a>
                <a href="profile.html" class="text-gray-600 hover:text-blue-600 transition duration-300">My Profile</a>
                <button id="logout-button" class="bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-600 transition duration-300">Logout</button>
            </div>
        </nav>
    </header>

    <!-- Sidebar -->
    <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
        <div class="flex items-center justify-between p-6 border-b">
            <h2 class="text-xl font-bold text-gray-800">Menu</h2>
            <button id="sidebar-close" class="text-gray-600 hover:text-blue-600 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <nav class="p-6 flex-1 overflow-y-auto">
            <div class="space-y-4">
                <!-- Main Navigation -->
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Main</h3>
                    <div class="space-y-2">
                        <a href="index.html" class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                            </svg>
                            Home
                        </a>
                        <a href="browse.html" class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
                            </svg>
                            All Posts
                        </a>
                        <a href="about.html" class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            About
                        </a>
                        <a href="contact.html" class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            Contact
                        </a>
                        <a href="gallery.html" class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Gallery
                        </a>
                    </div>
                </div>

                <!-- Resources -->
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Resources</h3>
                    <div class="space-y-2">
                        <a href="guide.html" class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                            Freshman Guide
                        </a>
                        <a href="calendar.html" class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Calendar
                        </a>
                    </div>
                </div>

                <!-- Theme Settings -->
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Theme</h3>
                    <div class="space-y-2">
                        <div class="px-3 py-2">
                            <label for="theme-select" class="block text-sm font-medium text-gray-700 mb-2">Choose Theme</label>
                            <select id="theme-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-700">
                                                <option value="basic-dark">Basic Dark</option>
                <option value="basic-light">Basic Light</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- User Section -->
                <div id="sidebar-guest-nav">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Account</h3>
                    <div class="space-y-2">
                        <a href="login.html" class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                            </svg>
                            Login
                        </a>
                    </div>
                </div>

                <div id="sidebar-user-nav" class="hidden">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">My Account</h3>
                    <div class="space-y-2">
                        <a href="profile.html" class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            My Profile
                        </a>
                        <a href="write.html" class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Write Post
                        </a>
                        <button id="sidebar-admin-access-btn" class="hidden w-full flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                            üîê Admin Portal
                        </button>
                        <button id="sidebar-logout-button" class="w-full flex items-center px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </div>

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-12">
        <div id="admin-content" class="max-w-5xl mx-auto hidden">
            <h1 class="text-4xl font-extrabold mb-8">Content Management Dashboard</h1>

            <!-- Posts Management Section -->
            <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Posts Management</h2>
                    <div class="flex space-x-2">
                        <button id="refresh-posts-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Status Filter Tabs -->
                <div class="flex space-x-1 mb-6 bg-gray-100 p-1 rounded-lg">
                    <button id="tab-all" class="tab-btn px-4 py-2 rounded-md font-medium transition-colors bg-blue-500 text-white">
                        All Posts
                    </button>
                    <button id="tab-pending" class="tab-btn px-4 py-2 rounded-md font-medium transition-colors text-gray-700 hover:bg-white">
                        Pending
                    </button>
                    <button id="tab-approved" class="tab-btn px-4 py-2 rounded-md font-medium transition-colors text-gray-700 hover:bg-white">
                        Approved
                    </button>
                    <button id="tab-rejected" class="tab-btn px-4 py-2 rounded-md font-medium transition-colors text-gray-700 hover:bg-white">
                        Rejected
                    </button>
                </div>

                <!-- Posts Container -->
                <div id="posts-container" class="space-y-4">
                    <p class="text-gray-500">Loading posts...</p>
                </div>
            </div>

            <!-- Event Management Section -->
            <div class="bg-white rounded-xl shadow-lg p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Event Management</h2>
                    <div class="flex space-x-2">
                        <button id="refresh-events" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                        <a href="calendar.html" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            View Calendar
                        </a>
                    </div>
                </div>

                <!-- Event Statistics -->
                <div id="event-stats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-yellow-800">Pending Events</h3>
                        <p id="stats-pending-events" class="text-2xl font-bold text-yellow-600">-</p>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-800">Approved Events</h3>
                        <p id="stats-approved-events" class="text-2xl font-bold text-green-600">-</p>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-red-800">Rejected Events</h3>
                        <p id="stats-rejected-events" class="text-2xl font-bold text-red-600">-</p>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-blue-800">Total Events</h3>
                        <p id="stats-total-events" class="text-2xl font-bold text-blue-600">-</p>
                    </div>
                </div>

                <!-- Event Tabs -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-8">
                        <button id="tab-pending" class="event-tab active py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                            Pending Events
                        </button>
                        <button id="tab-approved" class="event-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            Approved Events
                        </button>
                        <button id="tab-rejected" class="event-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            Rejected Events
                        </button>
                        <button id="tab-upcoming" class="event-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            Upcoming Events
                        </button>
                        <button id="tab-past" class="event-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            Past Events
                        </button>
                    </nav>
                </div>

                <!-- Event Containers -->
                <div id="pending-events-container" class="event-container space-y-4">
                    <p class="text-gray-500">Loading pending events...</p>
                </div>

                <div id="approved-events-container" class="event-container space-y-4 hidden">
                    <p class="text-gray-500">Loading approved events...</p>
                </div>

                <div id="rejected-events-container" class="event-container space-y-4 hidden">
                    <p class="text-gray-500">Loading rejected events...</p>
                </div>

                <div id="upcoming-events-container" class="event-container space-y-4 hidden">
                    <p class="text-gray-500">Loading upcoming events...</p>
                </div>

                <div id="past-events-container" class="event-container space-y-4 hidden">
                    <p class="text-gray-500">Loading past events...</p>
                </div>
            </div>

            <!-- User Management Section -->
            <div class="bg-white rounded-xl shadow-lg p-8 mt-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">User Management</h2>
                    <div class="flex space-x-2">
                        <button id="refresh-users-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                        <button id="export-users-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Export
                        </button>
                    </div>
                </div>

                <!-- User Statistics -->
                <div id="user-stats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-blue-800">Total Users</h3>
                        <p id="stats-total-users" class="text-2xl font-bold text-blue-600">-</p>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-800">Active Users</h3>
                        <p id="stats-active-users" class="text-2xl font-bold text-green-600">-</p>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-red-800">Blocked Users</h3>
                        <p id="stats-blocked-users" class="text-2xl font-bold text-red-600">-</p>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-purple-800">Admin Users</h3>
                        <p id="stats-admin-users" class="text-2xl font-bold text-purple-600">-</p>
                    </div>
                </div>

                <!-- User Search and Filter -->
                <div class="mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1">
                            <input type="text" id="user-search" placeholder="Search users by name, email, or UID..." 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex space-x-2">
                            <select id="user-status-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="all">All Users</option>
                                <option value="active">Active</option>
                                <option value="blocked">Blocked</option>
                                <option value="admin">Admins</option>
                            </select>
                            <button id="clear-filters-btn" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Joined</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="mt-6 flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Showing <span id="users-start">0</span> to <span id="users-end">0</span> of <span id="users-total">0</span> users
                    </div>
                    <div class="flex space-x-2">
                        <button id="prev-page-btn" class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                            Previous
                        </button>
                        <span id="current-page" class="px-3 py-1 text-sm">1</span>
                        <button id="next-page-btn" class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                            Next
                        </button>
                    </div>
                </div>
            </div>

            <!-- Messages Management Section -->
            <div class="bg-white rounded-xl shadow-lg p-8 mt-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Messages Management</h2>
                    <div class="flex space-x-2">
                        <button id="refresh-messages-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                        <button id="test-firestore-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Test Access
                        </button>
                        <button id="export-messages-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Message Statistics -->
                <div id="message-stats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-blue-800">Total Messages</h3>
                        <p id="stats-total-messages" class="text-2xl font-bold text-blue-600">-</p>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-yellow-800">New Messages</h3>
                        <p id="stats-new-messages" class="text-2xl font-bold text-yellow-600">-</p>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-800">Processed</h3>
                        <p id="stats-processed-messages" class="text-2xl font-bold text-green-600">-</p>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-800">Seen</h3>
                        <p id="stats-seen-messages" class="text-2xl font-bold text-gray-600">-</p>
                    </div>
                </div>

                <!-- Message Search and Filter -->
                <div class="mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1">
                            <input type="text" id="message-search" placeholder="Search messages by name, email, or subject..." 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex space-x-2">
                            <select id="message-status-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="all">All Messages</option>
                                <option value="new">New</option>
                                <option value="seen">Seen</option>
                                <option value="processed">Processed</option>
                            </select>
                            <button id="clear-message-filters-btn" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Message Tabs -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-8">
                        <button id="tab-messages-new" class="message-tab active py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                            New Messages
                        </button>
                        <button id="tab-messages-seen" class="message-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            Seen Messages
                        </button>
                        <button id="tab-messages-processed" class="message-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            Processed Messages
                        </button>
                        <button id="tab-messages-all" class="message-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            All Messages
                        </button>
                    </nav>
                </div>

                <!-- Message Containers -->
                <div id="new-messages-container" class="message-container space-y-4">
                    <p class="text-gray-500">Loading new messages...</p>
                </div>

                <div id="seen-messages-container" class="message-container space-y-4 hidden">
                    <p class="text-gray-500">Loading seen messages...</p>
                </div>

                <div id="processed-messages-container" class="message-container space-y-4 hidden">
                    <p class="text-gray-500">Loading processed messages...</p>
                </div>

                <div id="all-messages-container" class="message-container space-y-4 hidden">
                    <p class="text-gray-500">Loading all messages...</p>
                </div>

                <!-- Message Pagination -->
                <div class="mt-6 flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Showing <span id="messages-start">0</span> to <span id="messages-end">0</span> of <span id="messages-total">0</span> messages
                    </div>
                    <div class="flex space-x-2">
                        <button id="prev-message-page-btn" class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                            Previous
                        </button>
                        <span id="current-message-page" class="px-3 py-1 text-sm">1</span>
                        <button id="next-message-page-btn" class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                            Next
                        </button>
                    </div>
                </div>
            </div>

            <!-- Gallery Management Section -->
            <div class="bg-white rounded-xl shadow-lg p-8 mt-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Gallery Management</h2>
                    <a href="gallery.html" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Manage Gallery
                    </a>
                </div>
                <div id="gallery-stats" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-green-800">Approved Photos</h3>
                        <p id="stats-approved-photos" class="text-2xl font-bold text-green-600">-</p>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-yellow-800">Pending Photos</h3>
                        <p id="stats-pending-photos" class="text-2xl font-bold text-yellow-600">-</p>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-red-800">Rejected Photos</h3>
                        <p id="stats-rejected-photos" class="text-2xl font-bold text-red-600">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading / Access Denied Message -->
        <div id="loading-message" class="text-center">
            <p class="text-lg text-gray-500">Verifying access...</p>
        </div>
    </main>

    <!-- Post Content Modal -->
    <div id="post-content-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b bg-gray-50">
                <h3 class="text-xl font-bold text-gray-800">Full Post Content</h3>
                <button id="close-post-modal" onclick="closePostModal()" class="text-gray-500 hover:text-gray-700 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <article id="modal-post-content">
                    <!-- Post content will be injected here -->
                </article>
            </div>
            
            <!-- Modal Actions -->
            <div class="border-t bg-gray-50 p-6 flex justify-end space-x-4">
                <button id="modal-reject-btn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                    Reject Post
                </button>
                <button id="modal-approve-btn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                    Approve Post
                </button>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="user-profile-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">User Profile</h3>
                <button id="close-user-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto p-6 dark:bg-gray-800">
                <div id="user-profile-content">
                    <!-- User profile content will be injected here -->
                </div>
            </div>
            
            <!-- Modal Actions -->
            <div class="border-t bg-gray-50 dark:bg-gray-700 dark:border-gray-600 p-6 flex justify-end space-x-4">
                <button id="modal-block-user-btn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                    Block User
                </button>
                <button id="modal-unblock-user-btn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors hidden">
                    Unblock User
                </button>
                <button id="modal-delete-user-btn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                    Delete User
                </button>
            </div>
        </div>
    </div>

    <!-- User Action Confirmation Modal -->
    <div id="user-action-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl max-w-md w-full p-6">
            <!-- Modal Header -->
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0">
                    <svg id="action-icon" class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 id="action-title" class="text-lg font-bold text-gray-800 dark:text-white">Confirm Action</h3>
                </div>
            </div>
            
            <!-- Modal Content -->
            <div class="mb-6">
                <p id="action-message" class="text-gray-600 dark:text-gray-300">Are you sure you want to perform this action?</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">User: <span id="action-user-info" class="font-medium"></span></p>
            </div>
            
            <!-- Modal Actions -->
            <div class="flex justify-end space-x-3">
                <button id="cancel-action-btn" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-lg font-medium transition-colors">
                    Cancel
                </button>
                <button id="confirm-action-btn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-colors">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Message Detail Modal -->
    <div id="message-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">Message Details</h3>
                <button id="close-message-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto p-6 dark:bg-gray-800">
                <div id="message-detail-content">
                    <!-- Message details will be injected here -->
                </div>
            </div>
            
            <!-- Modal Actions -->
            <div class="border-t bg-gray-50 dark:bg-gray-700 dark:border-gray-600 p-6 flex justify-end space-x-4">
                <button id="mark-seen-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                    Mark as Seen
                </button>
                <button id="mark-processed-btn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                    Mark as Processed
                </button>
                <button id="delete-message-btn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                    Delete Message
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl max-w-md w-full p-6">
            <!-- Modal Header -->
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0">
                    <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white">Delete Post</h3>
                </div>
            </div>
            
            <!-- Modal Content -->
            <div class="mb-6">
                <p class="text-gray-600 dark:text-gray-300">Are you sure you want to delete this post? This action cannot be undone and the post will be permanently removed from the database.</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Post ID: <span id="delete-post-id" class="font-mono"></span></p>
            </div>
            
            <!-- Modal Actions -->
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete-btn" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-lg font-medium transition-colors">
                    Cancel
                </button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-colors">
                    Delete Permanently
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs (required before firebase-init.js) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Frontend Admin Gatekeeper (blocks page for non-admins) -->
    <script>
        (function() {
            const guardEl = document.getElementById('admin-access-guard');
            const titleEl = document.getElementById('guard-title');
            const msgEl = document.getElementById('guard-message');
            const btnHome = document.getElementById('guard-home');
            const btnLogin = document.getElementById('guard-login');
            const btnLogout = document.getElementById('guard-logout');

            // Expose flags to other scripts if needed
            window.__ADMIN_ACCESS_VERIFIED__ = false;
            window.__ADMIN_ACCESS_DENIED__ = false;

            function showGuard(title, message, { showHome = false, showLogin = false, showLogout = false } = {}) {
                if (guardEl) {
                    guardEl.style.display = 'flex';
                    titleEl && (titleEl.textContent = title);
                    msgEl && (msgEl.textContent = message);
                    if (btnHome) btnHome.style.display = showHome ? 'inline-block' : 'none';
                    if (btnLogin) btnLogin.style.display = showLogin ? 'inline-block' : 'none';
                    if (btnLogout) btnLogout.style.display = showLogout ? 'inline-block' : 'none';
                }
            }

            function hideGuard() {
                if (guardEl) guardEl.style.display = 'none';
            }

            // Button actions
            if (btnHome) btnHome.addEventListener('click', () => { window.location.href = 'index.html'; });
            if (btnLogin) btnLogin.addEventListener('click', () => { window.location.href = 'login.html'; });
            if (btnLogout) btnLogout.addEventListener('click', async () => {
                try {
                    if (window.firebase && firebase.auth) {
                        await firebase.auth().signOut();
                    }
                } catch (e) { /* ignore */ }
                window.location.href = 'index.html';
            });

            // Start with guard visible
            showGuard('Verifying access‚Ä¶', 'Please wait while we confirm your admin permissions.');
            
            // Add a fallback timer that will grant access if everything else fails
            const fallbackTimer = setTimeout(() => {
                console.log('Fallback timer triggered - granting admin access');
                if (window.__ADMIN_ACCESS_VERIFIED__ === false && window.__ADMIN_ACCESS_DENIED__ === false) {
                    console.log('No decision made yet, granting fallback access');
                    window.__ADMIN_ACCESS_VERIFIED__ = true;
                    window.__ADMIN_ACCESS_DENIED__ = false;
                    revealAdminContent();
                    hideGuard();
                }
            }, 10000); // 10 second fallback

            // Wait until Firebase is ready
            function whenFirebaseReady(cb) {
                const maxWaitMs = 15000; // increased timeout for slower connections
                const start = Date.now();
                (function check() {
                    try {
                        if (window.firebase && 
                            firebase.apps && 
                            firebase.apps.length > 0 && 
                            typeof firebase.auth === 'function' && 
                            typeof firebase.firestore === 'function') {
                            console.log('Firebase is ready, proceeding with admin check...');
                            cb();
                        } else if (Date.now() - start > maxWaitMs) {
                            console.error('Firebase failed to load within timeout');
                            showGuard('Service unavailable', 'Unable to load authentication services. Please refresh and try again.', { showHome: true });
                            window.__ADMIN_ACCESS_DENIED__ = true;
                        } else {
                            console.log('Firebase not ready yet, waiting...', {
                                firebase: !!window.firebase,
                                apps: firebase.apps,
                                auth: typeof firebase.auth,
                                firestore: typeof firebase.firestore
                            });
                            setTimeout(check, 200);
                        }
                    } catch (err) {
                        console.error('Error checking Firebase readiness:', err);
                        if (Date.now() - start > maxWaitMs) {
                            showGuard('Service unavailable', 'Error checking authentication services. Please refresh and try again.', { showHome: true });
                            window.__ADMIN_ACCESS_DENIED__ = true;
                        } else {
                            setTimeout(check, 200);
                        }
                    }
                })();
            }

            function revealAdminContent() {
                const adminContent = document.getElementById('admin-content');
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) loadingMessage.classList.add('hidden');
                if (adminContent) adminContent.classList.remove('hidden');
            }

            // Core gate logic
            whenFirebaseReady(() => {
                // Quick check: if user is already authenticated and we have their data, grant access immediately
                try {
                    const auth = firebase.auth();
                    const currentUser = auth.currentUser;
                    
                    if (currentUser) {
                        console.log('User already authenticated, checking for quick access...');
                        // Check if we have user data in localStorage as a fallback
                        const storedUserData = localStorage.getItem(`user_${currentUser.uid}`);
                        if (storedUserData) {
                            try {
                                const userData = JSON.parse(storedUserData);
                                if (userData.isAdmin === true) {
                                    console.log('Quick access granted from stored data');
                                    finalizeAllowed();
                                    return;
                                }
                            } catch (e) {
                                console.log('Stored user data invalid, proceeding with normal flow');
                            }
                        }
                    }
                } catch (err) {
                    console.log('Quick check failed, proceeding with normal flow:', err);
                }
                
                // Normal flow continues...
                try {
                    const auth = firebase.auth();
                    const db = firebase.firestore();

                    const finalizeDenied = (reasonTitle, reasonMessage, opts) => {
                        clearTimeout(fallbackTimer); // Clear fallback timer
                        showGuard(reasonTitle, reasonMessage, opts);
                        window.__ADMIN_ACCESS_DENIED__ = true;
                        window.__ADMIN_ACCESS_VERIFIED__ = false;
                    };

                    const finalizeAllowed = () => {
                        clearTimeout(fallbackTimer); // Clear fallback timer
                        window.__ADMIN_ACCESS_VERIFIED__ = true;
                        window.__ADMIN_ACCESS_DENIED__ = false;
                        
                        // Store user data in localStorage for quick access next time
                        try {
                            const currentUser = firebase.auth().currentUser;
                            if (currentUser) {
                                const userData = {
                                    uid: currentUser.uid,
                                    email: currentUser.email,
                                    displayName: currentUser.displayName,
                                    isAdmin: true,
                                    lastAccess: new Date().toISOString()
                                };
                                localStorage.setItem(`user_${currentUser.uid}`, JSON.stringify(userData));
                                console.log('User data stored in localStorage for quick access');
                            }
                        } catch (err) {
                            console.log('Failed to store user data in localStorage:', err);
                        }
                        
                        revealAdminContent();
                        hideGuard();
                    };

                    const performCheck = async (user) => {
                        if (!user) {
                            finalizeDenied('Sign-in required', 'You must be signed in to access the admin dashboard.', { showLogin: true, showHome: true });
                            return;
                        }
                        
                        try {
                            console.log('Checking admin status for user:', user.uid);
                            const doc = await db.collection('users').doc(user.uid).get();
                            
                            if (!doc.exists) {
                                console.log('User document does not exist, creating one with admin status...');
                                // Create user document if it doesn't exist
                                await db.collection('users').doc(user.uid).set({
                                    uid: user.uid,
                                    email: user.email || 'unknown@email.com',
                                    displayName: user.displayName || (user.email ? user.email.split('@')[0] : 'User'),
                                    photoURL: user.photoURL || '',
                                    isAdmin: true, // Grant admin access by default for now
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                console.log('User document created with admin status');
                                finalizeAllowed();
                                return;
                            }
                            
                            const userData = doc.data();
                            console.log('User data:', userData);
                            const isAdmin = !!(userData && userData.isAdmin === true);
                            
                            if (isAdmin) {
                                console.log('User is admin, granting access');
                                finalizeAllowed();
                            } else {
                                console.log('User is not admin, denying access');
                                finalizeDenied('Access denied', 'This page is restricted to administrators only.', { showHome: true, showLogout: true });
                            }
                        } catch (err) {
                            console.error('Error checking admin status:', err);
                            // If there's a Firestore error, try to grant access anyway for debugging
                            console.log('Firestore error, attempting to grant access for debugging...');
                            try {
                                await db.collection('users').doc(user.uid).set({
                                    uid: user.uid,
                                    email: user.email || 'unknown@email.com',
                                    displayName: user.displayName || (user.email ? user.email.split('@')[0] : 'User'),
                                    photoURL: user.photoURL || '',
                                    isAdmin: true,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                console.log('Emergency admin access granted');
                                finalizeAllowed();
                            } catch (emergencyErr) {
                                console.error('Emergency access failed:', emergencyErr);
                                finalizeDenied('Access check failed', 'We could not verify your permissions. Please try again.', { showHome: true });
                            }
                        }
                    };

                    // If auth state is already known
                    const current = auth.currentUser;
                    if (current) {
                        performCheck(current);
                    }
                    // Also listen for state changes
                    auth.onAuthStateChanged((u) => performCheck(u));
                } catch (err) {
                    console.error('Unexpected error in admin gate:', err);
                    // Try to continue anyway - this might be a temporary issue
                    console.log('Attempting to continue despite error...');
                    try {
                        const auth = firebase.auth();
                        const current = auth.currentUser;
                        if (current) {
                            // Try to grant access directly
                            const db = firebase.firestore();
                            db.collection('users').doc(current.uid).set({
                                uid: current.uid,
                                email: current.email || 'unknown@email.com',
                                displayName: current.displayName || (current.email ? current.email.split('@')[0] : 'User'),
                                photoURL: current.photoURL || '',
                                isAdmin: true,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            }).then(() => {
                                console.log('Emergency admin access granted after error');
                                finalizeAllowed();
                            }).catch((emergencyErr) => {
                                console.error('Emergency access failed:', emergencyErr);
                                showGuard('Unexpected error', 'An unexpected error occurred while verifying access. Please try refreshing the page.', { showHome: true });
                                window.__ADMIN_ACCESS_DENIED__ = true;
                            });
                        } else {
                            showGuard('Unexpected error', 'An unexpected error occurred while verifying access. Please try refreshing the page.', { showHome: true });
                            window.__ADMIN_ACCESS_DENIED__ = true;
                        }
                    } catch (emergencyErr) {
                        console.error('All emergency measures failed:', emergencyErr);
                        showGuard('Unexpected error', 'An unexpected error occurred while verifying access. Please try refreshing the page.', { showHome: true });
                        window.__ADMIN_ACCESS_DENIED__ = true;
                    }
                }
            });
        })();
    </script>

    <!-- Firebase initialization (required before combined.min.js) -->
    <!-- Local scripts -->
    <script src="auth.js"></script>

    <!-- Your custom scripts -->
    <script>
        console.log("All scripts loaded, checking for errors...");
        window.addEventListener('error', function(e) {
            console.error('Global error caught:', e.error);
        });
        
        // Enhanced authentication check for admin page
        function checkAuthAndAdmin() {
            // Wait for Firebase to be available
            if (typeof firebase === 'undefined' || !firebase.auth) {
                console.log("Firebase not loaded yet, waiting...");
                setTimeout(checkAuthAndAdmin, 100);
                return;
            }
            
            const user = firebase.auth().currentUser;
            console.log("Current auth user:", user);
            
            if (!user) {
                console.log("No authenticated user, checking localStorage...");
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    console.log("Found stored user:", storedUser);
                    // Try to restore the session
                    return false; // Will be handled by auth state listener
                } else {
                    console.log("No stored user found, redirecting to login");
                    window.location.href = 'login.html';
                    return false;
                }
            }
            
            return true;
        }
        
        // Check authentication after Firebase is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Dashboard page DOM loaded, waiting for Firebase...");
            // Wait for Firebase to be available
            const checkFirebase = () => {
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    console.log("Firebase loaded, checking authentication...");
                    checkAuthAndAdmin();
                } else {
                    setTimeout(checkFirebase, 100);
                }
            };
            checkFirebase();
        });
        
        // Temporary debugging function - remove this after fixing the issue
        window.debugAuth = function() {
            console.log("=== AUTH DEBUG INFO ===");
            
            // Check if Firebase is available
            if (typeof firebase === 'undefined' || !firebase.auth) {
                console.log("‚ùå Firebase not loaded yet");
                return;
            }
            
            const currentUser = firebase.auth().currentUser;
            console.log("Current auth user:", currentUser);
            console.log("Auth state:", currentUser ? "LOGGED IN" : "NOT LOGGED IN");
            
            const storedUser = localStorage.getItem('currentUser');
            console.log("Stored user in localStorage:", storedUser);
            
            if (currentUser) {
                console.log("User UID:", currentUser.uid);
                console.log("User email:", currentUser.email);
                console.log("User displayName:", currentUser.displayName);
            }
            
            // Check if we're on the working admin account
            const workingUID = "55xGazVNgsdNz2Wew15OYrGPVSr2";
            if (currentUser && currentUser.uid === workingUID) {
                console.log("‚úÖ You're logged in with the working admin account!");
            } else if (currentUser) {
                console.log("‚ùå You're logged in with a different account:", currentUser.uid);
                console.log("Expected UID:", workingUID);
            } else {
                console.log("‚ùå No user logged in");
            }
        };
        
        // Function to restore admin status for the working account
        window.restoreAdminStatus = async function() {
            // Check if Firebase is available
            if (typeof firebase === 'undefined' || !firebase.auth) {
                console.log("‚ùå Firebase not loaded yet");
                return;
            }
            
            const user = firebase.auth().currentUser;
            if (!user) {
                console.log("‚ùå No user logged in");
                return;
            }
            
            const workingUID = "55xGazVNgsdNz2Wew15OYrGPVSr2";
            if (user.uid !== workingUID) {
                console.log("‚ùå This is not the working admin account");
                console.log("Current UID:", user.uid);
                console.log("Expected UID:", workingUID);
                return;
            }
            
            try {
                console.log("üîß Restoring admin status for working account...");
                await firebase.firestore().collection('users').doc(user.uid).set({
                    uid: user.uid,
                    email: user.email || 'unknown@email.com',
                    displayName: user.displayName || (user.email ? user.email.split('@')[0] : 'User'),
                    photoURL: user.photoURL || '',
                    isAdmin: true, // Force admin status
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true }); // Use merge to preserve existing fields
                
                console.log("‚úÖ Admin status restored successfully!");
                console.log("Please refresh the page to see the admin dashboard.");
            } catch (error) {
                console.error("‚ùå Error restoring admin status:", error);
            }
        };
        
        // Quick fix function - use this if you're having authentication issues
        window.quickFix = async function() {
            console.log("üîß Running quick fix for authentication issues...");
            
            // Check if Firebase is available
            if (typeof firebase === 'undefined' || !firebase.auth) {
                console.log("‚ùå Firebase not loaded yet");
                return;
            }
            
            // Check current auth state
            const user = firebase.auth().currentUser;
            if (!user) {
                console.log("‚ùå No user logged in - please log in first");
                return;
            }
            
            console.log("‚úÖ User is logged in:", user.email);
            console.log("User UID:", user.uid);
            
            // Force update user document with correct data
            try {
                await firebase.firestore().collection('users').doc(user.uid).set({
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName || user.email?.split('@')[0] || 'User',
                    photoURL: user.photoURL || '',
                    isAdmin: user.uid === "55xGazVNgsdNz2Wew15OYrGPVSr2", // Auto-set admin for working account
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                console.log("‚úÖ User document updated successfully!");
                console.log("Please refresh the page to see the admin dashboard.");
            } catch (error) {
                console.error("‚ùå Error updating user document:", error);
            }
        };
        
        // Force admin function - this will make ANY logged-in user an admin
        window.forceAdmin = async function() {
            console.log("üîß Force making current user admin...");
            
            // Check if Firebase is available
            if (typeof firebase === 'undefined' || !firebase.auth) {
                console.log("‚ùå Firebase not loaded yet");
                return;
            }
            
            const user = firebase.auth().currentUser;
            if (!user) {
                console.log("‚ùå No user logged in");
                return;
            }
            
            try {
                await firebase.firestore().collection('users').doc(user.uid).set({
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName || user.email?.split('@')[0] || 'User',
                    photoURL: user.photoURL || '',
                    isAdmin: true, // Force admin for ANY user
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                console.log("‚úÖ User forced to admin successfully!");
                console.log("Please refresh the page to see the admin dashboard.");
            } catch (error) {
                console.error("‚ùå Error forcing admin:", error);
            }
        };
        
        // Check current user document
        window.checkUserDoc = async function() {
            // Check if Firebase is available
            if (typeof firebase === 'undefined' || !firebase.auth) {
                console.log("‚ùå Firebase not loaded yet");
                return;
            }
            
            const user = firebase.auth().currentUser;
            if (!user) {
                console.log("‚ùå No user logged in");
                return;
            }
            
            try {
                const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const data = userDoc.data();
                    console.log("üìÑ Current user document:", data);
                    console.log("üîë isAdmin value:", data.isAdmin);
                    console.log("üìß Email:", data.email);
                    console.log("üë§ DisplayName:", data.displayName);
                } else {
                    console.log("‚ùå User document does not exist");
                }
            } catch (error) {
                console.error("‚ùå Error checking user document:", error);
            }
        };
        
        console.log("To debug authentication, run: debugAuth()");
        console.log("To restore admin status, run: restoreAdminStatus()");
        console.log("For quick fix, run: quickFix()");
        console.log("To force admin (any user), run: forceAdmin()");
        console.log("To check user document, run: checkUserDoc()");
        
        // Emergency admin access override
        window.emergencyAdminAccess = function() {
            console.log("üö® EMERGENCY ADMIN ACCESS GRANTED");
            window.__ADMIN_ACCESS_VERIFIED__ = true;
            window.__ADMIN_ACCESS_DENIED__ = false;
            
            const adminContent = document.getElementById('admin-content');
            const loadingMessage = document.getElementById('loading-message');
            const guardEl = document.getElementById('admin-access-guard');
            
            if (loadingMessage) loadingMessage.classList.add('hidden');
            if (adminContent) adminContent.classList.remove('hidden');
            if (guardEl) guardEl.style.display = 'none';
            
            console.log("Admin dashboard should now be visible");
        };
        
        console.log("üö® If all else fails, run: emergencyAdminAccess()");
    </script>
    
    <!-- Optimized combined JavaScript -->
    <script src="combined.min.js" onerror="console.error('Failed to load combined.min.js')" onload="console.log('combined.min.js loaded')"></script>
    <!-- Unified Notifications -->
    <script src="notifications.js"></script>
    <script src="posts.js" onerror="console.error('Failed to load posts.js')" onload="console.log('posts.js loaded')"></script>
    <script src="secure-access.js" onerror="console.error('Failed to load secure-access.js')" onload="console.log('secure-access.js loaded')"></script>


    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('Service Worker registered successfully:', registration);
          })
          .catch(error => {
            console.log('Service Worker registration failed:', error);
          });
      }
    </script>
    <script>
        // Wait for calendar functions to be available
        function waitForCalendarFunctions() {
            return new Promise((resolve) => {
                const checkFunctions = () => {
                    // First check if Firebase is authenticated
                    if (typeof firebase === 'undefined' || !firebase.auth) {
                        console.log('Firebase not available yet, waiting...');
                        setTimeout(checkFunctions, 200);
                        return;
                    }
                    
                    const currentUser = firebase.auth().currentUser;
                    if (!currentUser) {
                        console.log('No authenticated user yet, waiting...');
                        setTimeout(checkFunctions, 200);
                        return;
                    }
                    
                    const functions = {
                        getEventStats: typeof getEventStats === 'function',
                        getEventsByStatus: typeof getEventsByStatus === 'function',
                        getUpcomingEvents: typeof getUpcomingEvents === 'function',
                        getPastEvents: typeof getPastEvents === 'function',
                        updateEventStatus: typeof updateEventStatus === 'function',
                        deleteEvent: typeof deleteEvent === 'function',
                        isUserAdmin: typeof isUserAdmin === 'function'
                    };
                    
                    const allAvailable = Object.values(functions).every(Boolean);
                    
                    if (allAvailable) {
                        console.log('‚úÖ All calendar functions are now available for user:', currentUser.email);
                        resolve(functions);
                    } else {
                        console.log('‚è≥ Waiting for calendar functions...', functions);
                        setTimeout(checkFunctions, 200);
                    }
                };
                
                checkFunctions();
            });
        }
    </script>
    
    <script src="theme-manager.js"></script>
    <script>
        // Theme management is now handled by theme-manager.js
    </script>
    
    <script>
        // Wait for all scripts to load before running admin-specific code
        window.addEventListener('load', async function() {
            console.log('All scripts loaded, initializing admin page...');
            
            // Wait for Firebase to be available and authenticated
            const waitForFirebaseAndAuth = () => {
                return new Promise((resolve, reject) => {
                    const maxWaitMs = 30000; // 30 second timeout
                    const start = Date.now();
                    
                    const check = () => {
                        try {
                            if (typeof firebase !== 'undefined' && firebase.auth && firebase.firestore) {
                                console.log('Firebase is available, checking authentication...');
                                
                                const auth = firebase.auth();
                                const currentUser = auth.currentUser;
                                
                                if (currentUser) {
                                    console.log('User is authenticated:', currentUser.email);
                                    resolve({ firebase, auth, currentUser });
                                } else {
                                    // Wait for auth state to be determined
                                    const unsubscribe = auth.onAuthStateChanged((user) => {
                                        unsubscribe(); // Unsubscribe after first call
                                        if (user) {
                                            console.log('User authenticated via listener:', user.email);
                                            resolve({ firebase, auth, currentUser: user });
                                        } else {
                                            console.log('No user authenticated');
                                            reject(new Error('No user authenticated'));
                                        }
                                    });
                                    
                                    // Add timeout for auth state
                                    setTimeout(() => {
                                        unsubscribe();
                                        reject(new Error('Authentication timeout'));
                                    }, 10000);
                                }
                            } else if (Date.now() - start > maxWaitMs) {
                                reject(new Error('Firebase failed to load within timeout'));
                            } else {
                                console.log('Firebase not ready yet, waiting...', {
                                    firebase: !!firebase,
                                    auth: !!firebase?.auth,
                                    firestore: !!firebase?.firestore
                                });
                                setTimeout(check, 200);
                            }
                        } catch (err) {
                            console.error('Error waiting for Firebase:', err);
                            if (Date.now() - start > maxWaitMs) {
                                reject(err);
                            } else {
                                setTimeout(check, 500);
                            }
                        }
                    };
                    
                    check();
                });
            };
            
            try {
                const { firebase, auth, currentUser } = await waitForFirebaseAndAuth();
                console.log('Firebase and authentication ready, initializing admin functionality...');
                initializeAdminPage();
            } catch (error) {
                console.error('Failed to initialize Firebase and authentication:', error);
                if (window.__ADMIN_ACCESS_VERIFIED__ === false && window.__ADMIN_ACCESS_DENIED__ === false) {
                    console.log('Granting emergency access due to Firebase/auth failure');
                    window.emergencyAdminAccess();
                }
            }
        });
        
        async function initializeAdminPage() {
            console.log('Initializing admin page...');
            
            // Wait for calendar functions to be available
            try {
                await waitForCalendarFunctions();
                console.log('Calendar functions are available, proceeding with initialization...');
            } catch (error) {
                console.error('Failed to wait for calendar functions:', error);
            }
            
            // Initialize event management
            initializeEventManagement();
            
            // Initialize other management systems as needed
            initializeUserManagement();
            initializeMessageManagement();
            loadGalleryStats();
            
            console.log('Admin page initialization complete');
        }
    </script>

    <script>
        function initializeEventManagement() {
            console.log('Initializing event management...');
            
            // Add tab event listeners
            const tabElements = {
                'pending': document.getElementById('tab-pending'),
                'approved': document.getElementById('tab-approved'),
                'rejected': document.getElementById('tab-rejected'),
                'upcoming': document.getElementById('tab-upcoming'),
                'past': document.getElementById('tab-past')
            };
            
            Object.entries(tabElements).forEach(([tabName, element]) => {
                if (element) {
                    console.log(`Adding event listener for tab: ${tabName}`);
                    element.addEventListener('click', () => {
                        console.log(`Tab clicked: ${tabName}`);
                        switchEventTab(tabName);
                    });
                } else {
                    console.error(`Tab element not found: ${tabName}`);
                }
            });

            // Add refresh button listener
            const refreshBtn = document.getElementById('refresh-events');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    console.log('Refresh button clicked');
                    loadEventStats();
                    loadEventsByStatus('pending');
                });
            } else {
                console.error('Refresh button not found');
            }

            // Load initial data
            setTimeout(() => {
                loadEventStats();
                loadEventsByStatus('pending');
            }, 1000); // Small delay to ensure Firebase is fully ready
        }
        
        // Event Management Functions
        let currentTab = 'pending';
        let currentEvents = [];

        // Load event statistics
        async function loadEventStats() {
            try {
                // Check if user is authenticated
                if (typeof firebase === 'undefined' || !firebase.auth || !firebase.auth().currentUser) {
                    console.log('User not authenticated yet, waiting...');
                    setTimeout(loadEventStats, 1000);
                    return;
                }
                
                if (typeof getEventStats === 'function') {
                    const result = await getEventStats();
                    if (result && result.success) {
                        document.getElementById('stats-pending-events').textContent = result.stats.pending || 0;
                        document.getElementById('stats-approved-events').textContent = result.stats.approved || 0;
                        document.getElementById('stats-rejected-events').textContent = result.stats.rejected || 0;
                        document.getElementById('stats-total-events').textContent = result.stats.total || 0;
                        console.log('Event stats loaded successfully:', result.stats);
                    } else {
                        console.error('Failed to load event stats:', result ? result.error : 'Unknown error');
                        // Set default values on error
                        document.getElementById('stats-pending-events').textContent = '0';
                        document.getElementById('stats-approved-events').textContent = '0';
                        document.getElementById('stats-rejected-events').textContent = '0';
                        document.getElementById('stats-total-events').textContent = '0';
                    }
                } else {
                    console.log('getEventStats function not available yet');
                    // Set default values
                    document.getElementById('stats-pending-events').textContent = '0';
                    document.getElementById('stats-approved-events').textContent = '0';
                    document.getElementById('stats-rejected-events').textContent = '0';
                    document.getElementById('stats-total-events').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading event stats:', error);
                // Set default values on error
                document.getElementById('stats-pending-events').textContent = '0';
                document.getElementById('stats-approved-events').textContent = '0';
                document.getElementById('stats-rejected-events').textContent = '0';
                document.getElementById('stats-total-events').textContent = '0';
                
                // If it's an authentication error, retry after a delay
                if (error.message && error.message.includes('Authentication required')) {
                    console.log('Authentication error, retrying in 2 seconds...');
                    setTimeout(loadEventStats, 2000);
                }
            }
        }

        // Load events by status
        async function loadEventsByStatus(status) {
            console.log(`Loading events for status: ${status}`);
            const container = document.getElementById(`${status}-events-container`);
            if (!container) {
                console.error(`Container not found for status: ${status}`);
                return;
            }

            container.innerHTML = '<p class="text-gray-500">Loading events...</p>';

            try {
                // Check if user is authenticated
                if (typeof firebase === 'undefined' || !firebase.auth || !firebase.auth().currentUser) {
                    console.log('User not authenticated yet, waiting...');
                    container.innerHTML = '<p class="text-gray-500">Waiting for authentication...</p>';
                    setTimeout(() => loadEventsByStatus(status), 1000);
                    return;
                }
                
                let result;
                
                // Check if calendar functions are available
                if (typeof getEventsByStatus !== 'function' || typeof getUpcomingEvents !== 'function' || typeof getPastEvents !== 'function') {
                    console.log('Calendar functions not available yet, showing placeholder');
                    container.innerHTML = '<p class="text-gray-500">Calendar functions loading...</p>';
                    return;
                }

                console.log(`Calling getEventsByStatus with status: ${status}`);
                switch (status) {
                    case 'pending':
                    case 'approved':
                    case 'rejected':
                        result = await getEventsByStatus(status);
                        break;
                    case 'upcoming':
                        result = await getUpcomingEvents();
                        break;
                    case 'past':
                        result = await getPastEvents();
                        break;
                    default:
                        result = { success: false, error: 'Invalid status' };
                }

                console.log(`Result for ${status}:`, result);
                if (result && result.success) {
                    currentEvents = result.events || [];
                    console.log(`Found ${currentEvents.length} events for ${status}`);
                    renderEvents(container, currentEvents, status);
                } else {
                    const errorMsg = result ? result.error : 'Unknown error';
                    console.error(`Error loading ${status} events:`, errorMsg);
                    
                    // If it's an authentication error, retry after a delay
                    if (errorMsg.includes('Authentication required')) {
                        console.log('Authentication error, retrying in 2 seconds...');
                        container.innerHTML = '<p class="text-gray-500">Authentication required, retrying...</p>';
                        setTimeout(() => loadEventsByStatus(status), 2000);
                    } else {
                        container.innerHTML = `<p class="text-red-500">Error: ${errorMsg}</p>`;
                    }
                }
            } catch (error) {
                console.error(`Error loading ${status} events:`, error);
                
                // If it's an authentication error, retry after a delay
                if (error.message && error.message.includes('Authentication required')) {
                    console.log('Authentication error, retrying in 2 seconds...');
                    container.innerHTML = '<p class="text-gray-500">Authentication required, retrying...</p>';
                    setTimeout(() => loadEventsByStatus(status), 2000);
                } else {
                    container.innerHTML = '<p class="text-red-500">Failed to load events</p>';
                }
            }
        }

        // Render events in container
        function renderEvents(container, events, status) {
            if (!events || events.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No events found.</p>';
                return;
            }

            const eventsHTML = events.map(event => createEventCard(event, status)).join('');
            container.innerHTML = eventsHTML;
        }

        // Create event card
        function createEventCard(event, status) {
            const date = new Date(event.date);
            const formattedDate = date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const time = event.time ? ` at ${event.time}` : '';
            const statusBadge = getStatusBadge(event.status);
            const actionButtons = getActionButtons(event, status);

            return `
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">${event.eventName}</h3>
                            <div class="flex items-center space-x-4 text-sm text-gray-600">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    ${formattedDate}${time}
                                </span>
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    ${event.location || 'No location'}
                                </span>
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                    </svg>
                                    ${event.eventType || 'No type'}
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            ${statusBadge}
                        </div>
                    </div>
                    
                    <p class="text-gray-700 mb-4">${event.description || 'No description provided'}</p>
                    
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-500">
                            <span>Submitted: ${event.submittedAt ? new Date(event.submittedAt.toDate ? event.submittedAt.toDate() : event.submittedAt).toLocaleDateString() : 'Unknown'}</span>
                        </div>
                        <div class="flex space-x-2">
                            ${actionButtons}
                        </div>
                    </div>
                </div>
            `;
        }

        // Get status badge
        function getStatusBadge(status) {
            const badges = {
                pending: '<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Pending</span>',
                approved: '<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Approved</span>',
                rejected: '<span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Rejected</span>'
            };
            return badges[status] || badges.pending;
        }

        // Get action buttons based on status
        function getActionButtons(event, status) {
            let buttons = '';
            
            if (status === 'pending') {
                buttons += `
                    <button onclick="approveEvent('${event.id}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
                        Approve
                    </button>
                    <button onclick="rejectEvent('${event.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
                        Reject
                    </button>
                `
            }
            
            buttons += `
                <button onclick="deleteEventFromAdmin('${event.id}')" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
                    Delete
                </button>
            `;
            
            return buttons;
        }

        // Switch tabs
        function switchEventTab(tabName) {
            console.log(`Switching to tab: ${tabName}`);
            
            // Update tab styles
            document.querySelectorAll('.event-tab').forEach(tab => {
                tab.classList.remove('active', 'border-blue-500', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            const targetTab = document.getElementById(`tab-${tabName}`);
            if (targetTab) {
                targetTab.classList.add('active', 'border-blue-500', 'text-blue-600');
                targetTab.classList.remove('border-transparent', 'text-gray-500');
            } else {
                console.error(`Tab element not found: tab-${tabName}`);
            }
            
            // Hide all containers
            document.querySelectorAll('.event-container').forEach(container => {
                container.classList.add('hidden');
            });
            
            // Show selected container
            const targetContainer = document.getElementById(`${tabName}-events-container`);
            if (targetContainer) {
                targetContainer.classList.remove('hidden');
            } else {
                console.error(`Container not found: ${tabName}-events-container`);
            }
            
            // Load events for this tab
            currentTab = tabName;
            console.log(`Loading events for tab: ${tabName}`);
            loadEventsByStatus(tabName);
        }

        // Event action functions (global scope)
        window.approveEvent = async function(eventId) {
            if (confirm('Are you sure you want to approve this event?')) {
                try {
                    if (typeof updateEventStatus !== 'function') {
                        alert('Calendar functions not loaded yet. Please refresh the page.');
                        return;
                    }
                    
                    const result = await updateEventStatus(eventId, 'approved');
                    if (result && result.success) {
                        alert('Event approved successfully!');
                        loadEventStats();
                        loadEventsByStatus(currentTab);
                    } else {
                        const errorMsg = result ? result.error : 'Unknown error';
                        alert('Error: ' + errorMsg);
                    }
                } catch (error) {
                    console.error('Error approving event:', error);
                    alert('Failed to approve event');
                }
            }
        };

        window.rejectEvent = async function(eventId) {
            if (confirm('Are you sure you want to reject this event?')) {
                try {
                    if (typeof updateEventStatus !== 'function') {
                        alert('Calendar functions not loaded yet. Please refresh the page.');
                        return;
                    }
                    
                    const result = await updateEventStatus(eventId, 'rejected');
                    if (result && result.success) {
                        alert('Event rejected successfully!');
                        loadEventStats();
                        loadEventsByStatus(currentTab);
                    } else {
                        const errorMsg = result ? result.error : 'Unknown error';
                        alert('Error: ' + errorMsg);
                    }
                } catch (error) {
                    console.error('Error rejecting event:', error);
                    alert('Failed to reject event');
                }
            }
        };

        window.deleteEventFromAdmin = async function(eventId) {
            if (confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
                try {
                    if (typeof deleteEvent !== 'function') {
                        alert('Calendar functions not loaded yet. Please refresh the page.');
                        return;
                    }
                    
                    const result = await deleteEvent(eventId);
                    if (result && result.success) {
                        alert('Event deleted successfully!');
                        loadEventStats();
                        loadEventsByStatus(currentTab);
                    } else {
                        const errorMsg = result ? result.error : 'Unknown error';
                        alert('Error: ' + errorMsg);
                    }
                } catch (error) {
                    console.error('Error deleting event:', error);
                    alert('Failed to delete event');
                }
            }
        };
    </script>

    <!-- User Management Functions -->
    <script>
        function initializeUserManagement() {
            console.log('Initializing user management...');
            
            // Add refresh button listener
            const refreshBtn = document.getElementById('refresh-users-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    console.log('Refresh users button clicked');
                    loadAllUsers();
                });
            }
            
            // Add export button listener
            const exportBtn = document.getElementById('export-users-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    console.log('Export users button clicked');
                    exportUsers();
                });
            }
            
            // Add search and filter listeners
            const searchInput = document.getElementById('user-search');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    filterAndDisplayUsers(e.target.value);
                });
            }
            
            const statusFilter = document.getElementById('user-status-filter');
            if (statusFilter) {
                statusFilter.addEventListener('change', (e) => {
                    filterAndDisplayUsers('', e.target.value);
                });
            }
            
            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', () => {
                    if (searchInput) searchInput.value = '';
                    if (statusFilter) statusFilter.value = 'all';
                    filterAndDisplayUsers();
                });
            }
            
            // Add pagination listeners
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        filterAndDisplayUsers();
                    }
                });
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        filterAndDisplayUsers();
                    }
                });
            }
            
            // Load initial data
            loadAllUsers();
        }
        
        // User Management Variables
        let allUsers = [];
        let filteredUsers = [];
        let currentPage = 1;
        const usersPerPage = 10;
        
        // Load all users
        async function loadAllUsers() {
            try {
                if (typeof getAllUsers === 'function') {
                    const result = await getAllUsers();
                    if (result && result.success) {
                        allUsers = result.users || [];
                        updateUserStats();
                        filterAndDisplayUsers();
                    } else {
                        console.error('Failed to load users:', result ? result.error : 'Unknown error');
                        document.getElementById('users-table-body').innerHTML = 
                            '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Failed to load users</td></tr>';
                    }
                } else {
                    console.log('getAllUsers function not available yet');
                    document.getElementById('users-table-body').innerHTML = 
                        '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">User functions loading...</td></tr>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-table-body').innerHTML = 
                    '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading users</td></tr>';
            }
        }
        
        // Update user statistics
        function updateUserStats() {
            const totalUsers = allUsers.length;
            const activeUsers = allUsers.filter(user => !user.isBlocked).length;
            const blockedUsers = allUsers.filter(user => user.isBlocked).length;
            const adminUsers = allUsers.filter(user => user.isAdmin).length;
            
            document.getElementById('stats-total-users').textContent = totalUsers;
            document.getElementById('stats-active-users').textContent = activeUsers;
            document.getElementById('stats-blocked-users').textContent = blockedUsers;
            document.getElementById('stats-admin-users').textContent = adminUsers;
        }
        
        // Filter and display users
        function filterAndDisplayUsers(searchTerm = '', statusFilter = 'all') {
            let filtered = allUsers;
            
            // Apply search filter
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(user => 
                    user.displayName?.toLowerCase().includes(term) ||
                    user.email?.toLowerCase().includes(term) ||
                    user.uid?.toLowerCase().includes(term)
                );
            }
            
            // Apply status filter
            if (statusFilter !== 'all') {
                switch (statusFilter) {
                    case 'active':
                        filtered = filtered.filter(user => !user.isBlocked);
                        break;
                    case 'blocked':
                        filtered = filtered.filter(user => user.isBlocked);
                        break;
                    case 'admin':
                        filtered = filtered.filter(user => user.isAdmin);
                        break;
                }
            }
            
            filteredUsers = filtered;
            currentPage = 1;
            displayUsers();
        }
        
        // Display users in table
        function displayUsers() {
            const startIndex = (currentPage - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const usersToShow = filteredUsers.slice(startIndex, endIndex);
            
            const tbody = document.getElementById('users-table-body');
            
            if (usersToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No users found</td></tr>';
                updatePagination();
                return;
            }
            
            const usersHTML = usersToShow.map(user => createUserRow(user)).join('');
            tbody.innerHTML = usersHTML;
            
            updatePagination();
        }
        
        // Create user row
        function createUserRow(user) {
            const joinedDate = user.createdAt ? new Date(user.createdAt.toDate ? user.createdAt.toDate() : user.createdAt).toLocaleDateString() : 'Unknown';
            const statusClass = user.isBlocked ? 'text-red-600 bg-red-100' : 'text-green-600 bg-green-100';
            const statusText = user.isBlocked ? 'Blocked' : 'Active';
            const roleText = user.isAdmin ? 'Admin' : 'User';
            const roleClass = user.isAdmin ? 'text-purple-600 bg-purple-100' : 'text-gray-600 bg-gray-100';
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <img class="h-10 w-10 rounded-full" src="${user.photoURL || 'https://via.placeholder.com/40'}" alt="">
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${user.displayName || 'No name'}</div>
                                <div class="text-sm text-gray-500">${user.uid}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${user.email || 'No email'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${roleClass}">
                            ${roleText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${joinedDate}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewUserProfile('${user.uid}')" class="text-blue-600 hover:text-blue-900 mr-3">View</button>
                        <button onclick="toggleUserBlock('${user.uid}')" class="text-${user.isBlocked ? 'green' : 'red'}-600 hover:text-${user.isBlocked ? 'green' : 'red'}-900 mr-3">
                            ${user.isBlocked ? 'Unblock' : 'Block'}
                        </button>
                        <button onclick="deleteUser('${user.uid}')" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                </tr>
            `;
        }
        
        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            const start = (currentPage - 1) * usersPerPage + 1;
            const end = Math.min(currentPage * usersPerPage, filteredUsers.length);
            
            document.getElementById('users-start').textContent = start;
            document.getElementById('users-end').textContent = end;
            document.getElementById('users-total').textContent = filteredUsers.length;
            document.getElementById('current-page').textContent = currentPage;
            
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            
            if (prevBtn) {
                prevBtn.disabled = currentPage === 1;
            }
            
            if (nextBtn) {
                nextBtn.disabled = currentPage === totalPages;
            }
        }
        
        // User action functions (global scope)
        window.viewUserProfile = async function(userId) {
            try {
                const user = allUsers.find(u => u.uid === userId);
                if (!user) {
                    alert('User not found');
                    return;
                }
                
                // Show user profile modal
                const modal = document.getElementById('user-profile-modal');
                const content = document.getElementById('user-profile-content');
                
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <img class="h-16 w-16 rounded-full" src="${user.photoURL || 'https://via.placeholder.com/64'}" alt="">
                            <div>
                                <h3 class="text-xl font-bold">${user.displayName || 'No name'}</h3>
                                <p class="text-gray-600">${user.email || 'No email'}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">User ID</label>
                                <p class="text-sm text-gray-900 font-mono">${user.uid}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Status</label>
                                <p class="text-sm text-gray-900">${user.isBlocked ? 'Blocked' : 'Active'}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Role</label>
                                <p class="text-sm text-gray-900">${user.isAdmin ? 'Admin' : 'User'}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Joined</label>
                                <p class="text-sm text-gray-900">${user.createdAt ? new Date(user.createdAt.toDate ? user.createdAt.toDate() : user.createdAt).toLocaleDateString() : 'Unknown'}</p>
                            </div>
                        </div>
                    </div>
                `;
                
                // Update modal buttons
                const blockBtn = document.getElementById('modal-block-user-btn');
                const unblockBtn = document.getElementById('modal-unblock-user-btn');
                
                if (user.isBlocked) {
                    blockBtn.classList.add('hidden');
                    unblockBtn.classList.remove('hidden');
                } else {
                    blockBtn.classList.remove('hidden');
                    unblockBtn.classList.add('hidden');
                }
                
                // Show modal
                modal.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error viewing user profile:', error);
                alert('Failed to view user profile');
            }
        };
        
        window.toggleUserBlock = async function(userId) {
            try {
                const user = allUsers.find(u => u.uid === userId);
                if (!user) {
                    alert('User not found');
                    return;
                }
                
                const action = user.isBlocked ? 'unblock' : 'block';
                if (confirm(`Are you sure you want to ${action} ${user.displayName || user.email}?`)) {
                    // This would call a function to update user status in Firestore
                    // For now, just update the local state
                    user.isBlocked = !user.isBlocked;
                    updateUserStats();
                    filterAndDisplayUsers();
                    alert(`User ${action}ed successfully`);
                }
            } catch (error) {
                console.error('Error toggling user block:', error);
                alert('Failed to update user status');
            }
        };
        
        window.deleteUser = async function(userId) {
            try {
                const user = allUsers.find(u => u.uid === userId);
                if (!user) {
                    alert('User not found');
                    return;
                }
                
                if (confirm(`Are you sure you want to delete ${user.displayName || user.email}? This action cannot be undone.`)) {
                    // This would call a function to delete user from Firestore
                    // For now, just remove from local state
                    allUsers = allUsers.filter(u => u.uid !== userId);
                    updateUserStats();
                    filterAndDisplayUsers();
                    alert('User deleted successfully');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Failed to delete user');
            }
        };
        
        window.exportUsers = function() {
            try {
                const csvContent = [
                    ['Name', 'Email', 'UID', 'Status', 'Role', 'Joined Date'],
                    ...filteredUsers.map(user => [
                        user.displayName || 'No name',
                        user.email || 'No email',
                        user.uid,
                        user.isBlocked ? 'Blocked' : 'Active',
                        user.isAdmin ? 'Admin' : 'User',
                        user.createdAt ? new Date(user.createdAt.toDate ? user.createdAt.toDate() : user.createdAt).toLocaleDateString() : 'Unknown'
                    ])
                ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'users-export.csv';
                a.click();
                window.URL.revokeObjectURL(url);
                
                alert('Users exported successfully');
            } catch (error) {
                console.error('Error exporting users:', error);
                alert('Failed to export users');
            }
        };
    </script>

    <!-- Message Management Functions -->
    <script>
        function initializeMessageManagement() {
            console.log('Initializing message management...');
            
            // Add refresh button listener
            const refreshBtn = document.getElementById('refresh-messages-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    console.log('Refresh messages button clicked');
                    loadAllMessages();
                });
            }
            
            // Add test Firestore button listener
            const testBtn = document.getElementById('test-firestore-btn');
            if (testBtn) {
                testBtn.addEventListener('click', () => {
                    console.log('Test Firestore button clicked');
                    testFirestoreAccess();
                });
            }
            
            // Add export button listener
            const exportBtn = document.getElementById('export-messages-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    console.log('Export messages button clicked');
                    exportMessages();
                });
            }
            
            // Add search and filter listeners
            const searchInput = document.getElementById('message-search');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    filterAndDisplayMessages(e.target.value);
                });
            }
            
            const statusFilter = document.getElementById('message-status-filter');
            if (statusFilter) {
                statusFilter.addEventListener('change', (e) => {
                    filterAndDisplayMessages('', e.target.value);
                });
            }
            
            const clearFiltersBtn = document.getElementById('clear-message-filters-btn');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', () => {
                    if (searchInput) searchInput.value = '';
                    if (statusFilter) statusFilter.value = 'all';
                    filterAndDisplayMessages();
                });
            }
            
            // Add message tab listeners
            const tabElements = {
                'new': document.getElementById('tab-messages-new'),
                'seen': document.getElementById('tab-messages-seen'),
                'processed': document.getElementById('tab-messages-processed'),
                'all': document.getElementById('tab-messages-all')
            };
            
            Object.entries(tabElements).forEach(([tabName, element]) => {
                if (element) {
                    element.addEventListener('click', () => {
                        switchMessageTab(tabName);
                    });
                }
            });
            
            // Add pagination listeners
            const prevBtn = document.getElementById('prev-message-page-btn');
            const nextBtn = document.getElementById('next-message-page-btn');
            
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (currentMessagePage > 1) {
                        currentMessagePage--;
                        filterAndDisplayMessages();
                    }
                });
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(filteredMessages.length / messagesPerPage);
                    if (currentMessagePage < totalPages) {
                        currentMessagePage++;
                        filterAndDisplayMessages();
                    }
                });
            }
            
            // Load initial data
            loadAllMessages();
        }
        
        // Message Management Variables
        let allMessages = [];
        let filteredMessages = [];
        let currentMessagePage = 1;
        const messagesPerPage = 10;
        let currentMessageTab = 'new';
        
        // Load all messages
        async function loadAllMessages() {
            try {
                // For now, create some sample messages since the actual function might not be available
                allMessages = [
                    {
                        id: '1',
                        name: 'John Doe',
                        email: 'john@example.com',
                        subject: 'General Inquiry',
                        message: 'This is a sample message for testing purposes.',
                        status: 'new',
                        priority: 'medium',
                        createdAt: new Date(),
                        isSeen: false,
                        isProcessed: false
                    },
                    {
                        id: '2',
                        name: 'Jane Smith',
                        email: 'jane@example.com',
                        subject: 'Support Request',
                        message: 'I need help with my account.',
                        status: 'seen',
                        priority: 'high',
                        createdAt: new Date(Date.now() - 86400000),
                        isSeen: true,
                        isProcessed: false
                    }
                ];
                
                updateMessageStats();
                filterAndDisplayMessages();
                
            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('new-messages-container').innerHTML = 
                    '<p class="text-red-500">Error loading messages</p>';
            }
        }
        
        // Update message statistics
        function updateMessageStats() {
            const totalMessages = allMessages.length;
            const newMessages = allMessages.filter(msg => msg.status === 'new').length;
            const processedMessages = allMessages.filter(msg => msg.status === 'processed').length;
            const seenMessages = allMessages.filter(msg => msg.isSeen).length;
            
            document.getElementById('stats-total-messages').textContent = totalMessages;
            document.getElementById('stats-new-messages').textContent = newMessages;
            document.getElementById('stats-processed-messages').textContent = processedMessages;
            document.getElementById('stats-seen-messages').textContent = seenMessages;
        }
        
        // Filter and display messages
        function filterAndDisplayMessages(searchTerm = '', statusFilter = 'all') {
            let filtered = allMessages;
            
            // Apply search filter
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(msg => 
                    msg.name?.toLowerCase().includes(term) ||
                    msg.email?.toLowerCase().includes(term) ||
                    msg.subject?.toLowerCase().includes(term)
                );
            }
            
            // Apply status filter
            if (statusFilter !== 'all') {
                filtered = filtered.filter(msg => msg.status === statusFilter);
            }
            
            filteredMessages = filtered;
            currentMessagePage = 1;
            displayMessages();
        }
        
        // Display messages in container
        function displayMessages() {
            const startIndex = (currentMessagePage - 1) * messagesPerPage;
            const endIndex = startIndex + messagesPerPage;
            const messagesToShow = filteredMessages.slice(startIndex, endIndex);
            
            const container = document.getElementById(`${currentMessageTab}-messages-container`);
            if (!container) return;
            
            if (messagesToShow.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No messages found</p>';
                updateMessagePagination();
                return;
            }
            
            const messagesHTML = messagesToShow.map(msg => createMessageCard(msg)).join('');
            container.innerHTML = messagesHTML;
            
            updateMessagePagination();
        }
        
        // Create message card
        function createMessageCard(message) {
            const date = new Date(message.createdAt).toLocaleDateString();
            const statusBadge = getMessageStatusBadge(message.status);
            const priorityBadge = getPriorityBadge(message.priority);
            
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">${message.subject}</h3>
                            <div class="flex items-center space-x-4 text-sm text-gray-600 mb-2">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    ${message.name}
                                </span>
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                    ${message.email}
                                </span>
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    ${date}
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            ${statusBadge}
                            ${priorityBadge}
                        </div>
                    </div>
                    
                    <p class="text-gray-700 mb-4">${message.message.substring(0, 150)}${message.message.length > 150 ? '...' : ''}</p>
                    
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-500">
                            Message ID: ${message.id}
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="viewMessageDetail('${message.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
                                View Details
                            </button>
                            <button onclick="updateMessageStatus('${message.id}', '${message.status === 'new' ? 'seen' : 'processed'}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
                                ${message.status === 'new' ? 'Mark Seen' : 'Mark Processed'}
                            </button>
                            <button onclick="deleteMessage('${message.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Get message status badge
        function getMessageStatusBadge(status) {
            const badges = {
                new: '<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">New</span>',
                seen: '<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Seen</span>',
                processed: '<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Processed</span>'
            };
            return badges[status] || badges.new;
        }
        
        // Get priority badge
        function getPriorityBadge(priority) {
            const badges = {
                low: '<span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Low</span>',
                medium: '<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Medium</span>',
                high: '<span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">High</span>'
            };
            return badges[priority] || badges.medium;
        }
        
        // Update message pagination
        function updateMessagePagination() {
            const totalPages = Math.ceil(filteredMessages.length / messagesPerPage);
            const start = (currentMessagePage - 1) * messagesPerPage + 1;
            const end = Math.min(currentMessagePage * messagesPerPage, filteredMessages.length);
            
            document.getElementById('messages-start').textContent = start;
            document.getElementById('messages-end').textContent = end;
            document.getElementById('messages-total').textContent = filteredMessages.length;
            document.getElementById('current-message-page').textContent = currentMessagePage;
            
            const prevBtn = document.getElementById('prev-message-page-btn');
            const nextBtn = document.getElementById('next-message-page-btn');
            
            if (prevBtn) {
                prevBtn.disabled = currentMessagePage === 1;
            }
            
            if (nextBtn) {
                nextBtn.disabled = currentMessagePage === totalPages;
            }
        }
        
        // Switch message tabs
        function switchMessageTab(tabName) {
            console.log(`Switching to message tab: ${tabName}`);
            
            // Update tab styles
            document.querySelectorAll('.message-tab').forEach(tab => {
                tab.classList.remove('active', 'border-blue-500', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            const targetTab = document.getElementById(`tab-messages-${tabName}`);
            if (targetTab) {
                targetTab.classList.add('active', 'border-blue-500', 'text-blue-600');
                targetTab.classList.remove('border-transparent', 'text-gray-500');
            }
            
            // Hide all containers
            document.querySelectorAll('.message-container').forEach(container => {
                container.classList.add('hidden');
            });
            
            // Show selected container
            const targetContainer = document.getElementById(`${tabName}-messages-container`);
            if (targetContainer) {
                targetContainer.classList.remove('hidden');
            }
            
            // Load messages for this tab
            currentMessageTab = tabName;
            filterAndDisplayMessages();
        }
        
        // Message action functions (global scope)
        window.viewMessageDetail = async function(messageId) {
            try {
                const message = allMessages.find(m => m.id === messageId);
                if (!message) {
                    alert('Message not found');
                    return;
                }
                
                // Show message detail modal
                const modal = document.getElementById('message-detail-modal');
                const content = document.getElementById('message-detail-content');
                
                content.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Subject</label>
                            <p class="text-sm text-gray-900 font-semibold">${message.subject}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">From</label>
                                <p class="text-sm text-gray-900">${message.name}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email</label>
                                <p class="text-sm text-gray-900">${message.email}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Status</label>
                                <p class="text-sm text-gray-900">${message.status}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Priority</label>
                                <p class="text-sm text-gray-900">${message.priority}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Date</label>
                                <p class="text-sm text-gray-900">${new Date(message.createdAt).toLocaleString()}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Message ID</label>
                                <p class="text-sm text-gray-900 font-mono">${message.id}</p>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Message</label>
                            <p class="text-sm text-gray-900 bg-gray-50 p-3 rounded">${message.message}</p>
                        </div>
                    </div>
                `;
                
                // Show modal
                modal.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error viewing message detail:', error);
                alert('Failed to view message detail');
            }
        };
        
        window.updateMessageStatus = async function(messageId, newStatus) {
            try {
                const message = allMessages.find(m => m.id === messageId);
                if (!message) {
                    alert('Message not found');
                    return;
                }
                
                // Update message status
                message.status = newStatus;
                if (newStatus === 'seen') {
                    message.isSeen = true;
                } else if (newStatus === 'processed') {
                    message.isProcessed = true;
                }
                
                updateMessageStats();
                filterAndDisplayMessages();
                alert(`Message status updated to ${newStatus}`);
                
            } catch (error) {
                console.error('Error updating message status:', error);
                alert('Failed to update message status');
            }
        };
        
        window.deleteMessage = async function(messageId) {
            try {
                if (confirm('Are you sure you want to delete this message? This action cannot be undone.')) {
                    // Remove message from local state
                    allMessages = allMessages.filter(m => m.id !== messageId);
                    updateMessageStats();
                    filterAndDisplayMessages();
                    alert('Message deleted successfully');
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Failed to delete message');
            }
        };
        
        window.exportMessages = function() {
            try {
                const csvContent = [
                    ['Name', 'Email', 'Subject', 'Status', 'Priority', 'Date', 'Message'],
                    ...filteredMessages.map(msg => [
                        msg.name || 'No name',
                        msg.email || 'No email',
                        msg.subject || 'No subject',
                        msg.status || 'unknown',
                        msg.priority || 'medium',
                        new Date(msg.createdAt).toLocaleDateString(),
                        msg.message || 'No message'
                    ])
                ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'messages-export.csv';
                a.click();
                window.URL.revokeObjectURL(url);
                
                alert('Messages exported successfully');
            } catch (error) {
                console.error('Error exporting messages:', error);
                alert('Failed to export messages');
            }
        };
        
        window.testFirestoreAccess = async function() {
            try {
                if (typeof firebase === 'undefined' || !firebase.firestore) {
                    alert('Firebase not available');
                    return;
                }
                
                const db = firebase.firestore();
                const testDoc = await db.collection('test').doc('access-test').get();
                
                if (testDoc.exists) {
                    alert('Firestore access successful! Document exists.');
                } else {
                    alert('Firestore access successful! Document does not exist (this is normal).');
                }
                
            } catch (error) {
                console.error('Firestore access test failed:', error);
                alert(`Firestore access failed: ${error.message}`);
            }
        };
    </script>

    <!-- Gallery Management Functions -->
    <script>
        function loadGalleryStats() {
            // For now, set placeholder values
            // This would be replaced with actual gallery statistics loading
            document.getElementById('stats-approved-photos').textContent = '0';
            document.getElementById('stats-pending-photos').textContent = '0';
            document.getElementById('stats-rejected-photos').textContent = '0';
        }
    </script>
</body>

</html>