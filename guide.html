<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIKI Freshman Guide</title>
    <link rel="icon" type="image/x-icon" href="/favicons/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="/favicons/favicon-48x48.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Custom Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@400;600;700&family=Rock+Salt&family=Special+Elite&family=Indie+Flower&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-lora {
            font-family: 'Lora', serif;
        }

        /* Guide theme palette (mirrors contact/index) */
        .guide-theme {
            --c-navy: #0A1931;
            --c-deep: #1A3D63;
            --c-steel: #4A7FA7;
            --c-light: #B3CFE5;
            --c-snow: #F6FAFD;
        }

        /* Blueish background with layered gradients and campus image */
        body.guide-theme {
            background:
                linear-gradient(135deg, rgba(0,0,0,0.4), rgba(10,25,49,0.3)),
                radial-gradient(circle at 30% 20%, rgba(74,127,167,0.2), transparent),
                radial-gradient(circle at 70% 80%, rgba(26,61,99,0.3), transparent),
                url('background.jpeg') !important;
            background-size: cover !important;
            background-position: center !important;
            background-attachment: fixed !important;
            background-repeat: no-repeat !important;
            background-color: #0A1931 !important;
            overflow-x: hidden; /* prevent horizontal scrollbar on hover effects */
        }

        /* Neutralize global theme backgrounds applied to <html> to avoid flash of old bg */
        html.theme-basic-dark, html.theme-basic-light {
            background: transparent !important;
            background-image: none !important;
            background-color: transparent !important;
        }

        /* Chalky, handwritten display title */
        .handwriting-title {
            font-family: 'Rock Salt', 'Special Elite', 'Indie Flower', cursive;
            letter-spacing: 1px;
            transform: rotate(-1deg) skew(-0.5deg);
            text-shadow: 0 2px 12px rgba(0,0,0,0.25);
        }

        /* Container styling to match the vibe */
        .chronicle-container {
            background: linear-gradient(135deg, rgba(10,25,49,0.85), rgba(26,61,99,0.85));
            color: var(--c-snow);
            border: 1px solid rgba(179,207,229,0.2);
            box-shadow: 0 16px 40px rgba(10,25,49,0.45);
        }

        /* Cards on the grid (icy blue background, darker blue text) */
        .card-panel {
            /* lighter abstract paint-splash in blues: soft wash + translucent drops + streaks */
            background:
                /* lighter drops */
                radial-gradient(150px 110px at 14% 22%, rgba(207,227,242,0.80), transparent 62%),
                radial-gradient(130px 95px at 82% 18%, rgba(187,214,236,0.65), transparent 60%),
                radial-gradient(170px 120px at 30% 78%, rgba(168,203,231,0.50), transparent 60%),
                radial-gradient(190px 130px at 72% 72%, rgba(141,181,217,0.45), transparent 58%),
                /* soft streaks */
                linear-gradient(160deg, rgba(255,255,255,0.08) 12%, transparent 12.5% 20%, rgba(255,255,255,0.06) 20.5% 28%, transparent 28.5% 36%, rgba(255,255,255,0.05) 36.5% 44%, transparent 44.5%),
                /* base wash (lighter blues) */
                linear-gradient(155deg, #CFE3F2 0%, #A7CBE6 58%, #8DB5D9 100%);
            background-blend-mode: screen, screen, overlay, overlay, overlay, normal;
            color: var(--c-deep);
            border: 1px solid rgba(26,61,99,0.22);
            box-shadow: 0 12px 30px rgba(10,25,49,0.12);
            transition: box-shadow .25s ease, transform .25s ease, background .3s ease;
            will-change: transform;
            position: relative;
            overflow: hidden;
        }

        .card-panel::before {
            content: '';
            position: absolute;
            inset: 0;
            pointer-events: none;
            border-radius: inherit;
            /* extra micro splatters */
            background:
                radial-gradient(6px 6px at 18% 30%, rgba(255,255,255,0.35), transparent 60%),
                radial-gradient(9px 9px at 26% 60%, rgba(207,227,242,0.40), transparent 62%),
                radial-gradient(7px 7px at 78% 48%, rgba(255,255,255,0.28), transparent 62%),
                radial-gradient(6px 6px at 64% 26%, rgba(207,227,242,0.35), transparent 62%),
                radial-gradient(5px 5px at 42% 18%, rgba(255,255,255,0.25), transparent 62%);
            mix-blend-mode: overlay;
        }
        .card-panel:hover {
            border-color: rgba(26,61,99,0.36);
            box-shadow: 0 16px 40px rgba(10,25,49,0.20);
            background:
                radial-gradient(150px 110px at 12% 20%, rgba(207,227,242,0.88), transparent 62%),
                radial-gradient(130px 95px at 84% 16%, rgba(187,214,236,0.72), transparent 60%),
                radial-gradient(170px 120px at 28% 76%, rgba(168,203,231,0.56), transparent 60%),
                radial-gradient(190px 130px at 74% 70%, rgba(141,181,217,0.50), transparent 58%),
                linear-gradient(160deg, rgba(255,255,255,0.10) 10%, transparent 10.5% 22%, rgba(255,255,255,0.08) 22.5% 32%, transparent 32.5% 44%, rgba(255,255,255,0.06) 44.5%),
                linear-gradient(155deg, #CFE3F2 0%, #9EC4E2 58%, #89B7DB 100%);
            background-blend-mode: screen, screen, overlay, overlay, overlay, normal;
            transform: translateY(-2px); /* subtle lift without scaling to avoid cutoff */
        }

        /* Expanded section panel */
        .guide-section-panel {
            background: linear-gradient(135deg, rgba(10,25,49,0.9), rgba(26,61,99,0.9));
            color: var(--c-snow);
            border: 1px solid rgba(179,207,229,0.25);
        }

        /* Accent utilities */
        .accent-divider { background-color: rgba(179,207,229,0.45); }
        .accent-dot { background-color: rgba(179,207,229,0.7); }
    </style>
         <script>
         // Apply theme immediately to prevent flash
         (function() {
             const savedTheme = localStorage.getItem('selected-theme') || 'basic-dark';
             
             // Apply to documentElement immediately (always exists)
             if (document.documentElement) {
                 document.documentElement.classList.add(`theme-${savedTheme}`);
             }
             
             // Apply to body when it becomes available
             if (document.body) {
                 document.body.classList.add(`theme-${savedTheme}`);
             } else {
                 // Wait for body to be available
                 document.addEventListener('DOMContentLoaded', function() {
                     if (document.body) {
                         document.body.classList.add(`theme-${savedTheme}`);
                     }
                 });
             }
         })();
     </script>
    <link rel="stylesheet" href="styles.css">

    <!-- Basic error handling -->
    <script>
        // Simple error handler to prevent console spam
        window.addEventListener('error', function (e) {
            if (e.message && e.message.includes('Content Security Policy')) {
                e.preventDefault();
                return false;
            }
        });

        // Prevent unhandled promise rejections from spamming console
        window.addEventListener('unhandledrejection', function (e) {
            if (e.reason && e.reason.message && e.reason.message.includes('offline')) {
                e.preventDefault();
                return false;
            }
        });
    </script>

</head>

<body class="text-gray-800 guide-theme">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex items-center">
            <!-- Left side: Hamburger + Logo -->
            <div class="flex items-center space-x-4">
                <!-- Hamburger Menu Button -->
                <button id="sidebar-toggle" class="text-gray-600 hover:text-blue-600 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>

                <a href="index.html" class="flex flex-col items-center">
                    <img src="logo.png" alt="GIKI Chronicles Logo" class="h-16 w-auto">
                    <span class="text-lg font-bold text-gray-800 mt-1">GIKI Chronicles</span>
                </a>
            </div>

            <!-- Right side: Navigation -->
            <div class="hidden md:flex items-center space-x-6 ml-auto">
                <!-- <a href="index.html" class="text-gray-600 hover:text-blue-600 transition duration-300">Home</a> -->
                <a href="about.html" class="text-gray-600 hover:text-[#4A7FA7] transition duration-300">About</a>
                <!-- <a href="contact.html" class="text-gray-600 hover:text-blue-600 transition duration-300">Contact</a> -->
                <a href="gallery.html"
                    class="relative px-6 py-2.5 text-[#4A7FA7] font-semibold border-2 border-[#4A7FA7] rounded-full overflow-hidden hover:text-white transition-all duration-300 before:absolute before:top-0 before:left-0 before:w-0 before:h-full before:bg-[#4A7FA7] before:rounded-full before:transition-all before:duration-300 hover:before:w-full">
                    <span class="relative z-10">Gallery</span>
                </a>

                <a href="guide.html" data-nav
                    class="relative px-6 py-2.5 text-[#4A7FA7] font-semibold border-2 border-[#4A7FA7] rounded-full overflow-hidden hover:text-white transition-all duration-300 before:absolute before:top-0 before:left-0 before:w-0 before:h-full before:bg-[#4A7FA7] before:rounded-full before:transition-all before:duration-300 hover:before:w-full">
                    <span class="relative z-10">Freshmen Guide</span>
                </a>

                <a href="calendar.html" data-nav
                    class="relative px-6 py-2.5 text-[#4A7FA7] font-semibold border-2 border-[#4A7FA7] rounded-full overflow-hidden hover:text-white transition-all duration-300 before:absolute before:top-0 before:left-0 before:w-0 before:h-full before:bg-[#4A7FA7] before:rounded-full before:transition-all before:duration-300 hover:before:w-full">
                    <span class="relative z-10">Calendar</span>
                </a>
                <!-- GUEST NAVIGATION (DESKTOP) -->
                <div id="guest-nav" class="flex items-center space-x-6">
                    <a href="login.html" class="text-gray-600 hover:text-blue-600 transition duration-300">Login</a>
                    <!-- <a href="signup.html"
            class="bg-blue-600 text-white px-4 py-2 rounded-full hover:bg-blue-700 transition duration-300">Sign Up</a> -->
                </div>

                <!-- USER NAVIGATION (DESKTOP) -->
                <div id="user-nav" class="hidden md:flex items-center space-x-6">
                    <!-- <a href="profile.html" class="text-gray-600 hover:text-blue-600">My Profile</a> -->
                    <!-- <a href="gallery.html" class="text-gray-600 hover:text-blue-600">Gallery</a> -->
                    <!-- <a href="contact.html" class="text-gray-600 hover:text-blue-600">Contact</a> -->
                    <!-- <button id="logout-button"
                        class="bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-600 transition duration-300">Logout</button> -->
                </div>
            </div>
        </nav>
    </header>

    <!-- Sidebar -->
    <div id="sidebar"
        class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
        <div class="flex items-center justify-between p-6 border-b">
            <h2 class="text-xl font-bold text-gray-800">Menu</h2>
            <button id="sidebar-close" class="text-gray-600 hover:text-blue-600 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
        </div>

        <nav class="p-6 flex-1 overflow-y-auto">
            <div class="space-y-4">
                <!-- Main Navigation -->
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Main</h3>
                    <div class="space-y-2">
                        <a href="index.html"
                            class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                                </path>
                            </svg>
                            Home
                        </a>
                        <a href="about.html"
                            class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            About
                        </a>
                        <a href="contact.html"
                            class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                </path>
                            </svg>
                            Contact
                        </a>
                        <a href="gallery.html"
                            class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                </path>
                            </svg>
                            Gallery
                        </a>
                    </div>
                </div>

                <!-- Resources -->
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Resources</h3>
                    <div class="space-y-2">
                        <a href="guide.html" data-nav
                            class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                                </path>
                            </svg>
                            Freshman Guide
                        </a>
                        <a href="calendar.html" data-nav
                            class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                </path>
                            </svg>
                            Calendar
                        </a>
                    </div>
                </div>

                <!-- Theme Settings -->
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Theme</h3>
                    <div class="space-y-2">
                        <div class="px-3 py-2">
                            <label for="theme-select" class="block text-sm font-medium text-gray-700 mb-2">Choose
                                Theme</label>
                            <select id="theme-select"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-700">
                                <option value="basic-dark">Basic Dark</option>
                                <option value="basic-light">Basic Light</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- User Section -->
                <div id="sidebar-guest-nav">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Account</h3>
                    <div class="space-y-2">
                        <a href="login.html"
                            class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1">
                                </path>
                            </svg>
                            Login
                        </a>
                        <a href="signup.html"
                            class="flex items-center px-3 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z">
                                </path>
                            </svg>
                            Sign Up
                        </a>
                    </div>
                </div>

                <div id="sidebar-user-nav" class="hidden">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">My Account</h3>
                    <div class="space-y-2">
                        <a href="profile.html"
                            class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            My Profile
                        </a>
                        <a href="write.html"
                            class="flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                </path>
                            </svg>
                            Write Post
                        </a>
                        <button id="sidebar-admin-access-btn"
                            class="hidden w-full flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z">
                                </path>
                            </svg>
                            🔐 Admin Portal
                        </button>
                        <button id="sidebar-logout-button"
                            class="w-full flex items-center px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition duration-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                                </path>
                            </svg>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </div>

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

    <div id="root"></div>

    <!-- Firebase SDKs (required before combined.min.js) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Optimized combined JavaScript (includes Firebase initialization) -->
    <script src="combined.min.js"></script>
    <!-- Unified Notifications -->
    <script src="notifications.js"></script>

    <!-- Your React Component -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Use the global firebaseConfig from firebase-init.js

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Add error handling for Firebase
        const safeFirebaseCall = (callback) => {
            try {
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    return callback();
                }
                return null;
            } catch (error) {
                console.warn('Firebase not available:', error);
                return null;
            }
        };

        // Essential items from packinglist.txt
        const essentialItems = [
            "Bedsheets",
            "Pillow Cover",
            "Blanket/Chadar",
            "Toiletries",
            "Towels",
            "Water Bottle",
            "Bug Spray",
            "Umbrella",
            "Cleaning Cloth",
            "Laptop",
            "Phone Charger",
            "Backpack (for classes)",
            "Handcarry suitcase (for weekend travel, depends)",
            "Laundry Basket",
            "Nail cutter",
            "Stapler",
            "Hangers",
            "Tissues",
            "Snacks",
            "Prayer Mat",
            "Plates, Cup, Glass, Utensils, Bowl",
            "Deodorant, Body Spray or Perfume",
            "Sewing Kit",
            "Washing powder",
            "Dishwashing Items",
            "CNIC and Registration Info",
            "Scissors",
            "Knife",
            "Slippers",
            "Clothes (casual + formal for presentations)",
            "Mirror",
            "Calculator",
            "Kettle",
            "Iron",
            "Medicines"
        ];

        // Extracted packing categories from detail_packing_list.html
        const detailPackingData = {
            clothing: [
                "Casual everyday wear (shirts, trousers, shalwar kameez)",
                "Formal attire for presentations",
                "Sweaters/Jackets for winter",
                "Sleepwear",
                "Undergarments and socks",
                "Towels (at least 2)",
                "Sportswear for gym/sports",
                "Flip-flops/slippers",
                "Deodorant, body spray, or perfume",
                "Sewing kit"
            ],
            bedding: [
                "Bed sheets (at least 2 sets)",
                "Pillow and pillowcases",
                "Blanket or comforter",
                "Mattress protector (optional but recommended)",
                "Bug spray",
                "Cleaning cloth",
                "Laundry basket"
            ],
            academics: [
                "Laptop and charger",
                "Phone charger",
                "Backpack (for classes)",
                "Stationery (pens, notebooks, etc.)",
                "Scientific calculator",
                "USB flash drive",
                "Extension cord/power strip",
                "Stapler"
            ],
            misc: [
                "Toiletries (soap, shampoo, toothpaste, etc.)",
                "Mug, plate, glass, bowl, and utensils",
                "Water bottle",
                "Padlock for your cupboard",
                "Basic first-aid kit",
                "Any personal medications",
                "Prayer mat (if needed)",
                "Umbrella",
                "Handcarry suitcase (for weekend travel, optional)",
                "Nail cutter",
                "Tissues",
                "Snacks",
                "Washing powder",
                "Dishwashing items",
                "CNIC and registration info",
                "Scissors",
                "Knife",
                "Kettle",
                "Iron",
                "Mirror",
                "Hangers"
            ]
        };

        const normalizeItem = (s) => s.toLowerCase().trim();

        const getDedupedPackingData = () => {
            const addUnique = (list, seen) => list.filter((i) => {
                const n = normalizeItem(i);
                if (seen.has(n)) return false;
                seen.add(n);
                return true;
            });

            const seen = new Set();
            const clothing = addUnique(detailPackingData.clothing, seen);
            const bedding = addUnique(detailPackingData.bedding, seen);
            const academics = addUnique(detailPackingData.academics, seen);
            const misc = addUnique(detailPackingData.misc, seen);
            const essentials = addUnique(essentialItems, seen);

            return { clothing, bedding, academics, misc, essentials };
        };

        const slugify = (text) =>
            text
                .toString()
                .toLowerCase()
                .trim()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-');

        // Normalize function removed during revert

        // Hardcoded societies and teams data to be used if Firestore is empty.
        const societiesData = {
            academic: {
                title: "🎯 Academic & Technical Societies",
                societies: [
                    { name: "ACM (Association for Computing Machinery)", description: "Focuses on programming, software development, and CS-related competitions, workshops, and hackathons." },
                    { name: "AIAA (American Institute of Aeronautics and Astronautics)", description: "An aerospace-focused society supporting projects like UAV design and participation in the Design/Build/Fly competition." },
                    { name: "IEEE (Institute of Electrical and Electronics Engineers)", description: "Covers electronics, robotics, embedded systems, and electrical innovation through events and hands-on projects." },
                    { name: "GMS (GIKI Mathematics Society)", description: "Promotes analytical thinking and math literacy through competitions, puzzles, and problem-solving events." },
                    { name: "NETRONiX", description: "GIKI's network and gaming society; manages campus LAN infrastructure and organizes e-sports and tech events like Über.GameX." },
                    { name: "Science Society (GIKI Science Society)", description: "Encourages scientific research and experimentation through exhibitions, science fairs, and DIY projects." },
                ]
            },
            cultural: {
                title: "🎭 Cultural, Media & Literary Societies",
                societies: [
                    { name: "Naqsh (Naqsh Arts Society)", description: "Promotes visual arts, including painting, calligraphy, and sketching, while celebrating cultural expression." },
                    { name: "LDS (Literary and Debating Society)", description: "GIKI's official platform for debates, MUNs, declamations, and creative writing competitions." },
                    { name: "Media Club", description: "Handles photography, videography, and media coverage of campus events; creates multimedia content for the student body." },
                    { name: "CDeS (Comedy and Dramatics Entertainment Society)", description: "Performs comedy skits, plays, and theatre productions; GIKI's center for dramatics and stage acting." },
                ]
            },
            social: {
                title: "📢 Social Impact & Professional Development Societies",
                societies: [
                    { name: "SOPHEP (Society for the Promotion of Higher Education in Pakistan)", description: "Offers career counseling, professional development, and alumni networking opportunities." },
                    { name: "LES (Leadership and Entrepreneurship Society)", description: "Promotes entrepreneurial thinking and leadership through startup competitions, business simulations, and guest talks." },
                    { name: "Project Topi", description: "GIKI's community outreach initiative that supports education, health, and welfare programs in the local Topi area." },
                ]
            },
            teams: {
                title: "🚀 GIKI Competitive & Engineering Teams",
                societies: [
                    { name: "Team Invictus (AIAA)", description: "Designs, builds, and flies remote-controlled aircraft for the AIAA Design/Build/Fly competition in the U.S. Represents GIKI internationally in aerospace design." },
                    { name: "Team Foxtrot (Independent)", description: "Builds fully autonomous UAVs for global competitions like the IMechE UAS Challenge. Focuses on drone engineering, embedded systems, and AI-based navigation." },
                    { name: "Team Infinity (Formula Student / Mechanical Engineering)", description: "GIKI's Formula SAE team that designs and fabricates a formula-style electric race car for international motorsport engineering contests like FSUK." },
                    { name: "Team Urban (Shell Eco-marathon)", description: "Develops ultra energy-efficient urban concept vehicles. Competes in Shell Eco-marathon Asia and Pakistan, focusing on innovation in sustainable transport." },
                    { name: "Team Hammerhead (Shell Eco-marathon)", description: "Specializes in electric prototype vehicles for Shell Eco-marathon. Focuses on lightweight design, battery optimization, and aerodynamic performance." },
                    { name: "Team Swift (Independent)", description: "An engineering design team dedicated to building performance drones and UAVs, participating in aerial tech competitions and advancing drone innovation on campus." },
                ]
            }
        };

        // Dorm room media configuration
        const dormMediaConfig = {
            "boysHostel": {
                "media": [
                    {
                        "filename": "boys-room-tour copy.mp4",
                        "type": "video",
                        "title": "Boys Hostel Room Tour",
                        "description": "A complete tour of a typical boys hostel room"
                    }
                ]
            },
            "girlsHostel": {
                "media": [
                    {
                        "filename": "girls-room-tour.mp4",
                        "type": "video",
                        "title": "Girls Hostel Room Tour",
                        "description": "A complete tour of a typical girls hostel room"
                    }
                ]
            }
        };

        // Placeholder data for the guide sections.
        const guidePlaceholderData = [
            { id: "important-contacts", tag: "Important Contacts", shortDescription: "Key people and departments to know on campus.", fullContent: [{ contact: "Hostel Warden", department: "Hostel Administration", purpose: "Primary contact for all hostel-related issues." }, { contact: "Class Representatives (CRs)", department: "Student Body", purpose: "Reach out for academic matters and class-related issues." }, { contact: "IT Cell", department: "Information Technology", purpose: "For network, internet, and technical issues on campus." }, { contact: "Health Center", department: "Medical Services", purpose: "Available for medical emergencies and health consultations." }, { contact: "Transport Help", department: "Transport Office", purpose: "Assistance with campus transport and bus services." }], faqs: [{ question: "Where is the Health Center located?", answer: "The Health Center is located near the main administration building." }, { question: "How do I contact my CR?", answer: "Your CRs will be introduced in the first few days of orientation. You will have a class group chat where you can contact them." }], warnings: ["Do not hesitate to reach out for help. The GIKI administration and student body are there to support you."] },
            { id: "student-id-documents", tag: "Student ID & Documents", shortDescription: "Essential documents and ID requirements for new students.", fullContent: "Getting your student ID and organizing your documents is one of the first things you'll need to do upon arrival at GIKI. Here's everything you need to know about the process and what documents to bring.\n\nRequired Documents for Registration:\n\n- Original CNIC (Computerized National Identity Card) or B-Form\n- Original Matriculation Certificate\n- Original Intermediate Certificate\n- Original DMC (Detailed Marks Certificate) of Matric and Intermediate\n- Character Certificate from your previous institution\n- Medical Fitness Certificate\n- 8 recent passport-size photographs (with blue background)\n- Copy of your admission letter\n- Fee challan receipt\n\nStudent ID Card Process:\n\nYour student ID card is your most important document at GIKI. It serves multiple purposes:\n- Library access and book borrowing\n- Mess entry and meal tracking\n- Campus security and identification\n- Attendance tracking in some departments\n- Access to various campus facilities\n\nID Card Collection:\n- ID cards are typically issued during the first week of orientation\n- You'll be notified about the collection schedule\n- Bring your CNIC for verification when collecting your ID\n- The ID card is free of cost for new students\n\nImportant Notes:\n- Keep your student ID with you at all times on campus\n- Report lost or damaged ID cards immediately to the administration\n- Replacement ID cards may incur a fee\n- Your ID number will be your unique identifier throughout your time at GIKI\n\nDocument Safety:\n- Keep all original documents in a safe, waterproof folder\n- Make multiple photocopies of important documents\n- Store digital copies on your phone or cloud storage\n- Never lend your original documents to anyone\n- Consider getting a small lockbox for your room", faqs: [{ question: "What if I don't have my CNIC yet?", answer: "If you don't have a CNIC, you can use your B-Form as an alternative. However, it's recommended to get your CNIC as soon as possible as it's required for many official processes." }, { question: "Can I get my ID card before orientation?", answer: "No, ID cards are typically issued during orientation week. The administration needs to verify all documents and complete the registration process first." }, { question: "What should I do if I lose my student ID?", answer: "Immediately report the loss to the administration office. You'll need to fill out a form and pay a replacement fee. The process usually takes 3-5 working days." }, { question: "Do I need to bring original documents or copies?", answer: "You need to bring both original documents for verification and photocopies for submission. The administration will verify the originals and keep the copies for their records." }], warnings: ["Never share your student ID number or card with others. It's your personal identifier and should be kept secure.", "Make sure all your documents are properly attested and notarized before coming to campus.", "Keep your documents organized in a folder to avoid misplacing them during the registration process."] },
            { id: "what-to-pack", tag: "Ready, Set, Pack!", shortDescription: "Get your personalized packing list with all essentials.", fullContent: "Packing for university can be overwhelming, but we've got you covered! Use our interactive tool below to get a complete packing list tailored to your specific needs and lifestyle. The list will include both personalized recommendations based on your situation and all the essential items every GIKI student needs.", faqs: [{ question: "Can I bring an electric kettle?", answer: "Yes, electric kettles are generally allowed in the hostels, but check with your hostel warden for any specific restrictions." }, { question: "Should I bring a locker?", answer: "You will be provided with a cupboard for your belongings. A padlock is highly recommended for security." }], warnings: ["Avoid overpacking unnecessary items. Space is limited in the dorm rooms."] },
            { id: "campus-map", tag: "Campus Map", shortDescription: "Explore hostels, departments, and key spots on campus.", fullContent: "Use the campus map to locate hostels, academic blocks, the library, auditorium, sports complex, and eateries. This helps you plan routes and get familiar with GIKI before classes start.", faqs: [], warnings: [] },
            { id: "finances", tag: "Finances", shortDescription: "Managing your money on campus and a guide to expenses.", fullContent: `Managing your finances is an essential part of university life. GIKI's fee structure includes tuition and hostel charges, which are managed through the GIKI portal. Beyond fees, you will have to manage your daily expenses for food, transportation, and recreation.\n\nFee Payment and GIKI Portal:\n\nAll fee details and payment deadlines are available on your official GIKI portal. You will receive an official email from the administration with a step-by-step guide on how to pay your fees. Remember to check the portal regularly to avoid missing any deadlines.\n\nLiving Expenses:\n\nYour primary expenses will include mess charges (if you opt-in), transportation, and tuck shop purchases. The mess charges are billed semester-wise, and you will be notified of the cost beforehand. Carpooling with friends and using the GIKI shuttle service are great ways to save money on travel.\n\nBudgeting Tips:\n\n- Track your spending. You can use a notebook or a budgeting app to keep a record of all your expenses.\n- Differentiate between wants and needs. Prioritize your needs and try to minimize spending on non-essential items.\n- Take advantage of campus facilities. Instead of spending on food outside, utilize the mess and other affordable eateries on campus.`, faqs: [{ question: "How do I pay my fees?", answer: "Fee payments are made through specific bank challan forms provided by the GIKI administration and can be accessed via the GIKI portal. You'll receive an email with instructions at the start of each semester." }, { question: "What are the typical monthly expenses?", answer: "Aside from tuition and hostel fees, a typical month's expenses can vary widely. It generally includes mess charges, tuck shop food, and shuttle services, which can range from Rs. 5,000 to Rs. 15,000 depending on your lifestyle." }], warnings: ["Avoid overspending in your first few months. It's easy to get carried away, but a consistent budget is crucial for a stress-free semester."] },
            { id: "dorm-room-info", tag: "Dorm & Room Info", shortDescription: "Everything you need to know about your new room.", fullContent: "Rooms are allotted by the administration during your orientation week. You will be assigned a roommate and a dorm. Each room comes with basic furniture including a bed, a study table, and a cupboard. Hostel culture is a big part of GIKI life, and respecting your roommate and neighbors is key to a great experience.", faqs: [{ question: "Can I change my room or roommate?", answer: "Room and roommate changes are subject to approval from the hostel administration and are typically only considered in special circumstances." }, { question: "What is the hostel mess like?", answer: "Each hostel has its own mess, providing a convenient and communal dining experience." }], warnings: ["Respect your roommate's personal space and belongings. Communication is key to a healthy living environment."] },
            { id: "weekend-travel", tag: "Weekend Travel", shortDescription: "How to go home and travel from GIKI.", fullContent: `GIKI is located a bit away from major cities, so planning your weekend travel is important. There are GIKI-sponsored buses that run to Rawalpindi/Islamabad, Peshawar, and Abbottabad every Friday and return on Sunday. You can also find ride-sharing options with seniors or other students via hostel or batch group chats — a common and convenient carpooling system.\n\nAll those who wish to avail the shuttle service should note the following:\n\nTicket Booking: Tickets become available every Thursday at the transport office located behind the laundry shop.\nPayment: Only cash is accepted.\nRs. 350 for Islamabad, Rawalpindi, and Peshawar\nRs. 400 for Abbottabad\nTip: Get in line early — the queue can get long and seats are limited!\n\nShuttle Schedule (Every Friday, 4:00 PM Departure from GIKI)\nTo Rawalpindi/Islamabad\n\nDeparture Point: GH / Hostel-9\nArrival Point: Road Master Adda / G-9/4, Peshawar Morr\nTo Peshawar\n\nDeparture Point: GH / Hostel-9\nArrival Point: Bagh-e-Naran, Hayatabad\nTo Abbottabad\n\nDeparture Point: GH / Hostel-9\nArrival Point: GO Petroleum Filling Station`, faqs: [{ question: "Can I book shuttle tickets online?", answer: "No, shuttle tickets are only available in person at the transport office behind the laundry shop. Make sure to bring cash as digital payments are not accepted." }, { question: "What happens if I miss the shuttle?", answer: "If you miss the shuttle, your best bet is to arrange a ride-share with other students. Many carpools are coordinated through hostel WhatsApp groups or batch chats, especially on weekends." }, { question: "Are there any travel restrictions for hostel students?", answer: "Yes. All students must inform their warden and sign the departure register before leaving campus. For female students, it's mandatory to get a gate pass signed by their warden before exiting GIKI premises." }], warnings: ["Always travel in groups, especially at night, and avoid unofficial transport services."] },
            { id: "mess-and-food", tag: "Mess & Food", shortDescription: "Everything you need to know about food on campus.", fullContent: `GIKI has a central mess system that caters to all students. Additionally, there are several other tuck shops and cafes on campus for when you want a change of pace.\n\nStudent Mess Halls\nThere are designated mess halls for each hostel. The food is served at specific times, and the menu is a mix of Pakistani cuisines, rotating on a weekly basis.\n- Breakfast: 7:00 AM - 9:00 AM\n- Lunch: 12:30 PM - 2:30 PM\n- Dinner: 7:30 PM - 9:30 PM\n\nOther Eateries on Campus\nFor snacks, late-night cravings, or just a different taste, you can explore:\n- Hot and Spicy: Located at TUC. By far the best fast food you can find in GIKI.\n- Ayan and Raju for Desi: Also located at TUC. These restaurants offer a wide variety of Pakistani cuisine and fast food, but they lack the feel (the hygiene and taste).\n- GIKI Cafe: Owned and run by GIKI admin. It's located under the auditorium (yes, that circular building you see almost everywhere). It's somewhat similar to the mess in terms of taste and hygiene. It's good for tea and some light snacks like nuggets, samosas, or rolls. You can also come for dinner here—it's cheaper than the mess, so if you want to save, Cafe is the cheapest option you've got :)`, faqs: [{ question: "Can I bring my own food to the mess?", answer: "No, outside food is not permitted in the mess hall." }, { question: "Are there vegetarian options?", answer: "The mess menu usually includes vegetarian dishes, but you can always request a special meal if needed." }, { question: "Can I opt out of the mess?", answer: "Yes, you can opt-out of the mess on a daily basis (before 2 PM) if you prefer, but it's generally a convenient option." }], warnings: ["Do not forget to 'mess in' or 'mess out' on time to avoid being charged for meals you won't eat."] },
            { id: "societies-events", tag: "Societies & Events", shortDescription: "A peek into GIKI's vibrant student life.", fullContent: societiesData, faqs: [{ question: "How can I join a society?", answer: "Most societies have a recruitment drive or 'society fair' at the beginning of the semester where you can sign up." }, { question: "What is Orientation Week?", answer: "A week-long event filled with introductory sessions, tours, and fun activities to help you settle into GIKI life." }], warnings: ["Avoid getting overly involved in too many societies in your first year. It's easy to get overwhelmed."] },
            { id: "survival-tips", tag: "Survival Tips", shortDescription: "In-depth advice on academics, homesickness, and essential apps.", fullContent: `Managing your first year at GIKI can be challenging but also incredibly rewarding. Learn to balance fun and academics from the start. Don't be afraid to ask seniors for help; they have been through it all.\n\nAcademics and Stress Management\nGIKI's academic environment is demanding. Stay on top of your coursework from the beginning, attend all classes and labs, and form study groups with your peers. Time management is a key skill to develop. Take breaks, go for a walk, or participate in a sports activity to relieve stress.\n\nDealing with Homesickness\nHomesickness is a normal feeling for many freshmen. Getting involved in societies, sports, or other campus activities can help you feel more at home. Regular video calls with family and friends can also help. Don't be afraid to talk to your Resident Advisor (RA) or a senior student about how you feel.\n\nEssential Apps for a GIKI Student\n- GIKI Portal App: Official app for checking grades, attendance, and fee details.\n- Microsoft Teams: Used for online classes and communication with faculty and classmates.\n- WhatsApp: Primary platform for hostel and class group chats.\n- Google Drive/Docs: Essential for collaborative projects and saving notes.`, faqs: [], warnings: ["Don't isolate yourself in your room. Step out, meet people, and explore the campus to make the most of your time here."] },
            { id: "library", tag: "Library", shortDescription: "All you need to know about GIKI's library.", fullContent: `GIKI's main library is the intellectual heart of the campus, offering a wide range of academic resources to support your studies and research. The library houses an extensive collection of books, journals, and digital databases. It's also an excellent place for quiet study and group work.\n\nServices & Resources\n- Book borrowing: Students can borrow books for a specified period.\n- Digital resources: Access to online journals, e-books, and research databases.\n- Study spaces: Designated quiet zones for individual study and collaborative spaces for group projects.\n- Printing & scanning: Facilities are available for printing, scanning, and photocopying documents.\n\nOpening Hours\n- Monday to Friday: 9:00 AM to 10:00 PM\n- Saturday: 9:00 AM to 5:00 PM\n- Sunday: Closed`, faqs: [{ question: "How do I get a library card?", answer: "Your student ID card doubles as your library card. You just need to register it at the library front desk." }, { question: "Is there a fine for late returns?", answer: "Yes, fines are charged for books returned past their due date. Check with the library staff for the current fee structure." }], warnings: ["Keep your phone on silent mode inside the library's quiet zones.", "Do not bring food or drinks into the library's reading areas."] },
            { id: "facilities", tag: "Facilities", shortDescription: "A brief overview of campus facilities and services.", fullContent: `GIKI offers a range of modern facilities to support a well-rounded student experience. The campus is home to a dedicated sports complex with indoor and outdoor courts for various sports like badminton, squash, and basketball. Academic life is supported by state-of-the-art computer labs, specialized departmental labs, and a fully-equipped main library.\n\nFor your health and well-being, the campus has a health center with on-call doctors and nurses for medical emergencies and consultations. The main auditorium hosts a variety of academic and social events throughout the year. Additionally, the Student Activity Centre (SAC) serves as a hub for student societies and extracurricular activities.`, faqs: [{ question: "Are the computer labs open 24/7?", answer: "Most computer labs are open until late at night, and some are accessible 24/7, especially during exam periods." }, { question: "Can I use the sports facilities at any time?", answer: "The sports complex has specific hours of operation. Check the schedule posted at the complex for details." }], warnings: ["Always follow the rules and regulations of each facility to ensure a safe and pleasant environment for everyone."] }
        ];

        // Helper function to update a doc in Firestore
        const updateGuideSection = async (db, sectionId, newData) => {
            try {
                const docRef = firebase.firestore().collection('artifacts').doc(appId).collection('public').doc('data').collection('freshmanGuide').doc(sectionId);
                await docRef.set(newData, { merge: true });
                console.log("Document successfully updated!");
            } catch (e) {
                console.error("Error updating document: ", e);
            }
        };

        // Firestore helpers for cross-device packing list persistence (per-user)
        const userPackingDoc = (uid) => {
            if (!uid) {
                console.warn('No user ID provided to userPackingDoc');
                return null;
            }
            return firebase.firestore().collection('users').doc(uid).collection('packing').doc('list');
        };

        const savePackingList = async (userId, packingListData) => {
            try {
                const docRef = userPackingDoc(userId);
                if (!docRef) {
                    console.warn('Cannot save packing list - no valid document reference');
                    return false;
                }
                const dataToSave = { ...packingListData, lastUpdated: new Date().toISOString() };
                await docRef.set(dataToSave, { merge: true });
                console.log("Packing list saved successfully to Firestore!");
                return true;
            } catch (e) {
                console.error("Error saving packing list to Firestore: ", e);
                return false;
            }
        };

        const loadPackingList = async (userId) => {
            try {
                const docRef = userPackingDoc(userId);
                if (!docRef) {
                    console.warn('Cannot load packing list - no valid document reference');
                    return null;
                }
                const snapshot = await docRef.get();
                if (snapshot.exists) {
                    return snapshot.data();
                }
                return null;
            } catch (e) {
                console.error("Error loading packing list from Firestore: ", e);
                // If it's a permissions error, log it but don't show to user
                if (e.code === 'permission-denied') {
                    console.warn("Packing list permissions issue - user may need to be authenticated");
                }
                return null;
            }
        };

        const updateCheckedItems = async (userId, checkedItems) => {
            try {
                const docRef = userPackingDoc(userId);
                if (!docRef) {
                    console.warn('Cannot update checked items - no valid document reference');
                    return false;
                }
                await docRef.set({ checkedItems, lastUpdated: new Date().toISOString() }, { merge: true });
                console.log("Checked items updated successfully in Firestore!");
                return true;
            } catch (e) {
                console.error("Error updating checked items in Firestore: ", e);
                // If it's a permissions error, log it but don't show to user
                if (e.code === 'permission-denied') {
                    console.warn("Packing list permissions issue - user may need to be authenticated");
                }
                return false;
            }
        };

        const deletePackingList = async (userId) => {
            try {
                const docRef = userPackingDoc(userId);
                if (!docRef) {
                    console.warn('Cannot delete packing list - no valid document reference');
                    return false;
                }
                await docRef.delete();
                console.log("Packing list deleted successfully from Firestore!");
                return true;
            } catch (e) {
                console.error("Error deleting packing list from Firestore: ", e);
                return false;
            }
        };



        const Divider = () => (
            <div className="flex items-center my-8">
                <div className="flex-grow h-px bg-gray-300"></div>
                <div className="mx-4 h-3 w-3 bg-gray-400 rounded-full"></div>
                <div className="flex-grow h-px bg-gray-300"></div>
            </div>
        );

        const App = () => {
            const [db, setDb] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [guideSections, setGuideSections] = useState([]);
            const [expandedSection, setExpandedSection] = useState(null);
            const [editingSection, setEditingSection] = useState(null);
            const [editForm, setEditForm] = useState({ tag: '', shortDescription: '', fullContent: '', faqs: [], warnings: [] });
            const [selectedSocietySubTag, setSelectedSocietySubTag] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [personalizedInput, setPersonalizedInput] = useState('');
            const [personalizedList, setPersonalizedList] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);
            const [generationError, setGenerationError] = useState(null);
            const [savedPackingList, setSavedPackingList] = useState(null);
            const [checkedItems, setCheckedItems] = useState({});
            const [customItemsRevision, setCustomItemsRevision] = useState(0);
            const [openSections, setOpenSections] = useState({ clothing: true, bedding: false, academics: false, misc: false, custom: false });
            const packingUnsubRef = useRef(null);
            const [unsavedChanges, setUnsavedChanges] = useState(false);
            const [hasSessionChanges, setHasSessionChanges] = useState(false);
            const [showExitModal, setShowExitModal] = useState(false);
            const [pendingHref, setPendingHref] = useState(null);
            const [selectedHostel, setSelectedHostel] = useState(null);
            const [currentMediaIndex, setCurrentMediaIndex] = useState(0);
            const [isSaving, setIsSaving] = useState(false);

            // Gallery helper functions
            const currentMedia = selectedHostel && dormMediaConfig[selectedHostel + 'Hostel'].media[currentMediaIndex];
            
            const nextMedia = () => {
                if (selectedHostel && currentMediaIndex < dormMediaConfig[selectedHostel + 'Hostel'].media.length - 1) {
                    setCurrentMediaIndex(currentMediaIndex + 1);
                }
            };
            
            const previousMedia = () => {
                if (selectedHostel && currentMediaIndex > 0) {
                    setCurrentMediaIndex(currentMediaIndex - 1);
                }
            };
            const [showGuestSavePrompt, setShowGuestSavePrompt] = useState(false);

            const buildItemId = (categoryKey, itemLabel) => `${categoryKey}-${slugify(itemLabel)}`;

            const persistChecked = async (newChecked) => {
                setCheckedItems(newChecked);
                setUnsavedChanges(true);
                setHasSessionChanges(true);
                if (currentUser) {
                    // Defer saving until explicit prompt on exit, but also auto-save in background occasionally
                    try {
                        await updateCheckedItems(currentUser.uid, newChecked);
                        // keep unsaved flag so we can still prompt on exit
                    } catch (e) {
                        // Keep unsavedChanges true so user can be prompted
                        console.warn('Deferred save failed; will prompt on exit.', e);
                    }
                } else {
                    try {
                        localStorage.setItem('packing_progress_guest', JSON.stringify(newChecked));
                        // Show prompt encouraging login for cross-device save
                        setShowGuestSavePrompt(true);
                    } catch (e) {
                        console.error('Failed to save guest packing progress:', e);
                    }
                }
            };

            // Expose packing progress status and a save method globally for logout handlers
            useEffect(() => {
                try {
                    window.packingProgress = {
                        hasUnsaved: Boolean(currentUser && hasSessionChanges),
                        save: async () => {
                            if (!currentUser) return;
                            await updateCheckedItems(currentUser.uid, checkedItems);
                        }
                    };
                } catch (e) {
                    console.warn('Unable to expose packingProgress globally:', e);
                }
            }, [currentUser, hasSessionChanges, checkedItems]);

            const handleSelectAllIn = async (categoryKey, items) => {
                const updated = { ...checkedItems };
                items.forEach((item) => {
                    updated[buildItemId(categoryKey, item)] = true;
                });
                await persistChecked(updated);
            };

            const handleClearIn = async (categoryKey, items) => {
                const updated = { ...checkedItems };
                items.forEach((item) => {
                    updated[buildItemId(categoryKey, item)] = false;
                });
                await persistChecked(updated);
            };

            const handleDeleteCustomItem = async (itemLabel) => {
                try {
                    const storageKey = currentUser ? `user_custom_items_${currentUser.uid}` : 'user_custom_items_guest';
                    const raw = localStorage.getItem(storageKey);
                    const list = raw ? JSON.parse(raw) : [];
                    const normalized = normalizeItem(itemLabel);
                    const newList = (Array.isArray(list) ? list : []).filter(i => normalizeItem(i) !== normalized);
                    localStorage.setItem(storageKey, JSON.stringify(newList));

                    const customId = `custom-${slugify(itemLabel)}`;
                    const updatedChecked = { ...checkedItems };
                    if (customId in updatedChecked) {
                        delete updatedChecked[customId];
                        await persistChecked(updatedChecked);
                    }

                    setCustomItemsRevision(v => v + 1);
                } catch (e) {
                    console.error('Failed to delete custom item:', e);
                }
            };
            const [isLoadingSavedList, setIsLoadingSavedList] = useState(false);
            const [firebaseConnectionStatus, setFirebaseConnectionStatus] = useState('connecting');

            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        // Check if Firebase is available
                        if (typeof firebase === 'undefined') {
                            console.warn('Firebase not loaded, using offline mode');
                            setFirebaseConnectionStatus('error');
                            setGuideSections(guidePlaceholderData.map(s => s.id === "what-to-pack" ? { ...s, tag: "Ready, Set, Pack!" } : s));
                            setIsAuthReady(true);
                            return;
                        }

                        // Use the global Firebase instance from firebase-init.js
                        const firestore = firebase.firestore();
                        const auth = firebase.auth();
                        setDb(firestore);

                        // Listen for auth state changes
                        auth.onAuthStateChanged(async (user) => {
                            console.log("Guide: Auth state changed, user:", user);
                            setCurrentUser(user);

                            if (user) {
                                // Check if user is admin
                                try {
                                    if (typeof checkUserAdminStatus === 'function') {
                                        const adminStatus = await checkUserAdminStatus();
                                        console.log("Guide: Admin status check result:", adminStatus);
                                        setIsAdmin(adminStatus);
                                    } else {
                                        console.log("Guide: checkUserAdminStatus function not available");
                                        setIsAdmin(false);
                                    }
                                } catch (error) {
                                    console.warn("Guide: Error checking admin status:", error);
                                    setIsAdmin(false);
                                }

                                // Migrate any guest progress to Firestore and subscribe for real-time sync
                                try {
                                    setIsLoadingSavedList(true);
                                    // Load any guest progress and merge with existing Firestore data
                                    let guestChecked = {};
                                    try {
                                        const guestRaw = localStorage.getItem('packing_progress_guest');
                                        guestChecked = guestRaw ? JSON.parse(guestRaw) : {};
                                    } catch { }

                                    const existing = await loadPackingList(user.uid);
                                    if (existing && existing.checkedItems) {
                                        const merged = { ...existing.checkedItems, ...guestChecked };
                                        await updateCheckedItems(user.uid, merged);
                                        try { localStorage.removeItem('packing_progress_guest'); } catch { }
                                        setSavedPackingList({ ...existing, checkedItems: merged });
                                        setCheckedItems(merged);
                                    } else if (guestChecked && Object.keys(guestChecked).length > 0) {
                                        await updateCheckedItems(user.uid, guestChecked);
                                        try { localStorage.removeItem('packing_progress_guest'); } catch { }
                                        setSavedPackingList({ checkedItems: guestChecked, lastUpdated: new Date().toISOString() });
                                        setCheckedItems(guestChecked);
                                    }

                                    if (packingUnsubRef.current) {
                                        packingUnsubRef.current();
                                        packingUnsubRef.current = null;
                                    }
                                    const packingDocRef = userPackingDoc(user.uid);
                                    if (packingDocRef) {
                                        packingUnsubRef.current = packingDocRef.onSnapshot(
                                            (snapshot) => {
                                                const data = snapshot.exists ? snapshot.data() : {};
                                                setSavedPackingList(data || null);
                                                setCheckedItems(data?.checkedItems || {});
                                                setIsLoadingSavedList(false);
                                            },
                                            (err) => {
                                                console.error('Packing list listener error:', err);
                                                // If it's a permissions error, log it but don't show to user
                                                if (err.code === 'permission-denied') {
                                                    console.warn("Packing list permissions issue - user may need to be authenticated");
                                                }
                                                setIsLoadingSavedList(false);
                                            }
                                        );
                                    } else {
                                        console.warn('Cannot set up packing list listener - no valid document reference');
                                        setIsLoadingSavedList(false);
                                    }
                                } catch (error) {
                                    console.error("Error subscribing/migrating packing list:", error);
                                    setIsLoadingSavedList(false);
                                }
                            } else {
                                setIsAdmin(false);
                                // Clear saved packing list when user logs out
                                setSavedPackingList(null);
                                if (packingUnsubRef.current) {
                                    packingUnsubRef.current();
                                    packingUnsubRef.current = null;
                                }
                                // Load guest progress from localStorage if available
                                try {
                                    const guestProgressRaw = localStorage.getItem('packing_progress_guest');
                                    if (guestProgressRaw) {
                                        setCheckedItems(JSON.parse(guestProgressRaw));
                                    } else {
                                        setCheckedItems({});
                                    }
                                } catch (e) {
                                    console.warn('Failed to load guest packing progress:', e);
                                    setCheckedItems({});
                                }
                            }

                            setIsAuthReady(true);
                        });

                        // Set up Firestore listener for guide data with error handling
                        const setupFirestoreListener = () => {
                            try {
                                // Check if Firestore is available
                                if (!firestore || !firestore.collection) {
                                    console.warn('Firestore not available, using offline mode');
                                    setFirebaseConnectionStatus('error');
                                    setGuideSections(guidePlaceholderData.map(s => s.id === "what-to-pack" ? { ...s, tag: "Ready, Set, Pack!" } : s));
                                    return () => { };
                                }

                                const freshmanGuideRef = firestore.collection('artifacts').doc(appId).collection('public').doc('data').collection('freshmanGuide');

                                // Add timeout for Firestore connection
                                const timeoutId = setTimeout(() => {
                                    console.warn('Firestore connection timeout, using offline mode');
                                    setFirebaseConnectionStatus('error');
                                    setGuideSections(guidePlaceholderData.map(s => s.id === "what-to-pack" ? { ...s, tag: "Ready, Set, Pack!" } : s));
                                }, 10000); // 10 second timeout

                                const unsubscribe = freshmanGuideRef.onSnapshot(
                                    async (querySnapshot) => {
                                        clearTimeout(timeoutId); // Clear timeout on successful connection
                                        try {
                                            setFirebaseConnectionStatus('connected');
                                            if (querySnapshot.empty) {
                                                // If collection is empty, add all placeholder data
                                                const promises = guidePlaceholderData.map(async (data) => {
                                                    const docRef = freshmanGuideRef.doc(data.id);
                                                    await docRef.set(data);
                                                    return data;
                                                });
                                                Promise.all(promises).then(data => setGuideSections(data));
                                            } else {
                                                // If collection has data, check for missing sections and add them
                                                const fetchedData = [];
                                                querySnapshot.forEach(doc => fetchedData.push({ id: doc.id, ...doc.data() }));

                                                // Check which sections from guidePlaceholderData are missing
                                                const existingIds = fetchedData.map(section => section.id);
                                                const missingSections = guidePlaceholderData.filter(section => !existingIds.includes(section.id));

                                                if (missingSections.length > 0) {
                                                    console.log("Adding missing sections:", missingSections.map(s => s.id));
                                                    const promises = missingSections.map(async (data) => {
                                                        const docRef = freshmanGuideRef.doc(data.id);
                                                        await docRef.set(data);
                                                        return data;
                                                    });
                                                    await Promise.all(promises);
                                                    // The onSnapshot will trigger again with the updated data
                                                } else {
                                                    setGuideSections(fetchedData.map(s => s.id === "what-to-pack" ? { ...s, tag: "Ready, Set, Pack!" } : s));
                                                }
                                            }
                                        } catch (error) {
                                            console.warn("Error in Firestore snapshot handler:", error);
                                            setFirebaseConnectionStatus('error');
                                            // Fallback to placeholder data if Firestore fails
                                            setGuideSections(guidePlaceholderData.map(s => s.id === "what-to-pack" ? { ...s, tag: "Ready, Set, Pack!" } : s));
                                        }
                                    },
                                    (error) => {
                                        console.warn("Firestore listener error:", error);

                                        // Handle specific network errors more gracefully
                                        if (error.code === 'unavailable' || error.code === 'deadline-exceeded' ||
                                            error.message.includes('QUIC') || error.message.includes('network')) {
                                            console.warn("Network connectivity issue detected, using offline mode");
                                            setFirebaseConnectionStatus('error');
                                            setGuideSections(guidePlaceholderData.map(s => s.id === "what-to-pack" ? { ...s, tag: "Ready, Set, Pack!" } : s));
                                        } else {
                                            // For other errors, use offline mode
                                            console.warn("Firestore error, using offline mode:", error);
                                            setFirebaseConnectionStatus('error');
                                            setGuideSections(guidePlaceholderData.map(s => s.id === "what-to-pack" ? { ...s, tag: "Ready, Set, Pack!" } : s));
                                        }
                                    }
                                );

                                return unsubscribe;
                            } catch (error) {
                                console.warn("Error setting up Firestore listener:", error);
                                // Fallback to placeholder data if setup fails
                                setGuideSections(guidePlaceholderData.map(s => s.id === "what-to-pack" ? { ...s, tag: "Ready, Set, Pack!" } : s));
                                return () => { }; // Return empty cleanup function
                            }
                        };

                        // Initialize Firestore listener with retry logic
                        let unsubscribe = setupFirestoreListener();

                        // Retry mechanism for connection issues
                        const retryConnection = () => {
                            console.log("Retrying Firestore connection...");
                            if (unsubscribe) {
                                unsubscribe();
                            }
                            unsubscribe = setupFirestoreListener();
                        };

                        // Set up periodic connection health check
                        const healthCheckInterval = setInterval(() => {
                            if (firestore && firestore.app) {
                                // Check if Firestore is still connected
                                try {
                                    // Test connection with a simple operation
                                    firestore.enableNetwork();
                                } catch (error) {
                                    console.warn("Firestore connection issue detected during health check:", error);
                                    setFirebaseConnectionStatus('error');
                                }
                            }
                        }, 30000); // Check every 30 seconds

                        return () => {
                            if (unsubscribe) {
                                unsubscribe();
                            }
                            if (healthCheckInterval) {
                                clearInterval(healthCheckInterval);
                            }
                        };
                    } catch (e) {
                        console.warn("Error initializing Firebase or fetching data: ", e);
                        // Fallback to placeholder data if Firebase fails completely
                        setGuideSections(guidePlaceholderData.map(s => s.id === "what-to-pack" ? { ...s, tag: "Ready, Set, Pack!" } : s));
                        setIsAuthReady(true);
                    }
                };
                initFirebase();
            }, []);

            // Prompt to save on exit for authenticated users with unsaved changes
            useEffect(() => {
                const beforeUnload = (e) => {
                    if (currentUser && hasSessionChanges) {
                        const message = 'You have unsaved packing progress. Save before exiting?';
                        e.preventDefault();
                        e.returnValue = message;
                        return message;
                    }
                };
                window.addEventListener('beforeunload', beforeUnload);
                return () => window.removeEventListener('beforeunload', beforeUnload);
            }, [currentUser, hasSessionChanges]);

            const handleConfirmSaveAndExit = async () => {
                if (!currentUser) return;
                try {
                    setIsSaving(true);
                    await updateCheckedItems(currentUser.uid, checkedItems);
                    setUnsavedChanges(false);
                    setHasSessionChanges(false);
                    if (pendingHref) {
                        const href = pendingHref;
                        setPendingHref(null);
                        window.location.href = href;
                    }
                } finally {
                    setIsSaving(false);
                }
            };

            // Intercept in-page navigations for styled confirmation when there are session changes
            useEffect(() => {
                const clickHandler = (e) => {
                    const anchor = e.target.closest && e.target.closest('a[data-nav]');
                    if (!anchor) return;
                    if (currentUser && hasSessionChanges) {
                        e.preventDefault();
                        setPendingHref(anchor.href);
                        setShowExitModal(true);
                    }
                };
                document.addEventListener('click', clickHandler);
                return () => document.removeEventListener('click', clickHandler);
            }, [currentUser, hasSessionChanges]);



            const handleTagClick = (sectionId) => {
                setExpandedSection(sectionId);
                setSelectedSocietySubTag(null);
                const element = document.getElementById(sectionId);
                if (element) {
                    const header = document.querySelector('header');
                    const headerHeight = header ? header.offsetHeight : 0;
                    const y = element.getBoundingClientRect().top + window.scrollY - headerHeight - 8;
                    window.scrollTo({ top: y, behavior: 'smooth' });
                }
            };

            const handleBackClick = () => {
                setExpandedSection(null);
                setSelectedSocietySubTag(null);
            };

            const handleEditClick = (sectionId) => {
                const currentData = guideSections.find(s => s.id === sectionId);
                if (currentData) {
                    setEditingSection(sectionId);
                    const content = typeof currentData.fullContent === 'string' ? currentData.fullContent : JSON.stringify(currentData.fullContent, null, 2);
                    setEditForm({
                        tag: currentData.tag,
                        shortDescription: currentData.shortDescription,
                        fullContent: content,
                        faqs: currentData.faqs || [],
                        warnings: currentData.warnings || [],
                    });
                }
            };

            const handleSaveEdit = async () => {
                if (!editingSection || !db) return;
                let updatedContent = editForm.fullContent;
                try {
                    if (editingSection === 'important-contacts' || editingSection === 'societies-events') {
                        updatedContent = JSON.parse(editForm.fullContent);
                    }
                } catch (e) {
                    console.error('Invalid JSON format for this section:', e);
                    return;
                }
                const newData = {
                    tag: editForm.tag,
                    shortDescription: editForm.shortDescription,
                    fullContent: updatedContent,
                    faqs: editForm.faqs,
                    warnings: editForm.warnings,
                };
                await updateGuideSection(db, editingSection, newData);
                setEditingSection(null);
            };

            const handleCloseModal = () => setEditingSection(null);
            const handleFormChange = (e) => {
                const { name, value } = e.target;
                setEditForm(prev => ({ ...prev, [name]: value }));
            };
            const handleFaqChange = (index, field, value) => {
                const newFaqs = [...editForm.faqs];
                newFaqs[index][field] = value;
                setEditForm(prev => ({ ...prev, faqs: newFaqs }));
            };
            const handleAddFaq = () => setEditForm(prev => ({ ...prev, faqs: [...prev.faqs, { question: '', answer: '' }] }));
            const handleRemoveFaq = (index) => setEditForm(prev => ({ ...prev, faqs: editForm.faqs.filter((_, i) => i !== index) }));
            const handleWarningChange = (index, value) => {
                const newWarnings = [...editForm.warnings];
                newWarnings[index] = value;
                setEditForm(prev => ({ ...prev, warnings: newWarnings }));
            };
            const handleAddWarning = () => setEditForm(prev => ({ ...prev, warnings: [...prev.warnings, ''] }));
            const handleRemoveWarning = (index) => setEditForm(prev => ({ ...prev, warnings: editForm.warnings.filter((_, i) => i !== index) }));

            const handleCheckboxChange = async (itemId, isChecked) => {
                if (!currentUser) {
                    setShowGuestSavePrompt(true);
                    if (typeof window.showToast === 'function') showToast('Please login to track and sync your packing progress across devices.', 'warning');
                    else alert('Please login to track and sync your packing progress across devices.');
                    return;
                }
                const newCheckedItems = { ...checkedItems, [itemId]: isChecked };
                await persistChecked(newCheckedItems);
            };

            const handleRegenerateList = () => {
                setPersonalizedList(null);
                setSavedPackingList(null);
                setCheckedItems({});
                setPersonalizedInput('');
            };

            const handleDeleteList = async () => {
                if (currentUser) {
                    const deleted = await deletePackingList(currentUser.uid);
                    if (deleted) {
                        setSavedPackingList(null);
                        setPersonalizedList(null);
                        setCheckedItems({});
                        setPersonalizedInput('');
                    }
                }
            };

            const societySubCategories = useMemo(() => {
                return guideSections.find(s => s.id === 'societies-events')?.fullContent;
            }, [guideSections]);

            return (
                <div className="min-h-screen font-inter text-gray-100 pt-20 p-2 sm:p-8">
                    <div className="max-w-5xl mx-auto bg-gradient-to-r from-[#0A1931] to-[#1A3D63] text-white p-4 sm:p-8 mb-4 sm:mb-8 rounded-xl shadow-lg text-center border border-[#B3CFE5]/30">
                        <h1 className="text-2xl sm:text-4xl font-bold font-lora handwriting-title">GIKI Freshman Guide</h1>
                        <p className="mt-2 text-base sm:text-lg text-[#B3CFE5]">Your ultimate resource for a smooth start at GIKI.</p>
                    </div>
                    <div className="max-w-5xl mx-auto chronicle-container p-3 sm:p-6 lg:p-10 rounded-xl sm:rounded-2xl shadow-xl">
                        {/* Connection Status Indicator */}
                        {firebaseConnectionStatus === 'connecting' && (
                            <div className="mb-4 p-3 bg-[#0A1931] border border-[#4A7FA7] rounded-lg">
                                <div className="flex items-center justify-center">
                                    <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-[#B3CFE5]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span className="text-[#B3CFE5] text-sm">Connecting...</span>
                                </div>
                            </div>
                        )}

                        {firebaseConnectionStatus === 'error' && (
                            <div className="mb-4 p-3 bg-[#1A3D63] border border-[#4A7FA7] rounded-lg">
                                <div className="flex items-center justify-center">
                                    <svg className="w-5 h-5 text-[#B3CFE5] mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                    </svg>
                                    <span className="text-[#B3CFE5] text-sm">Using offline mode - some features may be limited</span>
                                </div>
                            </div>
                        )}

                        <div className="text-center mb-6 sm:mb-10">
                            <h2 className="text-xl sm:text-2xl lg:text-3xl font-bold font-lora text-[#B3CFE5] handwriting-title">Welcome to GIKI!</h2>
                            <p className="mt-3 sm:mt-4 text-base sm:text-lg text-[#B3CFE5] max-w-2xl mx-auto px-2">
                                Welcome to your new home! This guide is designed to help you navigate your first few weeks here. We've compiled essential information, tips, and resources to make your transition as smooth as possible.
                            </p>
                        </div>
                        <main>
                            {expandedSection === null && (
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-4 sm:gap-6">
                                    {guideSections.length > 0 ? (
                                        guideSections.map(section => (
                                            <div key={section.id} className="p-4 sm:p-6 card-panel rounded-xl cursor-pointer transition-all duration-300 ease-in-out hover:shadow-xl hover:-translate-y-0.5" onClick={() => handleTagClick(section.id)} title={section.shortDescription}>
                                                <h3 className="text-lg sm:text-xl font-semibold font-lora text-[#1A3D63]">{section.tag}</h3>
                                                <p className="mt-2 text-sm text-[#0A1931]/80">{section.shortDescription}</p>
                                            </div>
                                        ))
                                    ) : (
                                        <div className="col-span-2 text-center text-gray-500"><p>Loading guide data or creating initial documents...</p></div>
                                    )}
                                </div>
                            )}
                            {guideSections.map(section => (
                                <div key={section.id}>
                                    {expandedSection === section.id && (
                                        <div id={section.id} className="mt-6 sm:mt-12 p-4 sm:p-8 guide-section-panel rounded-xl shadow-inner transition-all duration-500 ease-in-out">
                                            <div className="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-4 gap-3">
                                                <h2 className="text-2xl sm:text-3xl font-bold font-lora text-[#B3CFE5]">{section.tag}</h2>
                                                {isAdmin && (
                                                    <button onClick={() => handleEditClick(section.id)} className="bg-[#4A7FA7] text-white px-4 py-2 rounded-lg hover:bg-[#1A3D63] transition-colors shadow-md self-start">Edit</button>
                                                )}
                                            </div>
                                            {section.id === "societies-events" && societySubCategories ? (
                                                <div className="flex flex-col gap-4 sm:gap-6">
                                                    <nav className="flex flex-wrap gap-2 mb-4 sm:mb-6">
                                                        {Object.keys(societySubCategories).map((key) => (
                                                            <button key={key} onClick={() => setSelectedSocietySubTag(key)} className={`px-3 sm:px-6 py-2 rounded-full font-semibold transition-colors duration-200 text-sm sm:text-base ${selectedSocietySubTag === key ? 'bg-[#4A7FA7] text-white shadow-md' : 'text-[#B3CFE5] bg-[#1A3D63] hover:bg-[#4A7FA7]/30'}`}>
                                                                <span>{societySubCategories[key].title}</span>
                                                            </button>
                                                        ))}
                                                    </nav>
                                                    <div className="flex-grow">
                                                        {selectedSocietySubTag ? (
                                                            societySubCategories[selectedSocietySubTag]?.societies?.map((item, index) => (
                                                                <div key={index} className="p-3 sm:p-4 bg-[#0A1931] rounded-lg mb-3 sm:mb-4 shadow-sm border border-[#4A7FA7]/40">
                                                                    <h4 className="text-lg sm:text-xl font-semibold text-[#F6FAFD]">{item.name}</h4>
                                                                    <p className="mt-1 text-sm text-[#B3CFE5]">{item.description}</p>
                                                                </div>
                                                            ))
                                                        ) : (
                                                            <div className="text-center p-6 sm:p-8 text-[#B3CFE5] bg-[#0A1931] rounded-lg border border-[#4A7FA7]/40"><p className="text-base sm:text-lg">Please select a society category to view the details.</p></div>
                                                        )}
                                                    </div>
                                                </div>
                                            ) : (
                                                Array.isArray(section.fullContent) && section.id === "important-contacts" ? (
                                                    <div className="overflow-x-auto">
                                                        <table className="w-full text-left table-auto border-collapse text-sm sm:text-base">
                                                            <thead className="text-white bg-[#1A3D63]">
                                                                <tr>
                                                                    <th className="py-2 sm:py-3 px-2 sm:px-4 border-b border-[#4A7FA7]/40 font-semibold">Contact</th>
                                                                    <th className="py-2 sm:py-3 px-2 sm:px-4 border-b border-[#4A7FA7]/40 font-semibold">Department</th>
                                                                    <th className="py-2 sm:py-3 px-2 sm:px-4 border-b border-[#4A7FA7]/40 font-semibold">Purpose</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {section.fullContent.map((item, index) => (
                                                                    <tr key={index} className="border-b border-[#4A7FA7]/30 last:border-b-0">
                                                                        <td className="py-2 sm:py-3 px-2 sm:px-4 text-[#F6FAFD]">{item.contact}</td>
                                                                        <td className="py-2 sm:py-3 px-2 sm:px-4 text-[#B3CFE5]">{item.department}</td>
                                                                        <td className="py-2 sm:py-3 px-2 sm:px-4 text-[#B3CFE5]">{item.purpose}</td>
                                                                    </tr>
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                ) : (
                                                    section.fullContent && typeof section.fullContent === 'string' && section.fullContent.trim().startsWith('-') ? (
                                                        <ul className="mt-4 space-y-2 list-disc list-inside">
                                                            {section.fullContent.split('\n').filter(line => line.trim()).map((line, index) => {
                                                                const content = line.trim().startsWith('-') ? line.trim().substring(1).trim() : line;
                                                                return content && <li key={index} className="text-[#B3CFE5]">{content}</li>;
                                                            })}
                                                        </ul>
                                                    ) : (
                                                        <p className="mt-4 text-[#F6FAFD] leading-relaxed whitespace-pre-wrap">{section.fullContent}</p>
                                                    )
                                                )
                                            )}
                                            {section.id === "campus-map" && (
                                                <div className="mt-6 sm:mt-8 p-3 sm:p-4 bg-[#0A1931] rounded-xl border border-[#4A7FA7]/40">
                                                    <div className="text-center">
                                                        <div className="mb-4">
                                                            <svg className="w-16 h-16 text-[#B3CFE5] mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"></path>
                                                            </svg>
                                                            <h3 className="text-xl font-semibold text-[#B3CFE5] mb-2">Interactive Campus Map</h3>
                                                            <p className="text-[#B3CFE5] mb-6">Explore our enhanced interactive campus map with detailed information about all locations, buildings, and facilities.</p>
                                                        </div>
                                                        <a 
                                                            href="newmap.html" 
                                                            className="inline-flex items-center gap-2 bg-[#4A7FA7] hover:bg-[#1A3D63] text-white px-6 py-3 rounded-lg font-semibold transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg"
                                                        >
                                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                                            </svg>
                                                            Open Interactive Map
                                                        </a>
                                                        <p className="text-xs text-[#B3CFE5] mt-3">Features: Pin locations, detailed descriptions, touch support, and responsive design</p>
                                                    </div>
                                                </div>
                                            )}
                                            {section.id === "dorm-room-info" && (
                                                <div className="mt-6 sm:mt-8">
                                                    <h3 className="text-xl sm:text-2xl font-semibold font-lora text-[#B3CFE5] mb-4">Room Tours & Photos</h3>
                                                    <p className="text-sm text-[#B3CFE5] mb-6">Take a virtual tour of the hostel rooms and facilities to get a better idea of your new home.</p>
                                                    
                                                    {/* Media Gallery */}
                                                    <div className="space-y-6">
                                                        {/* Simple Dorm Room Gallery */}
                                                        <div className="mt-6">
                                                            <h5 className="text-md font-semibold text-gray-200 mb-4">Room Gallery</h5>
                                                            
                                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                                {/* Boys Hostel Square */}
                                                                <div 
                                                                    className="bg-[#4A7FA7] hover:bg-[#1A3D63] cursor-pointer rounded-lg p-6 text-center transition-colors duration-200"
                                                                    onClick={() => {
                                                                        setSelectedHostel('boys');
                                                                        setCurrentMediaIndex(0);
                                                                    }}
                                                                >
                                                                    <div className="text-white text-lg font-semibold mb-2">Boys Hostel</div>
                                                                    <div className="text-blue-100 text-sm">Click to view photos & videos</div>
                                                                </div>

                                                                {/* Girls Hostel Square */}
                                                                <div 
                                                                    className="bg-[#1A3D63] hover:bg-[#4A7FA7] cursor-pointer rounded-lg p-6 text-center transition-colors duration-200"
                                                                    onClick={() => {
                                                                        setSelectedHostel('girls');
                                                                        setCurrentMediaIndex(0);
                                                                    }}
                                                                >
                                                                    <div className="text-white text-lg font-semibold mb-2">Girls Hostel</div>
                                                                    <div className="text-pink-100 text-sm">Click to view photos & videos</div>
                                                                </div>
                                                            </div>

                                                            {/* Premium Media Viewer Modal */}
                                                            {selectedHostel && (
                                                                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                                                                    <div className="bg-gradient-to-br from-[#0A1931] via-[#1A3D63] to-[#4A7FA7] rounded-2xl max-w-5xl w-full max-h-[95vh] overflow-hidden shadow-2xl border border-[#B3CFE5]/30">
                                                                        {/* Premium Header */}
                                                                        <div className="flex justify-between items-center p-6 border-b border-[#B3CFE5]/30 bg-gradient-to-r from-[#0A1931]/50 to-[#1A3D63]/50">
                                                                            <div className="flex items-center space-x-3">
                                                                                <div className={`w-3 h-3 rounded-full ${selectedHostel === 'boys' ? 'bg-[#4A7FA7]' : 'bg-[#B3CFE5]'} shadow-lg`}></div>
                                                                                <h3 className="text-2xl font-bold text-white tracking-wide">
                                                                                    {selectedHostel === 'boys' ? 'Boys Hostel' : 'Girls Hostel'} Tour
                                                                                </h3>
                                                                            </div>
                                                                            <button 
                                                                                onClick={() => setSelectedHostel(null)}
                                                                                className="group relative w-10 h-10 rounded-full bg-[#0A1931]/50 hover:bg-[#4A7FA7]/20 flex items-center justify-center transition-all duration-300 border border-[#B3CFE5]/30 hover:border-[#B3CFE5]/60"
                                                                            >
                                                                                <svg className="w-5 h-5 text-[#B3CFE5] group-hover:text-white transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                                                                                </svg>
                                                                            </button>
                                                                        </div>
                                                                        
                                                                        <div className="relative">
                                                                            {/* Premium Media Display */}
                                                                            <div className="p-8">
                                                                                {currentMedia && (
                                                                                    <div className="text-center">
                                                                                        {currentMedia.type === 'image' ? (
                                                                                            <div className="relative inline-block">
                                                                                                <img 
                                                                                                    src={`dorm-media/photos/${currentMedia.filename}`}
                                                                                                    alt={currentMedia.title}
                                                                                                    className="max-w-full max-h-[70vh] object-contain mx-auto rounded-lg shadow-2xl"
                                                                                                    onError={(e) => {
                                                                                                        e.target.style.display = 'none';
                                                                                                        e.target.nextSibling.style.display = 'block';
                                                                                                    }}
                                                                                                />
                                                                                            </div>
                                                                                        ) : (
                                                                                                                                                                                                                      <div className="relative inline-block">
                                                                                                                              <video
                                                                                                                                  src={`dorm-media/videos/${currentMedia.filename}`}
                                                                                                                                  muted
                                                                                                                                  controls
                                                                                                                                  className="max-w-full max-h-[70vh] mx-auto rounded-lg shadow-lg"
                                                                                                                                  onError={(e) => {
                                                                                                                                      e.target.style.display = 'none';
                                                                                                                                      e.target.nextSibling.style.display = 'block';
                                                                                                                                  }}
                                                                                                                              />
                                                                                                                          </div>
                                                                                        )}
                                                                                        <div className="hidden p-6 bg-gradient-to-r from-[#0A1931] to-[#1A3D63] text-[#B3CFE5] rounded-lg mt-4 shadow-lg">
                                                                                            <svg className="w-8 h-8 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                                                                            </svg>
                                                                                            {currentMedia.type === 'image' ? 'Image' : 'Video'} not available
                                                                                        </div>
                                                                                        
                                                                                        {/* Premium Content Info */}
                                                                                        <div className="mt-8 max-w-2xl mx-auto">
                                                                                            <h4 className="text-2xl font-bold text-white mb-3 tracking-wide">{currentMedia.title}</h4>
                                                                                            <p className="text-[#B3CFE5] text-lg leading-relaxed">{currentMedia.description}</p>
                                                                                        </div>
                                                                                    </div>
                                                                                )}
                                                                            </div>

                                                                            {/* Premium Navigation Arrows */}
                                                                            {dormMediaConfig[selectedHostel + 'Hostel'].media.length > 1 && (
                                                                                <>
                                                                                    <button 
                                                                                        onClick={previousMedia}
                                                                                        className="absolute left-6 top-1/2 transform -translate-y-1/2 group"
                                                                                        disabled={currentMediaIndex === 0}
                                                                                    >
                                                                                        <div className="w-12 h-12 rounded-full bg-black/40 hover:bg-black/60 backdrop-blur-sm flex items-center justify-center transition-all duration-300 border border-[#B3CFE5]/30 hover:border-[#B3CFE5]/60 shadow-lg">
                                                                                            <svg className="w-6 h-6 text-[#B3CFE5] group-hover:scale-110 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7"></path>
                                                                                            </svg>
                                                                                        </div>
                                                                                    </button>
                                                                                    <button 
                                                                                        onClick={nextMedia}
                                                                                        className="absolute right-6 top-1/2 transform -translate-y-1/2 group"
                                                                                        disabled={currentMediaIndex === dormMediaConfig[selectedHostel + 'Hostel'].media.length - 1}
                                                                                    >
                                                                                        <div className="w-12 h-12 rounded-full bg-black/40 hover:bg-black/60 backdrop-blur-sm flex items-center justify-center transition-all duration-300 border border-[#B3CFE5]/30 hover:border-[#B3CFE5]/60 shadow-lg">
                                                                                            <svg className="w-6 h-6 text-[#B3CFE5] group-hover:scale-110 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7"></path>
                                                                                            </svg>
                                                                                        </div>
                                                                                    </button>
                                                                                </>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                            {section.id === "what-to-pack" && (
                                                <div className="mt-4">
                                                    <h3 className="text-xl sm:text-2xl font-semibold font-lora text-[#B3CFE5] mb-2">Your Essential Packing Checklist</h3>
                                                    <p className="text-sm text-[#B3CFE5] mb-4">Check items as you pack. Your progress is saved automatically{currentUser ? ' to your account' : ' on this device'}.</p>

                                                    {/* Loading saved list */}
                                                    {isLoadingSavedList && (
                                                        <div className="flex items-center justify-center py-4">
                                                            <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                            </svg>
                                                            <span className="text-gray-300 text-sm">Loading your saved packing list...</span>
                                                        </div>
                                                    )}

                                                    {/* Show consolidated checklist */}
                                                    {!isLoadingSavedList && (
                                                        <>
                                                            {/* Add custom item */}
                                                            <div className="mb-4">
                                                                <form
                                                                    onSubmit={(e) => {
                                                                        e.preventDefault();
                                                                        const formData = new FormData(e.currentTarget);
                                                                        const newItem = (formData.get('newItem') || '').toString().trim();
                                                                        if (!newItem) return;
                                                                        const storageKey = currentUser ? `user_custom_items_${currentUser.uid}` : 'user_custom_items_guest';
                                                                        try {
                                                                            const existingRaw = localStorage.getItem(storageKey);
                                                                            const existing = existingRaw ? JSON.parse(existingRaw) : [];
                                                                            if (!existing.includes(newItem)) {
                                                                                const updated = [...existing, newItem];
                                                                                localStorage.setItem(storageKey, JSON.stringify(updated));
                                                                            }
                                                                            e.currentTarget.reset();
                                                                            // trigger re-render AFTER storage is updated so totals refresh immediately
                                                                            setCustomItemsRevision(v => v + 1);
                                                                        } catch (err) {
                                                                            console.error('Failed to save custom item:', err);
                                                                        }
                                                                    }}
                                                                    className="flex flex-col sm:flex-row gap-2"
                                                                >
                                                                    <input
                                                                        name="newItem"
                                                                        type="text"
                                                                        placeholder="Add a custom item (saved only for you)"
                                                                        className="flex-grow p-2 border border-[#4A7FA7] rounded focus:outline-none focus:ring-1 focus:ring-[#4A7FA7] bg-[#0A1931] text-[#F6FAFD] text-sm"
                                                                    />
                                                                    <button type="submit" className="px-4 py-2 bg-[#4A7FA7] text-white rounded hover:bg-[#1A3D63] font-semibold text-sm">
                                                                        Add Item
                                                                    </button>
                                                                </form>
                                                            </div>
                                                            {(() => {
                                                                const deduped = getDedupedPackingData();
                                                                const baseSet = new Set([
                                                                    ...deduped.clothing,
                                                                    ...deduped.bedding,
                                                                    ...deduped.academics,
                                                                    ...deduped.misc,
                                                                ].map(normalizeItem));

                                                                const storageKey = currentUser ? `user_custom_items_${currentUser.uid}` : 'user_custom_items_guest';
                                                                let customRaw = [];
                                                                try {
                                                                    const raw = localStorage.getItem(storageKey);
                                                                    customRaw = raw ? JSON.parse(raw) : [];
                                                                    // force this block to re-run when items added
                                                                    void customItemsRevision;
                                                                } catch (e) {
                                                                    customRaw = [];
                                                                }
                                                                const seenCustom = new Set();
                                                                const customFiltered = (Array.isArray(customRaw) ? customRaw : []).filter((item) => {
                                                                    const n = normalizeItem(item);
                                                                    if (baseSet.has(n)) return false;
                                                                    if (seenCustom.has(n)) return false;
                                                                    seenCustom.add(n);
                                                                    return true;
                                                                });

                                                                const total = deduped.clothing.length + deduped.bedding.length + deduped.academics.length + deduped.misc.length + customFiltered.length;
                                                                const done = Object.values(checkedItems).filter(Boolean).length;

                                                                return (
                                                                    <>
                                                                        <div className="space-y-2">
                                                                            {[
                                                                                { key: 'clothing', title: 'Clothing & Personal Items', items: deduped.clothing },
                                                                                { key: 'bedding', title: 'Bedding & Room Essentials', items: deduped.bedding },
                                                                                { key: 'academics', title: 'Academics & Electronics', items: deduped.academics },
                                                                                { key: 'misc', title: 'Miscellaneous', items: deduped.misc },
                                                                            ].map((section) => {
                                                                                const checkedCount = section.items.filter((it) => checkedItems[buildItemId(section.key, it)]).length;
                                                                                return (
                                                                                    <div key={section.key} className="bg-[#0A1931] rounded overflow-hidden border border-[#4A7FA7]/30">
                                                                                        <div
                                                                                            className="w-full flex items-center justify-between px-3 py-2 hover:bg-[#1A3D63] cursor-pointer"
                                                                                            onClick={() => setOpenSections(prev => ({ ...prev, [section.key]: !prev[section.key] }))}
                                                                                        >
                                                                                            <div className="flex items-center gap-2">
                                                                                                <span className="font-semibold text-[#F6FAFD] text-sm">{section.title}</span>
                                                                                                <span className="text-xs px-1.5 py-0.5 rounded-full bg-[#4A7FA7]/30 text-[#B3CFE5]">{checkedCount}/{section.items.length}</span>
                                                                                            </div>
                                                                                            <div className="flex items-center gap-1">
                                                                                                <button
                                                                                                    type="button"
                                                                                                    onClick={(e) => { e.stopPropagation(); handleSelectAllIn(section.key, section.items); }}
                                                                                                    className="text-xs px-2 py-1 bg-[#4A7FA7] text-white rounded hover:bg-[#1A3D63]"
                                                                                                >
                                                                                                    All
                                                                                                </button>
                                                                                                <button
                                                                                                    type="button"
                                                                                                    onClick={(e) => { e.stopPropagation(); handleClearIn(section.key, section.items); }}
                                                                                                    className="text-xs px-2 py-1 bg-[#0A1931] text-[#B3CFE5] rounded hover:bg-[#1A3D63]"
                                                                                                >
                                                                                                    Clear
                                                                                                </button>
                                                                                                <svg className={`w-4 h-4 text-[#B3CFE5] transition-transform ${openSections[section.key] ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 9l6 6 6-6"></path></svg>
                                                                                            </div>
                                                                                        </div>
                                                                                        {openSections[section.key] && (
                                                                                            <div className="px-3 pb-2 pt-1">
                                                                                                <div className="space-y-1">
                                                                                                    {section.items.map((item) => {
                                                                                                        const itemId = buildItemId(section.key, item);
                                                                                                        return (
                                                                                                            <label key={itemId} className="flex items-start space-x-2 p-1 rounded hover:bg-[#1A3D63]/40 cursor-pointer">
                                                                                                                <input
                                                                                                                    type="checkbox"
                                                                                                                    checked={checkedItems[itemId] || false}
                                                                                                                    onChange={(e) => handleCheckboxChange(itemId, e.target.checked)}
                                                                                                                    className="mt-0.5 h-4 w-4 text-[#4A7FA7] focus:ring-[#4A7FA7] border-[#4A7FA7]/40 rounded"
                                                                                                                />
                                                                                                                <span className="text-[#B3CFE5] text-sm leading-5">{item}</span>
                                                                                                            </label>
                                                                                                        );
                                                                                                    })}
                                                                                                </div>
                                                                                            </div>
                                                                                        )}
                                                                                    </div>
                                                                                );
                                                                            })}
                                                                        </div>

                                                                        {/* User custom items */}
                                                                        {customFiltered.length > 0 && (
                                                                            <div className="mt-4 bg-[#0A1931] rounded overflow-hidden border border-[#4A7FA7]/30">
                                                                                <div
                                                                                    className="w-full flex items-center justify-between px-3 py-2 hover:bg-[#1A3D63] cursor-pointer"
                                                                                    onClick={() => setOpenSections(prev => ({ ...prev, custom: !prev.custom }))}
                                                                                >
                                                                                    <span className="font-semibold text-[#F6FAFD] text-sm">Your Added Items</span>
                                                                                    <svg className={`w-4 h-4 text-[#B3CFE5] transition-transform ${openSections.custom ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 9l6 6 6-6"></path></svg>
                                                                                </div>
                                                                                {openSections.custom && (
                                                                                    <div className="px-3 pb-2 pt-1">
                                                                                        <div className="space-y-1">
                                                                                            {customFiltered.map((item) => {
                                                                                                const id = `custom-${slugify(item)}`;
                                                                                                return (
                                                                                                    <div key={id} className="flex items-center justify-between p-1 rounded hover:bg-[#1A3D63]/40">
                                                                                                        <label className="flex items-start space-x-2 cursor-pointer">
                                                                                                            <input
                                                                                                                type="checkbox"
                                                                                                                checked={checkedItems[id] || false}
                                                                                                                onChange={(e) => handleCheckboxChange(id, e.target.checked)}
                                                                                                                className="mt-0.5 h-4 w-4 text-[#4A7FA7] focus:ring-[#4A7FA7] border-[#4A7FA7]/40 rounded"
                                                                                                            />
                                                                                                            <span className="text-[#B3CFE5] text-sm">{item}</span>
                                                                                                        </label>
                                                                                                        <button type="button" onClick={() => handleDeleteCustomItem(item)} className="text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">
                                                                                                            Delete
                                                                                                        </button>
                                                                                                    </div>
                                                                                                );
                                                                                            })}
                                                                                        </div>
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        )}

                                                                        {/* Progress indicator */}
                                                                        <div className="mt-4 p-3 bg-[#0A1931] rounded border border-[#4A7FA7]/30">
                                                                            <div className="flex justify-between items-center mb-2">
                                                                                <span className="text-sm font-medium text-[#B3CFE5]">Packing Progress</span>
                                                                                <span className="text-sm text-[#B3CFE5]">{`${done} / ${total} items`}</span>
                                                                            </div>
                                                                            <div className="w-full bg-[#1A3D63] rounded-full h-2">
                                                                                <div
                                                                                    className="bg-[#4A7FA7] h-2 rounded-full transition-all duration-300"
                                                                                    style={{ width: `${total === 0 ? 0 : (done / total) * 100}%` }}
                                                                                ></div>
                                                                            </div>
                                                                            {currentUser && hasSessionChanges && (
                                                                                <div className="mt-3 flex items-center justify-between">
                                                                                    <span className="text-xs text-[#B3CFE5]">You have unsaved changes.</span>
                                                                                    <button
                                                                                        onClick={handleConfirmSaveAndExit}
                                                                                        className="text-xs px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700"
                                                                                        disabled={isSaving}
                                                                                    >
                                                                                        {isSaving ? 'Saving…' : 'Save now'}
                                                                                    </button>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                        {total > 0 && done === total && (
                                                                            <div className="mt-4 p-3 bg-green-900/70 border border-green-600 rounded text-green-100">
                                                                                <div className="flex items-start">
                                                                                    <svg className="w-5 h-5 text-green-300 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                                                                    <div>
                                                                                        <h4 className="font-semibold text-sm">All set! 🎉</h4>
                                                                                        <p className="text-xs mt-1">You've checked everything on your list. Safe travels and welcome to GIKI!</p>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        )}
                                                                    </>
                                                                );
                                                            })()}
                                                        </>
                                                    )}
                                                    {/* Removed personalized generation UI; using static categories instead */}

                                                    {generationError && (
                                                        <div className="mt-4 p-3 bg-red-900 text-red-200 rounded border-l-4 border-red-500">
                                                            {generationError}
                                                        </div>
                                                    )}

                                                    {/* Login prompt for non-authenticated users */}
                                                    {!currentUser && (
                                                        <div className="mt-4 p-4 bg-gradient-to-r from-[#0A1931] to-[#1A3D63] border border-[#4A7FA7] rounded text-center relative">
                                                            <div className="mb-3">
                                                                <svg className="w-8 h-8 text-[#B3CFE5] mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                                                </svg>
                                                                <h4 className="text-base font-semibold text-[#B3CFE5] mb-1">Login Required</h4>
                                                                <p className="text-[#B3CFE5] text-xs mb-3">
                                                                    To save your packing list and track your progress across sessions, please login to your account.
                                                                </p>
                                                            </div>
                                                            <div className="flex flex-col sm:flex-row gap-2 justify-center">
                                                                <a href="login.html" className="px-4 py-2 bg-[#4A7FA7] text-white rounded hover:bg-[#1A3D63] transition-colors font-semibold text-sm">
                                                                    Login Now
                                                                </a>
                                                                <a href="signup.html" className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors font-semibold text-sm">
                                                                    Create Account
                                                                </a>
                                                            </div>
                                                            <p className="text-[#B3CFE5] text-xs mt-2">
                                                                💡 Your packing list will be automatically saved and you can continue where you left off!
                                                            </p>
                                                            {showGuestSavePrompt && (
                                                                <div className="mt-3 p-2 bg-[#0A1931] border border-[#4A7FA7]/40 rounded text-[#B3CFE5]">
                                                                    <span className="text-xs">Progress is saved only on this device. Login to sync across devices.</span>
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            <Divider />
                                            {section.faqs && section.faqs.length > 0 && (
                                                <div className="mt-8 p-6 rounded-xl bg-[#0A1931] border border-[#4A7FA7]/30">
                                                    <h3 className="text-2xl font-semibold font-lora text-[#B3CFE5] border-b-2 pb-2 mb-4 border-[#4A7FA7]/30">FAQs</h3>
                                                    <div className="space-y-4">
                                                        {section.faqs.map((faq, index) => (
                                                            <details key={index} className="group cursor-pointer p-4 rounded-lg bg-[#0A1931] border border-[#4A7FA7]/30 shadow-sm">
                                                                <summary className="flex justify-between items-center font-medium list-none">
                                                                    <span className="font-semibold text-[#F6FAFD]">{faq.question}</span>
                                                                    <span className="transition group-open:rotate-180"><svg fill="none" height="24" shapeRendering="geometricPrecision" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" viewBox="0 0 24 24" width="24"><path d="M6 9l6 6 6-6"></path></svg></span>
                                                                </summary>
                                                                <p className="text-[#B3CFE5] mt-2 ml-4">{faq.answer}</p>
                                                            </details>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                            {section.warnings && section.warnings.length > 0 && (
                                                <div className="mt-8">
                                                    <h3 className="text-2xl font-semibold font-lora text-[#B3CFE5] border-b-2 pb-2 mb-4 border-[#4A7FA7]/30">Helpful Reminders</h3>
                                                    <div className="space-y-4">
                                                        {section.warnings.map((warning, index) => (
                                                            <div key={index} className="flex items-start p-4 bg-[#0A1931] border-l-4 border-[#4A7FA7] text-[#B3CFE5] rounded-md">
                                                                <p>{warning}</p>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            ))}
                            {expandedSection !== null && (
                                <div className="text-center mt-6 sm:mt-12">
                                    <button onClick={handleBackClick} className="bg-[#4A7FA7] text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-bold hover:bg-[#1A3D63] transition-colors shadow-md">&larr; Back to all sections</button>
                                </div>
                            )}
                        </main>
                    </div>
                    {showExitModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60">
                            <div className="bg-gray-800 border border-gray-600 rounded-lg p-5 w-[90%] max-w-md shadow-xl">
                                <h4 className="text-lg font-semibold text-gray-100 mb-2">Save your progress?</h4>
                                <p className="text-sm text-gray-300 mb-4">You have changes in your packing list. Would you like to save before leaving?</p>
                                <div className="flex gap-2 justify-end">
                                    <button onClick={() => { setShowExitModal(false); setPendingHref(null); }} className="px-3 py-2 text-sm bg-gray-700 text-gray-200 rounded hover:bg-gray-600">Stay</button>
                                    <button onClick={async () => { await handleConfirmSaveAndExit(); setShowExitModal(false); }} className="px-3 py-2 text-sm bg-green-600 text-white rounded hover:bg-green-700" disabled={isSaving}>{isSaving ? 'Saving…' : 'Save & Leave'}</button>
                                    <button onClick={() => { const href = pendingHref; setShowExitModal(false); setPendingHref(null); window.location.href = href; }} className="px-3 py-2 text-sm bg-red-600 text-white rounded hover:bg-red-700">Leave without saving</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {editingSection && (
                        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                            <div className="bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full p-6 sm:p-8 max-h-[90vh] overflow-y-auto border border-gray-600">
                                <div className="flex justify-between items-center border-b border-gray-600 pb-4 mb-4">
                                    <h3 className="text-2xl font-lora font-bold text-blue-400">Edit {editForm.tag}</h3>
                                    <button onClick={handleCloseModal} className="text-gray-400 hover:text-gray-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                                </div>
                                <div className="space-y-6">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-300 mb-1">Tag</label>
                                        <input type="text" name="tag" value={editForm.tag} onChange={handleFormChange} className="w-full p-2 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-gray-100" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-300 mb-1">Short Description</label>
                                        <textarea name="shortDescription" value={editForm.shortDescription} onChange={handleFormChange} rows="2" className="w-full p-2 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-gray-100" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-300 mb-1">Full Content ({editingSection === 'important-contacts' || editingSection === 'societies-events' ? 'JSON formatted content' : 'Plain Text'})</label>
                                        <textarea name="fullContent" value={editForm.fullContent} onChange={handleFormChange} rows="6" className="w-full p-2 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-gray-100 font-mono text-sm" />
                                    </div>
                                    <div>
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="block text-sm font-medium text-gray-300">FAQs</label>
                                            <button onClick={handleAddFaq} className="bg-blue-600 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-700 transition-colors shadow-md">Add FAQ</button>
                                        </div>
                                        {editForm.faqs.map((faq, index) => (
                                            <div key={index} className="flex space-x-2 mb-2 p-2 bg-gray-700 rounded-md border border-gray-600">
                                                <input type="text" placeholder="Question" value={faq.question} onChange={(e) => handleFaqChange(index, 'question', e.target.value)} className="flex-1 p-2 border border-gray-600 rounded-md bg-gray-600 text-gray-100" />
                                                <input type="text" placeholder="Answer" value={faq.answer} onChange={(e) => handleFaqChange(index, 'answer', e.target.value)} className="flex-1 p-2 border border-gray-600 rounded-md bg-gray-600 text-gray-100" />
                                                <button onClick={() => handleRemoveFaq(index)} className="text-red-400 hover:text-red-300"><svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.381 21H7.618a2 2 0 01-1.993-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1H9a1 1 0 00-1 1v3m10 0H4" /></svg></button>
                                            </div>
                                        ))}
                                    </div>
                                    <div>
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="block text-sm font-medium text-gray-300">Warnings</label>
                                            <button onClick={handleAddWarning} className="bg-blue-600 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-700 transition-colors shadow-md">Add Warning</button>
                                        </div>
                                        {editForm.warnings.map((warning, index) => (
                                            <div key={index} className="flex space-x-2 mb-2 p-2 bg-gray-700 rounded-md border border-gray-600">
                                                <input type="text" placeholder="Warning message" value={warning} onChange={(e) => handleWarningChange(index, e.target.value)} className="flex-1 p-2 border border-gray-600 rounded-md bg-gray-600 text-gray-100" />
                                                <button onClick={() => handleRemoveWarning(index)} className="text-red-400 hover:text-red-300"><svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.381 21H7.618a2 2 0 01-1.993-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1H9a1 1 0 00-1 1v3m10 0H4" /></svg></button>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="flex justify-end space-x-4 pt-4 border-t border-gray-600">
                                        <button onClick={handleCloseModal} className="px-4 py-2 rounded-lg font-bold text-gray-300 border border-gray-600 hover:bg-gray-700 transition-colors">Cancel</button>
                                        <button onClick={handleSaveEdit} className="px-4 py-2 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700 transition-colors">Save Changes</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Error Boundary Component
        const ErrorBoundary = ({ children }) => {
            const [hasError, setHasError] = React.useState(false);
            const [error, setError] = React.useState(null);

            React.useEffect(() => {
                const handleError = (error, errorInfo) => {
                    setHasError(true);
                    setError(error);
                    console.warn('React error boundary caught error:', error);
                };

                // Add global error handler for React
                window.addEventListener('error', handleError);
                window.addEventListener('unhandledrejection', (event) => handleError(event.reason));

                return () => {
                    window.removeEventListener('error', handleError);
                    window.removeEventListener('unhandledrejection', handleError);
                };
            }, []);

            if (hasError) {
                return (
                    <div className="min-h-screen bg-gray-900 flex items-center justify-center p-4">
                        <div className="bg-gray-800 rounded-lg shadow-xl p-8 max-w-md w-full border border-gray-600">
                            <div className="text-center">
                                <div className="text-6xl mb-4">⚠️</div>
                                <h2 className="text-2xl font-bold text-red-400 mb-4">Something went wrong</h2>
                                <p className="text-gray-300 mb-6">
                                    We encountered an unexpected error. Please refresh the page or contact support if the problem persists.
                                </p>
                                <button
                                    onClick={() => window.location.reload()}
                                    className="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-md"
                                >
                                    Refresh Page
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return children;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
    <!-- Theme and UI scripts -->
    <script src="theme-manager.js"></script>
    <script src="tour-manager.js"></script>
    <script src="welcome-popup.js"></script>
</body>

</html>