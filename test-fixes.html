<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Verification Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">Fix Verification Test</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Test Results</h2>
            <div id="test-results" class="space-y-4">
                <p class="text-gray-500">Running tests...</p>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Test Controls</h2>
            <div class="space-y-4">
                <button onclick="testSanitizer()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Test Content Sanitizer
                </button>
                <button onclick="testErrorHandler()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Test Error Handler
                </button>
                <button onclick="testDuplicateClasses()" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                    Test Duplicate Classes
                </button>
                <button onclick="testCSP()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    Test CSP
                </button>
            </div>
        </div>
    </div>

    <!-- Load the scripts -->
    <script src="secure-content-sanitizer.js"></script>
    <script src="error-handler.js"></script>
    <script src="security-headers.js"></script>
    <script src="production-security.js"></script>
    <script src="secure-admin-config.js"></script>
    
    <script>
        function addResult(message, type = 'info') {
            const results = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = `p-3 rounded ${type === 'error' ? 'bg-red-100 text-red-800' : type === 'success' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
        }

        function testSanitizer() {
            try {
                addResult('Testing content sanitizer...');
                
                // Test basic sanitization
                const testHTML = '<p>Safe content</p><script>alert("dangerous")</script>';
                const sanitized = ContentSanitizer.sanitizeHTML(testHTML);
                
                if (sanitized.includes('<script>')) {
                    addResult('❌ Content sanitizer failed - script tag not removed', 'error');
                } else {
                    addResult('✅ Content sanitizer working correctly', 'success');
                }
                
                // Test disable/enable functionality
                ContentSanitizer.disableSanitizer();
                const disabledResult = ContentSanitizer.sanitizeHTML(testHTML);
                if (disabledResult.includes('<script>')) {
                    addResult('✅ Sanitizer disable functionality working', 'success');
                } else {
                    addResult('❌ Sanitizer disable functionality failed', 'error');
                }
                
                ContentSanitizer.enableSanitizer();
                
            } catch (error) {
                addResult(`❌ Content sanitizer test error: ${error.message}`, 'error');
            }
        }

        function testErrorHandler() {
            try {
                addResult('Testing error handler...');
                
                // Test error handler initialization
                if (typeof ErrorHandler !== 'undefined') {
                    addResult('✅ Error handler class loaded', 'success');
                } else {
                    addResult('❌ Error handler class not found', 'error');
                }
                
                // Test error handling
                try {
                    throw new Error('Test error message');
                } catch (error) {
                    addResult('✅ Error handling working', 'success');
                }
                
            } catch (error) {
                addResult(`❌ Error handler test error: ${error.message}`, 'error');
            }
        }

        function testDuplicateClasses() {
            try {
                addResult('Testing for duplicate class declarations...');
                
                // Check if SecureAdminValidator is defined only once
                const validatorCount = Object.keys(window).filter(key => 
                    key.includes('SecureAdminValidator') || 
                    (window[key] && window[key].constructor && window[key].constructor.name === 'SecureAdminValidator')
                ).length;
                
                if (validatorCount <= 1) {
                    addResult('✅ No duplicate class declarations found', 'success');
                } else {
                    addResult(`❌ Found ${validatorCount} SecureAdminValidator declarations`, 'error');
                }
                
            } catch (error) {
                addResult(`❌ Duplicate class test error: ${error.message}`, 'error');
            }
        }

        function testCSP() {
            try {
                addResult('Testing Content Security Policy...');
                
                // Check if CSP meta tag exists
                const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
                if (cspMeta) {
                    addResult('✅ CSP meta tag found', 'success');
                    
                    // Check if it includes www.googleapis.com
                    if (cspMeta.content.includes('www.googleapis.com')) {
                        addResult('✅ CSP includes www.googleapis.com', 'success');
                    } else {
                        addResult('❌ CSP missing www.googleapis.com', 'error');
                    }
                } else {
                    addResult('❌ CSP meta tag not found', 'error');
                }
                
            } catch (error) {
                addResult(`❌ CSP test error: ${error.message}`, 'error');
            }
        }

        // Auto-run tests on load
        window.addEventListener('load', () => {
            addResult('Fix verification test page loaded');
            addResult('Running automatic tests...');
            
            setTimeout(() => {
                testDuplicateClasses();
                testCSP();
                addResult('Automatic tests completed. Use buttons above for detailed tests.');
            }, 1000);
        });
    </script>
</body>
</html>
