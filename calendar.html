<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Cache-busting meta -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>GIKI Calendar - GIKI Chronicles</title>
  <link rel="icon" type="image/x-icon" href="/favicons/favicon.ico?v=1.8">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png?v=1.8">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png?v=1.8">
  <link rel="icon" type="image/png" sizes="48x48" href="/favicons/favicon-48x48.png?v=1.8">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png?v=1.8">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicons/favicon-192x192.png?v=1.8"> 
   <link rel="icon" type="image/png" sizes="512x512" href="/favicons/favicon-512x512.png?v=1.8"> 
   <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg?v=1.8" color="#0A1931"> 
   <meta name="msapplication-TileColor" content="#0A1931"> 
   <meta name="msapplication-TileImage" content="/favicons/mstile-150x150.png?v=1.8"> 
   <meta name="theme-color" content="#0A1931"> 
   <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.8"> <!-- fallback at root -->
  <link rel="manifest" href="/site.webmanifest?v=1.8">
  <script src="https://cdn.tailwindcss.com?v=1.8"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Rock+Salt&family=Special+Elite&family=Indie+Flower&display=swap&v=1.8" rel="stylesheet">
             <script>
         // Apply theme immediately to prevent flash
         (function() {
             const savedTheme = localStorage.getItem('selected-theme') || 'basic-dark';
             
             // Apply to documentElement immediately (always exists)
             if (document.documentElement) {
                 document.documentElement.classList.add(`theme-${savedTheme}`);
             }
             
             // Apply to body when it becomes available
             if (document.body) {
                 document.body.classList.add(`theme-${savedTheme}`);
             } else {
                 // Wait for body to be available
                 document.addEventListener('DOMContentLoaded', function() {
                     if (document.body) {
                         document.body.classList.add(`theme-${savedTheme}`);
                     }
                 });
             }
         })();
     </script>
    <link rel="stylesheet" href="styles.css?v=1.8">
    <link rel="stylesheet" href="calendar_styles.css?v=1.8">
    
    <!-- Security Utilities and CSP -->
    <script src="security-utils.js?v=1.8"></script>
    <script src="csp-headers.js?v=1.8"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    /* Palette to match the new cool blue theme */
    :root {
      --c-navy: #0A1931;
      --c-deep: #1A3D63;
      --c-steel: #4A7FA7;
      --c-light: #B3CFE5;
      --c-snow: #F6FAFD;
    }

    /* Neutralize global theme background to avoid flash */
    html.theme-basic-dark, html.theme-basic-light {
      background: transparent !important;
      background-image: none !important;
      background-color: transparent !important;
    }

    /* Full page background matching index.html */
    body {
      background: url('background.jpeg?v=1.8') no-repeat center center fixed;
      background-size: cover;
    }
    
    /* Background overlay for the entire page matching index.html */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(10,25,49,0.3) 0%, rgba(26,61,99,0.25) 50%, rgba(10,25,49,0.3) 100%);
      z-index: -1;
    }

    /* Page background - reveal campus photo with subtle translucent blues for calendar-theme */
    body.calendar-theme {
      background:
        radial-gradient(300px 220px at 12% 18%, rgba(207,227,242,0.55), transparent 65%),
        radial-gradient(320px 220px at 86% 14%, rgba(187,214,236,0.45), transparent 62%),
        radial-gradient(360px 260px at 26% 82%, rgba(168,203,231,0.30), transparent 60%),
        radial-gradient(340px 240px at 76% 76%, rgba(141,181,217,0.28), transparent 58%),
        linear-gradient(160deg, rgba(255,255,255,0.06) 12%, transparent 12.5% 22%, rgba(255,255,255,0.05) 22.5% 32%, transparent 32.5% 44%, rgba(255,255,255,0.04) 44.5%),
        url('background.jpeg?v=1.8');
      background-blend-mode: screen, screen, overlay, overlay, overlay, normal;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: scroll;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Enable main page scrolling */
    body.calendar-theme { 
      background-attachment: scroll !important; 
      overflow-y: auto !important;
    }
    
    /* Disable scrolling only on problematic containers */
    .calendar-container,
    .submit-event-form,
    .events-container {
      overflow: visible !important;
    }
    
    /* Keep modals scrollable but with thin scrollbars */
    .popup-content,
    #add-to-calendar-modal .modal-content {
      overflow-y: auto !important;
      scrollbar-width: thin !important;
      -ms-overflow-style: auto !important;
      max-height: 80vh;
    }
    
    /* Enable main page scrolling */
    main,
    .container,
    html {
      overflow: visible !important;
      overflow-y: auto !important;
    }
    
    /* Remove universal scrollbar hiding */
    * {
      scrollbar-width: auto !important;
      -ms-overflow-style: auto !important;
    }
    
    /* Re-enable smooth scrolling for main page */
    html, body {
      scroll-behavior: smooth !important;
    }
    
    /* Fix container overflow issues */
    .calendar-container,
    .submit-event-form,
    .events-container {
      overflow: visible;
    }

    /* Accent controls for inputs/buttons on this page */
    .accent-ring:focus { outline: none; box-shadow: 0 0 0 3px rgba(74,127,167,0.35); border-color: var(--c-steel); }

    /* Dark outer calendar container to match guide theme */
    .calendar-container { background: linear-gradient(135deg, rgba(10,25,49,0.92), rgba(26,61,99,0.90)) !important; box-shadow: 0 16px 40px rgba(10,25,49,0.35) !important; border: 1px solid rgba(179,207,229,0.25); border-radius: 16px; }
    .calendar-header { background: transparent !important; border-bottom: 0 !important; }
    .month-year { color: #B3CFE5 !important; font-size: 2rem; }

    /* Blueish modal styling */
    #add-to-calendar-modal.modal { background-color: rgba(10,25,49,0.65); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); }
    #add-to-calendar-modal .modal-content {
      background: linear-gradient(135deg, rgba(10,25,49,0.92), rgba(26,61,99,0.90));
      border: 1px solid rgba(179,207,229,0.25);
      box-shadow: 0 24px 60px rgba(10,25,49,0.45);
      color: #F6FAFD;
    }
    #add-to-calendar-modal .modal-title { color: #B3CFE5; }
    #add-to-calendar-modal .calendar-option-btn { background: rgba(74,127,167,0.18); color: #B3CFE5; border: 1px solid rgba(179,207,229,0.25); }
    #add-to-calendar-modal .calendar-option-btn:hover { background: rgba(74,127,167,0.32); }

    /* Also blueish event popup */
    #event-popup.event-popup { background-color: rgba(10,25,49,0.55); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
    #event-popup .popup-content { background: linear-gradient(135deg, rgba(10,25,49,0.9), rgba(26,61,99,0.88)); border: 1px solid rgba(179,207,229,0.22); color: #F6FAFD; }

    /* Unified scrolling (remove earlier conflicting "Fix dual scrollbars" block) */
    html { overflow-y: auto !important; overflow-x: hidden !important; }
    body.calendar-theme { overflow-y: auto !important; }
    main, .container { overflow: visible !important; }
    /* keep modals scrollable */
    .popup-content, #add-to-calendar-modal .modal-content {
      overflow-y: auto !important;
      max-height: 80vh;
    }

    /* Consolidated event card styles (remove any earlier duplicate .event-card blocks) */
    .event-card {
      background: linear-gradient(135deg, rgba(10,25,49,0.92), rgba(26,61,99,0.90));
      border: 1px solid rgba(179,207,229,0.22);
      color: #EAF6FF;
      border-radius: 14px;
      box-shadow: 0 12px 32px rgba(2,10,20,0.28);
      transition: transform .2s ease, box-shadow .2s ease, filter .2s ease;
      padding: 20px;
    }
    .event-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 22px 46px rgba(2,10,20,0.45);
      filter: brightness(1.02);
    }
    .event-card h3 { color: #EAF6FF; }
    .event-card p { color: #B3CFE5; }

    /* Consolidated ATC button styles (keep just this one) */
    .atc-btn {
      display: inline-flex; align-items: center; gap: 8px;
      background: rgba(74,127,167,0.18); color: #EAF6FF;
      border: 1px solid rgba(179,207,229,0.25);
      padding: 8px 12px; border-radius: 10px; font-weight: 600; font-size: 13px;
      transition: background .2s ease, transform .2s ease;
    }
    .atc-btn:hover { background: rgba(74,127,167,0.32); transform: translateY(-1px); }
    .atc-btn svg { width: 16px; height: 16px; }

    /* Events grid (keep one block) */
    #upcoming-events.events-container,
    #past-events.events-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 24px;
    }

    /* Modal: merge centering into existing overlay (remove earlier duplicate modal block) */
    #add-to-calendar-modal.modal {
      position: fixed; inset: 0; z-index: 100;
      display: flex; align-items: center; justify-content: center;
      padding: 16px;
      background-color: rgba(10,25,49,0.65);
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
    }
    #add-to-calendar-modal .modal-content {
      width: min(92vw, 720px);
      border-radius: 16px;
      padding: 20px;
      /* gradient, border, shadow kept from existing styles */
    }
    #add-to-calendar-modal .modal-title { text-align: center; margin: 4px 0 14px; }
    #add-to-calendar-modal .calendar-options-container { display: grid; gap: 14px; }
    #add-to-calendar-modal .calendar-option-btn {
      width: 100%;
      display: flex; align-items: center; gap: 12px;
      padding: 14px 18px; border-radius: 12px;
    }
    #add-to-calendar-modal .calendar-icon { width: 24px; height: 24px; }
    @media (min-width: 1280px) {
      #add-to-calendar-modal .modal-content { width: min(80vw, 680px); }
    }

    /* Shimmer skeletons (aligned to theme) */
    .skeleton {
      position: relative;
      overflow: hidden;
      background: rgba(255,255,255,0.05);
      border-radius: 14px;
      border: 1px solid rgba(179,207,229,0.12);
    }
    .skeleton::after {
      content: '';
      position: absolute;
      inset: 0;
      transform: translateX(-100%);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.12), transparent);
      animation: cal-skeleton-shimmer 1.2s infinite;
    }
    @keyframes cal-skeleton-shimmer {
      100% { transform: translateX(100%); }
    }

    .atc-btn {
      display: inline-flex; align-items: center; gap: 8px;
      background: rgba(74,127,167,0.18); color: #EAF6FF;
      border: 1px solid rgba(179,207,229,0.25);
      padding: 8px 12px; border-radius: 10px; font-weight: 600; font-size: 13px;
      transition: background .2s ease, transform .2s ease;
    }
    .atc-btn:hover { background: rgba(74,127,167,0.32); transform: translateY(-1px); }
    .atc-btn svg { width: 16px; height: 16px; }

    /* Make events containers look like guide grid */
  #upcoming-events.events-container,
  #past-events.events-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 24px;
  }

  /* Match guide-like card look */
  .event-card {
    /* already dark gradient */
    border-radius: 14px; /* unify radius */
    box-shadow: 0 12px 32px rgba(2,10,20,0.28);
    /* unify spacing on smaller screens */
    padding: 20px;
  }
  .event-card h3 { color: #EAF6FF; }
  .event-card p { color: #B3CFE5; }

  /* Keep ATC button consistent */
  .atc-btn {
    display: inline-flex; align-items: center; gap: 8px;
    background: rgba(74,127,167,0.18); color: #EAF6FF;
    border: 1px solid rgba(179,207,229,0.25);
    padding: 8px 12px; border-radius: 10px; font-weight: 600; font-size: 13px;
    transition: background .2s ease, transform .2s ease;
  }
  .atc-btn:hover { background: rgba(74,127,167,0.32); transform: translateY(-1px); }
  .atc-btn svg { width: 16px; height: 16px; }

  /* Add-to-Calendar modal: center and constrain width */
  #add-to-calendar-modal.modal {
    position: fixed; inset: 0; z-index: 100;
    display: flex; align-items: center; justify-content: center;
    padding: 16px; /* breathing room on small screens */
    background-color: rgba(10,25,49,0.65); /* keep existing overlay */
    backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
  }
  #add-to-calendar-modal .modal-content {
    width: min(92vw, 720px);  /* responsive width, capped on desktop */
    border-radius: 16px;
    padding: 20px;
    /* keep existing gradient, border and shadow */
  }
  #add-to-calendar-modal .modal-title {
    text-align: center; margin: 4px 0 14px;
  }
  #add-to-calendar-modal .calendar-options-container {
    display: grid; gap: 14px;
  }
  #add-to-calendar-modal .calendar-option-btn {
    width: 100%;
    display: flex; align-items: center; gap: 12px;
    padding: 14px 18px; border-radius: 12px;
  }
  #add-to-calendar-modal .calendar-icon { width: 24px; height: 24px; }

  @media (min-width: 1280px) {
    #add-to-calendar-modal .modal-content { width: min(80vw, 680px); }
  }

  /* Final scroll policy override: only the viewport (html) scrolls */
  html {
    overflow-y: auto !important;
    overflow-x: hidden !important;
  }
  /* Ensure body never creates its own scrollbar */
  body,
  body.calendar-theme {
    overflow: visible !important;
  }
  /* Remove inner scrollbars from common layout containers */
  main,
  .container,
  .calendar-container,
  .events-section,
  .events-container,
  .submit-event-form {
    overflow: visible !important;
  }

  /* Preserve modal content scroll (so long lists fit in viewport) */
  .popup-content,
  #add-to-calendar-modal .modal-content {
    overflow-y: auto !important;
    max-height: 80vh;
  }

  /* Submit Event form: avoid overly wide fields on desktops */
  .submit-event-form {
    width: 100%;
  }
  .submit-event-form input[type="text"],
  .submit-event-form input[type="date"],
  .submit-event-form input[type="time"],
  .submit-event-form select,
  .submit-event-form textarea {
    width: 100%;
    max-width: 100%;
  }
  /* previous desktop cap
  @media (min-width: 1024px) {
    .submit-event-form {
      max-width: 720px;
      margin-left: auto;
      margin-right: auto;
    }
  } */

  /* Desktop/laptop override: center and use 60–70vw width */
  @media (min-width: 1024px) {
    #submit-event-view .submit-event-form {
      width: clamp(420px, 52vw, 56vw) !important;
      max-width: none;
      margin-left: auto;
      margin-right: auto;
    }
  }

  /* Mobile overflow fixes: ensure no horizontal scroll and constrain popups */
  body,
  body.calendar-theme {
    /* keep vertical scroll as-is, but kill horizontal overflow on mobile */
    overflow-x: hidden !important;
  }

  /* Wrap long text/URLs so they don't force wide layouts */
  .event-card,
  .popup-content,
  #add-to-calendar-modal .modal-content {
    overflow-wrap: anywhere;
    word-break: break-word;
    box-sizing: border-box;
  }

  /* Constrain popup/content width to viewport with safe padding */
  #event-popup.event-popup {
    padding: 16px;                 /* breathing room on small screens */
    overflow: hidden;              /* avoid accidental horizontal scroll */
  }
  #event-popup .popup-content {
    width: calc(100vw - 32px);     /* 16px padding on both sides */
    max-width: min(92vw, 680px);   /* cap on larger phones/tablets */
    margin: 0 auto;
    box-sizing: border-box;
  }
  #add-to-calendar-modal.modal {
    padding: 16px;                 /* already present, keep and ensure no overflow */
    overflow: hidden;
  }
  #add-to-calendar-modal .modal-content {
    max-width: 100vw;              /* never exceed viewport */
    box-sizing: border-box;
  }

  /* On very small screens, use a single column to avoid min-width overflow */
  @media (max-width: 480px) {
    #upcoming-events.events-container,
    #past-events.events-container {
      grid-template-columns: 1fr !important;
    }
  }
  </style>
</head>

<body class="text-[#1A3D63] calendar-page calendar-theme">
  <!-- Header -->
  <header class="bg-[#1A3D63] shadow-sm sticky top-0 z-50">
    <nav class="container mx-auto px-6 py-4 flex items-center">
      <!-- Left side: Hamburger + Logo -->
      <div class="flex items-center space-x-4">
        <!-- Hamburger Menu Button -->
        <button id="sidebar-toggle" class="text-white hover:text-[#4A7FA7] focus:outline-none">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
          </svg>
        </button>
        
  <a href="index.html" class="flex flex-col items-center">
          <img src="logo.png?v=1.8" alt="GIKI Chronicles Logo" class="h-16 w-auto">
          <span class="text-lg font-bold text-white mt-1">GIKI Chronicles</span>
        </a>
      </div>
      
              <!-- Right side: Navigation -->
        <div class="hidden md:flex items-center space-x-6 ml-auto">
          <!-- <a href="index.html" class="text-gray-600 hover:text-blue-600 transition duration-300">Home</a> -->

          <a href="gallery.html?v=1.8"
            class="relative px-6 py-2.5 text-[#4A7FA7] font-semibold border-2 border-[#4A7FA7] rounded-full overflow-hidden hover:text-white transition-all duration-300 before:absolute before:top-0 before:left-0 before:w-0 before:h-full before:bg-[#4A7FA7] before:rounded-full before:transition-all before:duration-300 hover:before:w-full">
            <span class="relative z-10">Gallery</span>
          </a>

          <a href="guide.html?v=1.8"
            class="relative px-6 py-2.5 text-[#4A7FA7] font-semibold border-2 border-[#4A7FA7] rounded-full overflow-hidden hover:text-white transition-all duration-300 before:absolute before:top-0 before:left-0 before:w-0 before:h-full before:bg-[#4A7FA7] before:rounded-full before:transition-all before:duration-300 hover:before:w-full">
            <span class="relative z-10">Freshmen Guide</span>
          </a>

          <a href="calendar.html?v=1.8"
            class="relative px-6 py-2.5 text-[#4A7FA7] font-semibold border-2 border-[#4A7FA7] rounded-full overflow-hidden hover:text-white transition-all duration-300 before:absolute before:top-0 before:left-0 before:w-0 before:h-full before:bg-[#4A7FA7] before:rounded-full before:transition-all before:duration-300 hover:before:w-full">
            <span class="relative z-10">Calendar</span>
          </a>
          <!-- GUEST NAVIGATION (DESKTOP) -->
          <div id="guest-nav" class="flex items-center space-x-6">
            <a href="login.html?v=1.8" class="text-white hover:text-[#4A7FA7] transition duration-300">Login</a>
            <!-- <a href="signup.html"
              class="bg-blue-600 text-white px-4 py-2 rounded-full hover:bg-blue-700 transition duration-300">Sign Up</a> -->
          </div>

          <!-- USER NAVIGATION (DESKTOP) -->
          <div id="user-nav" class="hidden md:flex items-center space-x-6">
            <!-- <a href="profile.html" class="text-gray-600 hover:text-blue-600">My Profile</a> -->
            <!-- <a href="gallery.html" class="text-gray-600 hover:text-blue-600">Gallery</a> -->
            <!-- <a href="contact.html" class="text-gray-600 hover:text-blue-600">Contact</a> -->
            <!-- <button id="logout-button"
                          class="bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-600 transition duration-300">Logout</button> -->
          </div>
        </div>
    </nav>
  </header>

  <!-- Sidebar -->
  <div id="sidebar"
    class="fixed inset-y-0 left-0 z-50 w-64 bg-[#1A3D63] shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
    <div class="flex items-center justify-between p-6 border-b border-white/20">
      <h2 class="text-xl font-bold text-white">Menu</h2>
      <button id="sidebar-close" class="text-white hover:text-[#4A7FA7] focus:outline-none">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <nav class="p-6 flex-1 overflow-y-auto">
      <div class="space-y-4">
        <!-- Main Navigation -->
        <div>
          <h3 class="text-sm font-semibold text-white/70 uppercase tracking-wider mb-3">Main</h3>
          <div class="space-y-2">
            <a href="index.html"
              class="flex items-center px-3 py-2 text-white hover:bg-white/20 hover:text-[#4A7FA7] rounded-lg transition duration-200">
              <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                </path>
              </svg>
              Home
            </a>
            <a href="post.html?v=1.8"
              class="flex items-center px-3 py-2 text-white hover:bg-white/20 hover:text-[#4A7FA7] rounded-lg transition duration-200">
              <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z">
                </path>
              </svg>
              All Posts
            </a>
            <a href="about.html?v=1.8"
              class="flex items-center px-3 py-2 text-white hover:bg-white/20 hover:text-[#4A7FA7] rounded-lg transition duration-200">
              <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              About
            </a>
            <a href="contact.html?v=1.8"
              class="flex items-center px-3 py-2 text-white hover:bg-white/20 hover:text-[#4A7FA7] rounded-lg transition duration-200">
              <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                </path>
              </svg>
              Contact
            </a>
            <a href="gallery.html?v=1.8"
              class="flex items-center px-3 py-2 text-white hover:bg-white/20 hover:text-[#4A7FA7] rounded-lg transition duration-200">
              <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                </path>
              </svg>
              Gallery
            </a>
          </div>
        </div>

        <!-- Resources -->
        <div>
          <h3 class="text-sm font-semibold text-white/70 uppercase tracking-wider mb-3">Resources</h3>
          <div class="space-y-2">
            <a href="guide.html?v=1.8"
              class="flex items-center px-3 py-2 text-white hover:bg-white/20 hover:text-[#4A7FA7] rounded-lg transition duration-200">
              <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                </path>
              </svg>
              Freshman Guide
            </a>
            <!-- Calendar Dropdown for Mobile -->
            <div class="relative">
              <button id="sidebar-calendar-dropdown-toggle" class="w-full flex items-center px-3 py-2 text-white hover:bg-white/20 hover:text-[#4A7FA7] rounded-lg transition duration-200">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                Calendar
                <svg class="w-4 h-4 ml-auto transition-transform duration-200" id="sidebar-calendar-dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
              
              <!-- Mobile Calendar Dropdown Menu -->
              <div id="sidebar-calendar-dropdown" class="hidden pl-8 mt-2 space-y-1">
                <a href="calendar.html?v=1.8" class="block px-3 py-2 text-sm text-gray-600 hover:bg-[#B3CFE5]/20 hover:text-[#4A7FA7] rounded-lg transition duration-200 flex items-center">
                  <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                  </svg>
                  Calendar View
                </a>
                <a href="calendar.html?v=1.8#events" class="block px-3 py-2 text-sm text-white/80 hover:bg-white/20 hover:text-[#4A7FA7] rounded-lg transition duration-200 flex items-center">
                  <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
                  </svg>
                  View Events
                </a>
                <a href="calendar.html?v=1.8#submit" class="block px-3 py-2 text-sm text-white/80 hover:bg-white/20 hover:text-[#4A7FA7] rounded-lg transition duration-200 flex items-center">
                  <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                  </svg>
                  Submit Event
                </a>
              </div>
            </div>
          </div>
        </div>



        <!-- User Section -->
        <div id="sidebar-guest-nav">
          <h3 class="text-sm font-semibold text-white/70 uppercase tracking-wider mb-3">Account</h3>
          <div class="space-y-2">
            <a href="login.html?v=1.8"
              class="flex items-center px-3 py-2 text-white hover:bg-white/20 hover:text-[#4A7FA7] rounded-lg transition duration-200">
              <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1">
                </path>
              </svg>
              Login
            </a>
          </div>
        </div>

        <div id="sidebar-user-nav" class="hidden">
          <h3 class="text-sm font-semibold text-white/70 uppercase tracking-wider mb-3">My Account</h3>
          <div class="space-y-2">
            <a href="post.html?v=1.8"
              class="flex items-center px-3 py-2 text-white hover:bg-white/20 hover:text-[#4A7FA7] rounded-lg transition duration-200">
              <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
              My Profile
            </a>
            <a href="post.html?v=1.8"
              class="flex items-center px-3 py-2 text-white hover:bg-white/20 hover:text-[#4A7FA7] rounded-lg transition duration-200">
              <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                </path>
              </svg>
              Write Post
            </a>
            <button id="sidebar-admin-access-btn"
              class="hidden w-full flex items-center px-3 py-2 text-white hover:bg-red-500/20 rounded-lg transition duration-200">
              <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z">
                </path>
              </svg>
              🔐 Admin Portal
            </button>
            <button id="sidebar-logout-button"
              class="w-full flex items-center px-3 py-2 text-red-400 hover:bg-red-500/20 rounded-lg transition duration-200">
              <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
              </svg>
              Logout
            </button>
          </div>
        </div>
      </div>
    </nav>
  </div>

  <!-- Sidebar Overlay -->
  <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

  <main class="min-h-screen">
    <div class="container mx-auto px-4 py-8 md:py-12">
      <div id="calendar-view">
        <div class="text-center mb-8 md:mb-12">
          <h1 class="text-3xl md:text-4xl font-bold handwriting-title mb-4">GIKI Calendar</h1>
          <p class="mt-4 md:mt-5 text-base md:text-lg text-[#1A3D63] max-w-2xl mx-auto px-4">
            Discover what's happening at the university. Your hub for all club and society events.
          </p>
        </div>

        <div class="calendar-container">
          <div class="calendar-header">
            <button id="left-arrow" class="nav-arrow left-arrow" aria-label="Previous Month">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div id="month-year" class="month-year"></div>
            <button id="right-arrow" class="nav-arrow right-arrow" aria-label="Next Month">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M9 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
          <div id="calendar-grid" class="calendar-grid">
            <div class="day-of-week">Su</div>
            <div class="day-of-week">Mo</div>
            <div class="day-of-week">Tu</div>
            <div class="day-of-week">We</div>
            <div class="day-of-week">Th</div>
            <div class="day-of-week">Fr</div>
            <div class="day-of-week">Sa</div>
          </div>
        </div>
      </div>

      <div id="submit-event-view" class="submit-event-section hidden">
        <div class="text-center mb-12">
          <h1 class="text-4xl font-bold text-gray-800 mb-4">Submit a New Event</h1>
          <p class="text-lg text-gray-600 max-w-2xl mx-auto">
            Fill out the form below to add your club or society event to the calendar.
          </p>
        </div>
        <div class="submit-event-form">
          <form id="event-form">
            <div class="form-group">
              <label for="eventName">Event Name</label>
              <input type="text" id="eventName" name="eventName" required>
            </div>
            <div class="form-group">
              <label for="eventDate">Event Date</label>
              <input type="date" id="eventDate" name="eventDate" required>
            </div>
            <div class="form-group">
              <label for="eventTime">Event Time (Optional)</label>
              <input type="time" id="eventTime" name="eventTime">
            </div>
            <div class="form-group">
              <label for="eventType">Event Type</label>
              <select id="eventType" name="eventType" required>
                <option value="">Select a type...</option>
                <option value="Tech">Tech</option>
                <option value="Cultural">Cultural</option>
                <option value="Academic">Academic</option>
                <option value="Sports">Sports</option>
              </select>
            </div>
            <div class="form-group">
              <label for="eventLocation">Location</label>
              <input type="text" id="eventLocation" name="eventLocation" required>
            </div>
            <div class="form-group">
              <label for="eventDescription">Description</label>
              <textarea id="eventDescription" name="eventDescription" required></textarea>
            </div>
            <button type="submit" class="submit-form-btn">Submit Event</button>
          </form>
        </div>
      </div>

      <div id="events-view" class="events-section hidden">
        <div class="text-center mb-12">
          <h1 class="text-4xl font-bold text-gray-800 mb-4">All GIKI Events</h1>
          <p class="text-lg text-gray-600 max-w-2xl mx-auto">
            A list of all upcoming and past events at the university.
          </p>
        </div>

        <h2 class="event-category-title">Upcoming Events</h2>
        <div id="upcoming-events" class="events-container">
        </div>

        <h2 class="event-category-title">Past Events</h2>
        <div id="past-events" class="events-container">
        </div>
      </div>

      <div id="map-view" class="map-section hidden">
        <div class="text-center mb-12">
          <h1 class="text-4xl font-bold text-gray-800 mb-4">Campus Map</h1>
          <p class="text-lg text-gray-600 max-w-2xl mx-auto">
            A detailed map of the GIKI campus.
          </p>
        </div>
        <img src="map.png" alt="Campus Map of GIKI" class="map-image">
      </div>
    </div>
  </main>

  <div id="event-popup" class="event-popup hidden">
    <div class="popup-content">
      <button class="close-btn">&times;</button>
      <div id="event-list-container">
      </div>
    </div>
  </div>

  <div id="add-to-calendar-modal" class="modal hidden">
    <div class="modal-content">
      <span class="modal-close-add">&times;</span>
      <h3 class="modal-title">Add to your Calendar</h3>
      <div class="calendar-options-container">
                 <a href="#" target="_blank" rel="noopener noreferrer" id="google-calendar-link" class="calendar-option-btn">
           <svg class="calendar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
             <path fill="#4285F4" d="M40 8H28V4H40V8Z" />
             <path fill="#FBBC04" d="M20 8H8V4H20V8Z" />
             <path fill="#EA4335" d="M40 8H8V40H40V8Z" />
             <path fill="#1A73E8" d="M30 20H18V16H30V20Z" />
             <path fill="#34A853" d="M30 28H18V24H30V28Z" />
             <path fill="#FCCC49" d="M22 36H18V32H22V36Z" />
           </svg>
           <span>Google Calendar</span>
         </a>
         <a href="#" target="_blank" rel="noopener noreferrer" id="outlook-calendar-link" class="calendar-option-btn">
          <svg class="calendar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path fill="#0078D4"
              d="M21 21.5L21 2.5C21 2.22386 20.7761 2 20.5 2L3.5 2C3.22386 2 3 2.22386 3 2.5L3 21.5C3 21.7761 3.22386 22 3.5 22L20.5 22C20.7761 22 21 21.7761 21 21.5ZM19 20L5 20L5 4L19 4L19 20ZM12 11.5L12 18.5C12 18.7761 11.7761 19 11.5 19L9.5 19C9.22386 19 9 18.7761 9 18.5L9 11.5C9 11.2239 9.22386 11 9.5 11L11.5 11C11.7761 11 12 11.2239 12 11.5ZM15 11.5L15 18.5C15 18.7761 14.7761 19 14.5 19L12.5 19C12.2239 19 12 18.7761 12 18.5L12 11.5C12 11.2239 12.2239 11 12.5 11L14.5 11C14.7761 11 15 11.2239 15 11.5ZM17 11.5L17 18.5C17 18.7761 16.7761 19 16.5 19L14.5 19C14.2239 19 14 18.7761 14 18.5L14 11.5C14 11.2239 14.2239 11 14.5 11L16.5 11C16.7761 11 17 11.2239 17 11.5Z" />
          </svg>
          <span>Outlook Calendar</span>
        </a>
        <a href="#" id="apple-calendar-link" class="calendar-option-btn">
          <svg class="calendar-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
            <rect fill="#fff" x="64" y="96" width="384" height="384" rx="48" />
            <path fill="#D20D23" d="M64 96h384V64a16 16 0 0 0-16-16H80a16 16 0 0 0-16 16v32z" />
            <path fill="#2E2E2E"
              d="M368 80h-32a16 16 0 0 0 0 32h32a16 16 0 0 0 0-32zM176 80h-32a16 16 0 0 0 0 32h32a16 16 0 0 0 0-32z" />
            <text x="50%" y="60%" text-anchor="middle" font-family="Helvetica Neue, Arial, sans-serif" font-size="120"
              font-weight="bold" fill="#2E2E2E">
              25
            </text>
          </svg>
          <span>Apple Calendar</span>
        </a>
      </div>
    </div>
  </div>

  <div id="notification-container">
    <div id="notification" class="notification">
      <span id="notification-close" class="notification-close">&times;</span>
      <h4 id="notification-title"></h4>
      <p id="notification-message"></p>
    </div>
  </div>

  <!-- Firebase SDKs (required before combined.min.js) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

      <!-- Secure Firebase Configuration (must be loaded before combined.min.js) -->
    <script src="firebase-config-vercel.js?v=1.8"></script>

  <!-- Optimized combined JavaScript bundle (includes Firebase initialization) -->
  <script src="combined.min.js?v=1.8"></script>
  <!-- Unified Notifications -->
  <script src="notifications.js?v=1.8"></script>
  
  <!-- Additional scripts not in bundle -->
  
  <script src="firebase-error-handler.js?v=1.8"></script>
  <!-- Fallback Calendar Router + Events Loader -->
  <script>
    (function () {
      // Simple hash router to toggle views
      function showViewFromHash() {
        const hash = (window.location.hash || '').toLowerCase();
        const calendarView = document.getElementById('calendar-view');
        const eventsView = document.getElementById('events-view');
        const submitView = document.getElementById('submit-event-view');

        if (!calendarView || !eventsView || !submitView) return;

        // Hide all
        calendarView.classList.add('hidden');
        eventsView.classList.add('hidden');
        submitView.classList.add('hidden');

        if (hash === '#events') {
          eventsView.classList.remove('hidden');
          // ensure skeletons visible while deciding
          showSkeletons();
          // try fallback soon after view shows
          setTimeout(() => {
            const upcomingEl = document.getElementById('upcoming-events');
            const pastEl = document.getElementById('past-events');
            const hasContent = hasRealContent(upcomingEl) || hasRealContent(pastEl);
            if (hasContent) {
              removeSkeletons();
            } else {
              tryLoadEventsFallback();
            }
          }, 300);
        } else if (hash === '#submit') {
          submitView.classList.remove('hidden');
        } else {
          calendarView.classList.remove('hidden');
        }
      }

      // Icons by type (inline SVG)
      function iconForType(typeRaw) {
        const type = (typeRaw || '').toLowerCase();
        // 24px heroicon-like inline SVGs
        const wrap = (svg, tintClass) => `
          <div class="w-10 h-10 rounded-full flex items-center justify-center ${tintClass}" style="box-shadow: 0 6px 16px rgba(2,10,20,0.25); border: 1px solid rgba(255,255,255,0.06)">
            ${svg}
          </div>
        `;
        const svgAttrs = 'class="w-5 h-5 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"';
        const icons = {
          academic: wrap(`<svg ${svgAttrs}><path stroke-linecap="round" stroke-linejoin="round" d="M12 14l9-5-9-5-9 5 9 5z"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 14l6.16-3.422A12.083 12.083 0 0112 21.5 12.083 12.083 0 015.84 10.578L12 14z"/></svg>`, 'bg-[#4A7FA7]'),
          tech: wrap(`<svg ${svgAttrs}><path stroke-linecap="round" stroke-linejoin="round" d="M16 18l6-6-6-6M8 6l-6 6 6 6"/></svg>`, 'bg-[#1A3D63]'),
          cultural: wrap(`<svg ${svgAttrs}><path stroke-linecap="round" stroke-linejoin="round" d="M9 14l-4 2V7l4-2 6 3 4-2v9l-4 2-6-3z"/></svg>`, 'bg-[#6C7BA8]'),
          sports: wrap(`<svg ${svgAttrs}><circle cx="12" cy="12" r="9"/><path stroke-linecap="round" stroke-linejoin="round" d="M3 12h18M12 3a12 12 0 000 18"/></svg>`, 'bg-[#2F855A]')
        };
        return icons.academic && icons[type] ? icons[type] : wrap(`<svg ${svgAttrs}><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h10"/></svg>`, 'bg-[#4A7FA7]');
      }

      function typeBadge(typeRaw) {
        const type = (typeRaw || 'General').trim();
        return `<span class="badge">${type}</span>`;
      }

      // Helpers to detect real content (ignore skeletons)
      function hasRealContent(container) {
        if (!container) return false;
        return Array.from(container.children).some(el => {
          if (el.classList?.contains('skeleton')) return false;
          // treat empty-state cards as NOT real content
          if (el.classList?.contains('event-card') && el.classList?.contains('empty-state')) return false;
          if (el.classList?.contains('event-card')) return true;
          return (el.textContent || '').trim().length > 0;
        });
      }

      function removeSkeletons() {
        const upcomingEl = document.getElementById('upcoming-events');
        const pastEl = document.getElementById('past-events');
        [upcomingEl, pastEl].forEach(el => {
          if (!el) return;
          el.querySelectorAll('.skeleton').forEach(n => n.remove());
        });
      }

      function showSkeletons() {
        const upcomingEl = document.getElementById('upcoming-events');
        const pastEl = document.getElementById('past-events');
        if (!upcomingEl || !pastEl) return;

        const makeSkeleton = () => {
          const d = document.createElement('div');
          d.className = 'skeleton p-5 mb-4';
          d.innerHTML = `
            <div class="flex items-center gap-3 mb-3">
              <div class="w-10 h-10 rounded-full bg-white/10"></div>
              <div class="flex-1">
                <div class="h-4 w-40 bg-white/10 rounded mb-2"></div>
                <div class="h-3 w-28 bg-white/10 rounded"></div>
              </div>
            </div>
            <div class="h-3 w-52 bg-white/10 rounded mb-1"></div>
            <div class="h-3 w-40 bg-white/10 rounded mb-1"></div>
            <div class="h-3 w-64 bg-white/10 rounded"></div>
          `;
          return d;
        };

        if (!hasRealContent(upcomingEl) && upcomingEl.querySelectorAll('.skeleton').length === 0) {
          for (let i = 0; i < 4; i++) upcomingEl.appendChild(makeSkeleton());
        }
        if (!hasRealContent(pastEl) && pastEl.querySelectorAll('.skeleton').length === 0) {
          for (let i = 0; i < 2; i++) pastEl.appendChild(makeSkeleton());
        }
      }

      // De-dupe helpers for fallback cards (used by renderEventCard and tryLoadEventsFallback)
    function safeKey(s) { return (s || '').toString().toLowerCase().replace(/[^a-z0-9]+/g, '-'); }
    function eventKey(ev) {
      const title = (ev.title || ev.name || '').trim();
      const startMs = ev._start instanceof Date ? ev._start.getTime() : 0;
      const loc = (ev.location || ev.place || '').trim();
      return safeKey(`${title}|${startMs}|${loc}`);
    }
    function clearFallbackCards(container) {
      if (!container) return;
      container.querySelectorAll('.event-card[data-origin="fallback"]').forEach(n => n.remove());
    }

      // Single empty-state renderer (dedupes previous empty cards)
      function renderEmpty(container, text) {
        if (!container) return;
        // remove any existing empties and skeletons
        container.querySelectorAll('.empty-state, .skeleton').forEach(n => n.remove());
        const msg = document.createElement('div');
        msg.className = 'event-card empty-state p-4';
        msg.textContent = text;
        container.appendChild(msg);
      }

      // Date helpers and ICS/Google link generators
      function parseDateish(val) {
        try {
          if (!val) return null;
          if (typeof val === 'string') return new Date(val);
          if (typeof val === 'number') return new Date(val);
          if (typeof val.toDate === 'function') return val.toDate();
          if (val.seconds) return new Date(val.seconds * 1000);
        } catch (_) {}
        return null;
      }
      function pad(n){ return String(n).padStart(2,'0'); }
      function formatICSDate(d) {
        // UTC YYYYMMDDTHHMMSSZ
        const y = d.getUTCFullYear();
        const m = pad(d.getUTCMonth()+1);
        const day = pad(d.getUTCDate());
        const h = pad(d.getUTCHours());
        const mi = pad(d.getUTCMinutes());
        const s = pad(d.getUTCSeconds());
        return `${y}${m}${day}T${h}${mi}${s}Z`;
      }
      function buildICS({ title, description, start, end, location }) {
        const now = new Date();
        const uid = `${Date.now()}-${Math.random().toString(36).slice(2)}@gikichronicles`;
        const esc = (s) => (s || '').toString().replace(/\r?\n/g, '\\n');
        return [
          'BEGIN:VCALENDAR',
          'VERSION:2.0',
          'PRODID:-//GIKI Chronicles//Calendar//EN',
          'CALSCALE:GREGORIAN',
          'METHOD:PUBLISH',
          'BEGIN:VEVENT',
          `UID:${uid}`,
          `DTSTAMP:${formatICSDate(now)}`,
          `DTSTART:${formatICSDate(start)}`,
          `DTEND:${formatICSDate(end)}`,
          `SUMMARY:${esc(title)}`,
          `DESCRIPTION:${esc(description)}`,
          `LOCATION:${esc(location)}`,
          'END:VEVENT',
          'END:VCALENDAR'
        ].join('\r\n');
      }
      function buildGoogleLink({ title, description, start, end, location }) {
        const fmt = (d) => formatICSDate(d); // same UTC format works for Google
        const qs = new URLSearchParams({
          action: 'TEMPLATE',
          text: title || 'Event',
          dates: `${fmt(start)}/${fmt(end)}`,
          details: description || '',
          location: location || ''
        });
        return `https://calendar.google.com/calendar/render?${qs.toString()}`;
      }

      function wireModalCloseOnce() {
        if (window.__atcModalWired) return;
        window.__atcModalWired = true;
        const modal = document.getElementById('add-to-calendar-modal');
        const content = modal && modal.querySelector('.modal-content');
        const closeBtn = modal && modal.querySelector('.modal-close-add');
        const hide = () => modal && modal.classList.add('hidden');
        closeBtn && closeBtn.addEventListener('click', hide);
        modal && modal.addEventListener('click', (e) => {
          if (!content) return;
          if (!content.contains(e.target)) hide();
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') hide();
        });
      }

      function openAddToCalendarModal(payload) {
        const modal = document.getElementById('add-to-calendar-modal');
        const googleA = document.getElementById('google-calendar-link');
        const outlookA = document.getElementById('outlook-calendar-link');
        const appleA = document.getElementById('apple-calendar-link');
        if (!modal || !googleA || !outlookA || !appleA) return;

        // Fallback defaults
        const start = payload.start ? new Date(payload.start) : new Date(Date.now() + 60 * 60 * 1000);
        const end = payload.end ? new Date(payload.end) : new Date(start.getTime() + 60 * 60 * 1000);

        const pack = {
          title: payload.title || 'Event',
          description: payload.description || '',
          start, end,
          location: payload.location || ''
        };

        // Links
        try {
          googleA.href = buildGoogleLink(pack);
        } catch { googleA.removeAttribute('href'); }

        try {
          const ics = buildICS(pack);
          const icsUri = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(ics);
          outlookA.href = icsUri;
          outlookA.setAttribute('download', 'event.ics');
          appleA.href = icsUri;
          appleA.setAttribute('download', 'event.ics');
        } catch {
          outlookA.removeAttribute('href');
          appleA.removeAttribute('href');
        }

        wireModalCloseOnce();
        modal.classList.remove('hidden');
      }

      // Render helper (enhanced card)
      function renderEventCard(container, ev) {
        // compute unique key and skip if already present
        const ekey = eventKey(ev);
        if (container && ekey && container.querySelector(`.event-card[data-ekey="${ekey}"]`)) {
          return;
        }

        const wrap = document.createElement('div');
        wrap.className = 'event-card p-5 mb-4';
        wrap.dataset.origin = 'fallback';
        if (ekey) wrap.dataset.ekey = ekey;

        const title = ev.title || ev.name || 'Untitled Event';
        const desc = ev.description || '';
        const type = ev.type || ev.category || 'General';
        const dateText = ev.dateText || '';
        const location = ev.location || ev.place || '';
        if (ev._start instanceof Date) wrap.dataset.start = ev._start.toISOString();
        if (ev._end instanceof Date) wrap.dataset.end = ev._end.toISOString();
        wrap.dataset.title = title;
        wrap.dataset.location = location || '';
        wrap.dataset.description = desc || '';

        wrap.innerHTML = `
          <div class="flex items-start gap-3">
            ${iconForType(type)}
            <div class="flex-1">
              <div class="flex items-center justify-between gap-2 flex-wrap">
                <h3 class="text-xl font-extrabold text-white">${title}</h3>
                ${typeBadge(type)}
              </div>
              ${dateText ? `<p class="text-sm text-[#B3CFE5] mt-1">${dateText}</p>` : ''}
              ${location ? `<p class="text-sm text-[#B3CFE5] mt-1">Location: ${location}</p>` : ''}
              ${desc ? `<p class="text-sm text-[#EAF6FF]/90 mt-3">${desc}</p>` : ''}
              <div class="mt-3 flex justify-end">
                <button type="button" class="atc-btn" data-add-to-calendar="1" aria-label="Add ${title} to your calendar" title="Add to Calendar">
                  <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                  Add to Calendar
                </button>
              </div>
            </div>
          </div>
        `;
        container.appendChild(wrap);
      }

      // Delegate only the ATC button clicks, not the whole card
    function attachCardDelegates() {
      const handler = (e) => {
        const btn = e.target.closest && e.target.closest('[data-add-to-calendar]');
        if (!btn) return;
        const card = btn.closest('.event-card');
        if (!card) return;

        const title = card.dataset.title || (card.querySelector('h3')?.textContent?.trim()) || 'Event';
        const start = parseDateish(card.dataset.start) || new Date(Date.now() + 60 * 60 * 1000);
        const end = parseDateish(card.dataset.end) || new Date(start.getTime() + 60 * 60 * 1000);
        const location = card.dataset.location || '';
        const description = card.dataset.description || '';

        openAddToCalendarModal({ title, description, location, start, end });
      };
      const upcomingEl = document.getElementById('upcoming-events');
      const pastEl = document.getElementById('past-events');
      upcomingEl && upcomingEl.addEventListener('click', handler);
      pastEl && pastEl.addEventListener('click', handler);
    }

      // Add missing fallback loader
    async function tryLoadEventsFallback() {
      const upcomingEl = document.getElementById('upcoming-events');
      const pastEl = document.getElementById('past-events');
      if (!upcomingEl || !pastEl) return;

      // Prevent concurrent or repeated renders
      if (window.__eventsLoading || window.__eventsRenderedOnce) {
        return;
      }
      window.__eventsLoading = true;

      try {
        // If there is already real content (by the main bundle), just clear skeletons
        if (hasRealContent(upcomingEl) || hasRealContent(pastEl)) {
          removeSkeletons();
          window.__eventsRenderedOnce = true;
          return;
        }

        // Ensure skeletons are visible during fetch
        showSkeletons();

        // Firebase availability check
        if (typeof firebase === 'undefined' || !firebase.firestore) {
          setTimeout(removeSkeletons, 500);
          window.__eventsRenderedOnce = true;
          return;
        }

        const db = firebase.firestore();
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : null;

        // Candidate collections to probe
        const candidates = [];
        if (appId) {
          candidates.push(db.collection('artifacts').doc(appId).collection('public').doc('data').collection('events'));
        }
        candidates.push(db.collection('events'));

        let events = [];
        for (const ref of candidates) {
          try {
            let snap;
            try {
              snap = await ref.orderBy('date', 'asc').get();
            } catch {
              snap = await ref.get();
            }
            if (!snap.empty) {
              events = snap.docs.map(d => ({ id: d.id, ...d.data() }));
              if (events.length) break;
            }
          } catch (_) {}
        }

        removeSkeletons();

        // Clear only our previously rendered fallback cards before new render
        clearFallbackCards(upcomingEl);
        clearFallbackCards(pastEl);


        if (!events.length) {
          renderEmpty(upcomingEl, 'No upcoming events.');
          renderEmpty(pastEl, 'No past events.');
          window.__eventsRenderedOnce = true;
          return;
        }

        const now = new Date();
        const toDate = (val) => {
          try {
            if (!val) return null;
            if (typeof val.toDate === 'function') return val.toDate();
           
            if (typeof val === 'number') return new Date(val);
            if (typeof val === 'string') return new Date(val);
            if (val.seconds) return new Date(val.seconds * 1000);
          } catch (_) { return null; }
          return null;
        };
        const fmt = (d) => d ? d.toLocaleString([], { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';
        const norm = events.map(ev => {
          const start = toDate(ev.startDate || ev.start || ev.date);
          const end = toDate(ev.endDate || ev.end) || start;
          const parts = [];
          if (start) parts.push(`Starts: ${fmt(start)}`);
          if (end && end.getTime() !== start?.getTime?.()) parts.push(`Ends: ${fmt(end)}`);
          return { ...ev, _start: start, _end: end, dateText: parts.join(' • ') };
        });

        const upcoming = norm
          .filter(ev => (ev._end || ev._start || now) >= now)
          .sort((a, b) => (a._start?.getTime?.() || 0) - (b._start?.getTime?.() || 0));
        const past = norm
          .filter(ev => (ev._end || ev._start || now) < now)
          .sort((a, b) => (b._start?.getTime?.() || 0) - (a._start?.getTime?.() || 0));



        if (!upcoming.length) {
          renderEmpty(upcomingEl, 'No upcoming events.');
        } else {
          upcomingEl.querySelectorAll('.empty-state').forEach(n => n.remove());
          upcoming.forEach(ev => renderEventCard(upcomingEl, ev));
        }

        if (!past.length) {
          renderEmpty(pastEl, 'No past events.');
        } else {
          pastEl.querySelectorAll('.empty-state').forEach(n => n.remove());
          past.forEach(ev => renderEventCard(pastEl, ev));
        }

        window.__eventsRenderedOnce = true;
      } finally {
        window.__eventsLoading = false;
      }
    }

    // Init on load and hash change
    window.addEventListener('hashchange', showViewFromHash);
    document.addEventListener('DOMContentLoaded', () => {
      showViewFromHash();

      // Ensure ATC buttons work on dynamically rendered cards
      attachCardDelegates();

      // If navigating directly to #events, keep skeletons, then decide
      if ((window.location.hash || '').toLowerCase() === '#events') {
        showSkeletons();
      }

      // Give combined.min.js time to populate; then either remove skeletons or fallback-load
      setTimeout(() => {
        const upcomingEl = document.getElementById('upcoming-events');
        const pastEl = document.getElementById('past-events');
        const hasContent = hasRealContent(upcomingEl) || hasRealContent(pastEl);
        if (hasContent) {
          removeSkeletons();
        } else {
          tryLoadEventsFallback();
        }
      }, 1200);

      // Second-chance attempt in case first failed
      setTimeout(() => {
        const upcomingEl = document.getElementById('upcoming-events');
        const pastEl = document.getElementById('past-events');
        const hasContent = hasRealContent(upcomingEl) || hasRealContent(pastEl);
        if (!hasContent) {
          tryLoadEventsFallback();
        }
      }, 3500);
    });
  })();
  </script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js', { updateViaCache: 'none' })
        .then(registration => {
          // force check for new SW and activate it immediately
          registration.update();
          if (registration.waiting) {
            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
          }
          registration.addEventListener('updatefound', () => {
            const sw = registration.installing;
            if (!sw) return;
            sw.addEventListener('statechange', () => {
              if (sw.state === 'installed' && navigator.serviceWorker.controller) {
                if (registration.waiting) registration.waiting.postMessage({ type: 'SKIP_WAITING' });
              }
            });
          });
        })
        .catch(error => {
          console.log('Service Worker registration failed:', error);
        });

      // reload page when new SW takes control (prevents serving older HTML/JS)
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        window.location.reload();
      });
    }
  </script>
</body>

</html>