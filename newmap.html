<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIKI Chronicles - Interactive Campus Map</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicons/favicon.ico?v=1.8">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png?v=1.8">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png?v=1.8">
    <link rel="icon" type="image/png" sizes="48x48" href="/favicons/favicon-48x48.png?v=1.8">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png?v=1.8">
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/favicon-192x192.png?v=1.8"> 
   <link rel="icon" type="image/png" sizes="512x512" href="/favicons/favicon-512x512.png?v=1.8"> 
   <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg?v=1.8" color="#0A1931"> 
   <meta name="msapplication-TileColor" content="#0A1931"> 
   <meta name="msapplication-TileImage" content="/favicons/mstile-150x150.png?v=1.8"> 
   <meta name="theme-color" content="#0A1931"> 
   <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.8"> <!-- fallback at root -->
    <link rel="manifest" href="/site.webmanifest?v=1.8">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px) scale(0.95);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes touchRipple {
            0% {
                transform: scale(0);
                opacity: 1;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .animate-slideIn {
            animation: slideIn 0.3s ease-out forwards;
        }

        .animate-touchRipple {
            animation: touchRipple 0.6s ease-out forwards;
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }

        #loadingIndicator {
            transition: opacity 0.3s ease-out;
        }

        .map-container {
            cursor: grab;
        }

        .map-container:active {
            cursor: grabbing;
        }

        .touch-ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            pointer-events: none;
            z-index: 1000;
        }

        .infobox {
            position: fixed;
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 12px;
            padding: 16px;
            min-width: 280px;
            max-width: 400px;
            z-index: 100;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease-out;
        }

        .infobox.show {
            transform: translateY(0);
            opacity: 1;
        }

        .infobox-close {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .infobox-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
    </style>
    <script>
        // Simple error handling for map loading
        window.addEventListener('error', function (e) {
            console.warn('Map loading error:', e);
        });
    </script>
</head>

<body class="w-screen h-screen bg-gray-900 overflow-hidden touch-none font-sans select-none">
    <!-- Back to Guide Button -->
    <div class="fixed top-4 left-4 z-50">
        <a href="guide.html"
            class="inline-flex items-center gap-2 bg-white/90 hover:bg-white text-gray-800 px-4 py-2 rounded-lg font-medium transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg backdrop-blur-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m15 18-6-6 6-6" />
            </svg>
            Back to Guide
        </a>


    </div>

    <!-- Controls -->
    <div class="fixed top-4 right-4 md:right-5 flex flex-col gap-3 z-50">
        <button id="zoomIn"
            class="w-11 h-11 md:w-12 md:h-12 bg-white/90 hover:bg-white rounded-full flex items-center justify-center text-2xl font-semibold text-gray-800 transition-all duration-200 hover:scale-110 active:scale-95 shadow-lg backdrop-blur-sm touch-manipulation"
            title="Zoom In">+</button>
        <button id="zoomOut"
            class="w-11 h-11 md:w-12 md:h-12 bg-white/90 hover:bg-white rounded-full flex items-center justify-center text-2xl font-semibold text-gray-800 transition-all duration-200 hover:scale-110 active:scale-95 shadow-lg backdrop-blur-sm touch-manipulation"
            title="Zoom Out">âˆ’</button>
        <button id="resetView"
            class="w-11 h-11 md:w-12 md:h-12 bg-white/90 hover:bg-white rounded-full flex items-center justify-center text-2xl font-semibold text-gray-800 transition-all duration-200 hover:scale-110 active:scale-95 shadow-lg backdrop-blur-sm touch-manipulation"
            title="Reset View">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
        </button>
    </div>

    <!-- Map Container -->
    <main id="mapContainer" class="w-full h-full overflow-hidden map-container bg-gray-800">
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="absolute inset-0 flex items-center justify-center bg-gray-800 z-50">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"></div>
                <p class="text-white text-lg">Loading Campus Map...</p>
            </div>
        </div>

        <div id="mapWrapper" class="relative select-none"
            style="transform: translate(0px, 0px) scale(1); width: 1400px; height: 933px; transform-origin: 0 0;">
            <div id="mapBackground" class="w-full h-full relative"
                style="background-image: url('map.png'); background-size: cover; background-position: center; background-repeat: no-repeat;">
                <!-- Stylized SVG Map -->
                <svg class="absolute inset-0 w-full h-full pointer-events-none opacity-0" viewBox="0 0 1400 933">
                    <defs>
                        <filter id="roadShadow">
                            <feDropShadow dx="0" dy="2" stdDeviation="3" floodOpacity="0.3" />
                        </filter>
                    </defs>
                    <path d="M 100 400 Q 300 380 500 400 L 700 400 Q 900 420 1100 400" stroke="#f3f4f6"
                        stroke-width="20" fill="none" filter="url(#roadShadow)" opacity="0.9" />
                    <path d="M 100 500 Q 300 480 500 500 L 700 500 Q 900 520 1100 500" stroke="#f3f4f6"
                        stroke-width="15" fill="none" filter="url(#roadShadow)" opacity="0.8" />
                    <path d="M 200 200 L 200 700" stroke="#f3f4f6" stroke-width="15" fill="none"
                        filter="url(#roadShadow)" opacity="0.8" />
                    <path d="M 400 150 L 400 750" stroke="#f3f4f6" stroke-width="15" fill="none"
                        filter="url(#roadShadow)" opacity="0.8" />
                    <path d="M 600 100 L 600 800" stroke="#f3f4f6" stroke-width="18" fill="none"
                        filter="url(#roadShadow)" opacity="0.9" />
                    <path d="M 800 120 L 800 780" stroke="#f3f4f6" stroke-width="15" fill="none"
                        filter="url(#roadShadow)" opacity="0.8" />
                    <path d="M 1000 150 L 1000 750" stroke="#f3f4f6" stroke-width="12" fill="none"
                        filter="url(#roadShadow)" opacity="0.7" />
                    <path d="M 200 300 Q 300 290 400 300" stroke="#f3f4f6" stroke-width="12" fill="none"
                        opacity="0.7" />
                    <path d="M 400 600 Q 500 590 600 600" stroke="#f3f4f6" stroke-width="12" fill="none"
                        opacity="0.7" />
                    <path d="M 600 250 Q 700 240 800 250" stroke="#f3f4f6" stroke-width="12" fill="none"
                        opacity="0.7" />
                    <g filter="url(#roadShadow)">
                        <rect x="80" y="320" width="100" height="70" fill="#CD853F" stroke="#8B4513" stroke-width="2"
                            rx="5" />
                        <rect x="80" y="550" width="100" height="80" fill="#CD853F" stroke="#8B4513" stroke-width="2"
                            rx="5" />
                        <rect x="80" y="650" width="100" height="80" fill="#CD853F" stroke="#8B4513" stroke-width="2"
                            rx="5" />
                        <rect x="300" y="450" width="140" height="90" fill="#E6E6FA" stroke="#D3D3D3" stroke-width="2"
                            rx="5" />
                        <rect x="300" y="350" width="120" height="80" fill="#F0F8FF" stroke="#D3D3D3" stroke-width="2"
                            rx="5" />
                        <rect x="180" y="630" width="100" height="80" fill="#E6E6FA" stroke="#D3D3D3" stroke-width="2"
                            rx="5" />
                        <rect x="300" y="680" width="120" height="90" fill="#F0F8FF" stroke="#D3D3D3" stroke-width="2"
                            rx="5" />
                        <rect x="650" y="320" width="130" height="100" fill="#FFE4B5" stroke="#DDD" stroke-width="2"
                            rx="5" />
                        <rect x="520" y="550" width="110" height="85" fill="#E6E6FA" stroke="#D3D3D3" stroke-width="2"
                            rx="5" />
                        <rect x="520" y="650" width="110" height="85" fill="#F0F8FF" stroke="#D3D3D3" stroke-width="2"
                            rx="5" />
                        <rect x="750" y="420" width="90" height="70" fill="#FF6347" stroke="#DC143C" stroke-width="2"
                            rx="5" />
                        <g transform="translate(1000, 150)">
                            <rect x="0" y="0" width="50" height="40" fill="#DEB887" stroke="#CD853F" stroke-width="1"
                                rx="3" />
                            <rect x="55" y="0" width="50" height="40" fill="#DEB887" stroke="#CD853F" stroke-width="1"
                                rx="3" />
                            <rect x="110" y="0" width="50" height="40" fill="#DEB887" stroke="#CD853F" stroke-width="1"
                                rx="3" />
                            <rect x="0" y="45" width="50" height="40" fill="#DEB887" stroke="#CD853F" stroke-width="1"
                                rx="3" />
                            <rect x="55" y="45" width="50" height="40" fill="#DEB887" stroke="#CD853F" stroke-width="1"
                                rx="3" />
                            <rect x="110" y="45" width="50" height="40" fill="#DEB887" stroke="#CD853F" stroke-width="1"
                                rx="3" />
                        </g>
                        <rect x="80" y="780" width="120" height="60" fill="#32CD32" stroke="#228B22" stroke-width="2"
                            rx="5" />
                        <rect x="220" y="780" width="100" height="80" fill="#90EE90" stroke="#228B22" stroke-width="2"
                            rx="5" />
                    </g>
                    <g opacity="0.6">
                        <circle cx="250" cy="250" r="20" fill="#228B22" />
                        <circle cx="450" cy="200" r="25" fill="#32CD32" />
                        <circle cx="650" cy="180" r="22" fill="#228B22" />
                        <circle cx="850" cy="220" r="18" fill="#32CD32" />
                        <circle cx="150" cy="450" r="15" fill="#32CD32" />
                        <circle cx="550" cy="350" r="20" fill="#228B22" />
                        <circle cx="750" cy="550" r="25" fill="#32CD32" />
                        <circle cx="950" cy="450" r="20" fill="#228B22" />
                        <circle cx="350" cy="550" r="18" fill="#32CD32" />
                        <circle cx="1150" cy="350" r="22" fill="#228B22" />
                    </g>
                    <text x="700" y="100" text-anchor="middle" fill="white" font-size="36" font-weight="bold"
                        text-shadow="2px 2px 4px rgba(0,0,0,0.5)" font-family="sans-serif">GIKI Chronicles</text>
                    <text x="700" y="130" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="18"
                        font-family="sans-serif">Interactive Campus Map</text>
                </svg>
            </div>

            <!-- Pins Container -->
            <div id="pinsContainer"></div>
        </div>
    </main>

    <!-- Info Box Container -->
    <div id="infoBoxContainer" class="fixed inset-0 pointer-events-none z-50"></div>

    <!-- Security Utilities -->
    <script src="security-utils.js"></script>

    <script>
        console.log('Map script starting...');

        // Map state
        let scale = 1;
        let translate = { x: 0, y: 0 };
        let isMapDragging = false;
        let dragStart = { x: 0, y: 0, translateX: 0, translateY: 0 };
        let touchStart = { distance: 0, scale: 1, centerX: 0, centerY: 0 };
        let lastTouchTime = 0;
        let activeInfoBox = null;

        // DOM elements
        const mapContainer = document.getElementById('mapContainer');
        const mapWrapper = document.getElementById('mapWrapper');
        const pinsContainer = document.getElementById('pinsContainer');
        const infoBoxContainer = document.getElementById('infoBoxContainer');

        // Debug DOM elements
        console.log('DOM elements:', {
            mapContainer: !!mapContainer,
            mapWrapper: !!mapWrapper,
            pinsContainer: !!pinsContainer,
            infoBoxContainer: !!infoBoxContainer
        });

        // Location data
        const locations = {
            'hostels-11-12': {
                title: 'Hostels 11 & 12',
                description: 'Two of the newest boysâ€™ hostels at GIKI, primarily accommodating undergraduate freshmen. They feature spacious rooms, community washrooms, and common rooms.'
            },
            'senior-hostels': {
                title: 'Senior Hostels',
                description: 'Residential blocks designed for senior undergraduate students. These older hostels are usually allotted to undergraduates from 2nd year onwards.'
            },
            'new-girls-hostel': {
                title: 'New Girls Hostel (H13)',
                description: 'A modern residential facility for female students with state-of-the-art amenities and comfortable living spaces.'
            },
            'central-library': {
                title: 'Central Library',
                description: 'The main library of GIKI housing extensive collections of books, journals, and digital resources. Featuring quiet study rooms.'
            },
            'new-academic': {
                title: 'New Academic Block',
                description: 'A modern academic building with contemporary classrooms, state-of-the-art laboratories, and faculty offices equipped with the latest educational technology.'
            },
            'fbs': {
                title: 'Faculty of Basic Sciences (FBS)',
                description: 'Houses the departments of Mathematics, Physics, and Chemistry. Includes specialized laboratories and research facilities.'
            },
            'fcse': {
                title: 'Faculty of Computer Science & Engineering (FCSE)',
                description: 'A state-of-the-art facility for computer science programs, featuring computer labs and networking facilities.'
            },
            'fmce': {
                title: 'Faculty of Materials & Chemical Engineering (FMCE)',
                description: 'An advanced facility with modern laboratories, workshops, and testing facilities for hands-on learning.'
            },
            'fme': {
                title: 'Faculty of Mechanical Engineering (FME)',
                description: 'A specialized facility for mechanical engineering programs, featuring advanced laboratories and testing facilities.'
            },
            'giki-main': {
                title: 'AHA Auditorium',
                description: 'The central auditorium of the university, hosting major events.'
            },
            'oric': {
                title: 'ORIC',
                description: 'The Office of Research, Innovation and Commercialization, facilitating research projects and industry collaborations.'
            },
            'brabers': {
                title: 'Brabers Building',
                description: 'A multi-purpose academic building housing various departments of the MGS Faculty and exam halls.'
            },
            'medical-center': {
                title: 'Medical Center',
                description: 'A comprehensive on-campus healthcare facility providing medical services to students, faculty, and staff.'
            },
            'faculty-club': {
                title: 'Faculty Club',
                description: 'A recreational and dining facility for faculty members and staff, providing restaurant services and meeting rooms.'
            },
            'central-mess': {
                title: 'Central Mess',
                description: 'The main dining facility for students, offering breakfast, lunch, and dinner in spacious dining halls.'
            },
            'tuck': {
                title: 'Tuck Shop',
                description: 'Campus convenience stores and restaurants providing snacks, beverages, and daily essentials. A popular gathering spot.'
            },
            'residential-villas': {
                title: 'C-type Residential Villas',
                description: 'Premium housing facilities for faculty, offering comfortable living spaces.'
            },
            'residential-area': {
                title: 'Residential Area',
                description: 'A comprehensive residential complex for faculty and staff families, featuring various housing units and parks.'
            },
            'helipad': {
                title: 'Helipad',
                description: 'A helicopter landing facility used for official visits.'
            },
            'sports-complex': {
                title: 'Sports Complex',
                description: 'A multi-sport facility featuring indoor courts, a gymnasium, and a tennis court.'
            },
            'main-ground': {
                title: 'Main Ground',
                description: 'A large outdoor sports ground used for cricket, football, and athletics, and for hosting major university events.'
            },
            'student-mosque': {
                title: 'Student Mosque',
                description: 'A centrally located prayer facility for the student community.'
            },
            'tuck-mosque': {
                title: 'Tuck Mosque',
                description: 'A prayer facility located near the Tuck. This was the first building ever constructed in GIKI.'
            },
            'residential-mosque': {
                title: 'Residential Area Mosque',
                description: 'A community mosque serving the residential area for faculty and staff families.'
            },
            'hbl-bank': {
                title: 'HBL Bank',
                description: 'An on-campus banking facility providing financial services to the university community.'
            },
            'giki-school': {
                title: 'GIKI School and College',
                description: 'An educational institution affiliated with GIKI, providing quality education at school and college levels.'
            },
            'admin-block': {
                title: 'Admin Block',
                description: 'The central administrative building housing key offices such as student services and admissions.'
            },
            'logik': {
                title: 'LOGIK',
                description: "GIKI's very own clock tower and innovation hub."
            },
            'giki-guest-house': {
                title: 'GIKI Guest House',
                description: 'Accommodation for visiting scholars and official guests, featuring comfortable rooms and conference facilities.'
            }
        };


        // Pin colors
        const pinColors = {
            hostel: '#FF1493', academic: '#4169E1', admin: '#FF8C00', medical: '#DC143C',
            residential: '#32CD32', facility: '#8A2BE2', special: '#00CED1', dining: '#FF6347'
        };

        // Load pin positions from JSON file
        let pins = [];

        // Utility functions
        function getMinScale() {
            const { width, height } = mapContainer.getBoundingClientRect();
            return Math.min(width / 1400, height / 933);
        }

        function updateMapTransform() {
            mapWrapper.style.transform = `translate(${translate.x}px, ${translate.y}px) scale(${scale})`;
        }

        function getEventCoords(e) {
            return e.touches?.[0] ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY };
        }

        function createTouchRipple(x, y) {
            const ripple = document.createElement('div');
            ripple.className = 'touch-ripple animate-touchRipple';
            ripple.style.left = (x - 20) + 'px';
            ripple.style.top = (y - 20) + 'px';
            ripple.style.width = '40px';
            ripple.style.height = '40px';
            document.body.appendChild(ripple);

            setTimeout(() => {
                ripple.remove();
            }, 600);
        }

        // Map controls
        function zoomIn() {
            const newScale = Math.min(5, scale * 1.3);
            const scaleChange = newScale / scale;
            const { width, height } = mapContainer.getBoundingClientRect();
            const centerX = width / 2;
            const centerY = height / 2;

            translate.x = centerX - (centerX - translate.x) * scaleChange;
            translate.y = centerY - (centerY - translate.y) * scaleChange;
            scale = newScale;
            updateMapTransform();
        }

        function zoomOut() {
            const minScale = getMinScale();
            const newScale = Math.max(minScale, scale / 1.3);
            const scaleChange = newScale / scale;
            const { width, height } = mapContainer.getBoundingClientRect();
            const centerX = width / 2;
            const centerY = height / 2;

            translate.x = centerX - (centerX - translate.x) * scaleChange;
            translate.y = centerY - (centerY - translate.y) * scaleChange;
            scale = newScale;
            updateMapTransform();
        }

        function resetView() {
            const minScale = getMinScale();
            scale = minScale;
            const { width, height } = mapContainer.getBoundingClientRect();
            translate.x = (width - 1400 * minScale) / 2;
            translate.y = (height - 933 * minScale) / 2;
            updateMapTransform();
        }

        // Pin functions
        function createPinElement(pin) {
            const pinDiv = document.createElement('div');
            pinDiv.className = 'absolute transform -translate-x-1/2 -translate-y-full transition-transform duration-300 z-10 cursor-pointer touch-manipulation';
            pinDiv.style.left = pin.left;
            pinDiv.style.top = pin.top;
            pinDiv.dataset.pinId = pin.id;

            const color = pinColors[pin.type] || '#FFFFFF';

            // Create pin content safely without innerHTML
            const tooltipDiv = document.createElement('div');
            tooltipDiv.className = 'absolute bottom-full mb-3 left-1/2 transform -translate-x-1/2 bg-gray-900/80 text-white px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap transition-all duration-200 shadow-xl backdrop-blur-sm opacity-0 translate-y-2 pointer-events-none';
            tooltipDiv.textContent = pin.label;

            const tooltipArrow = document.createElement('div');
            tooltipArrow.className = 'absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-6 border-x-transparent border-t-6 border-t-gray-900/80';
            tooltipArrow.style.borderLeftWidth = '6px';
            tooltipArrow.style.borderRightWidth = '6px';
            tooltipArrow.style.borderTopWidth = '6px';

            const svgElement = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svgElement.setAttribute('width', '32');
            svgElement.setAttribute('height', '40');
            svgElement.setAttribute('viewBox', '0 0 32 40');
            svgElement.className = 'drop-shadow-lg transition-transform duration-300';
            svgElement.style.filter = `drop-shadow(0 4px 8px ${color}50)`;

            const pathElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            pathElement.setAttribute('d', 'M16 0C8.268 0 2 6.268 2 14c0 8.5 12.053 24.11 12.553 24.71a1.5 1.5 0 0 0 2.894 0C17.947 38.11 30 22.5 30 14c0-7.732-6.268-14-14-14z');
            pathElement.setAttribute('fill', color);
            pathElement.setAttribute('stroke', '#FFFFFF');
            pathElement.setAttribute('stroke-width', '2');

            const circleElement = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circleElement.setAttribute('cx', '16');
            circleElement.setAttribute('cy', '14');
            circleElement.setAttribute('r', '5');
            circleElement.setAttribute('fill', '#FFFFFF');

            svgElement.appendChild(pathElement);
            svgElement.appendChild(circleElement);

            tooltipDiv.appendChild(tooltipArrow);
            pinDiv.appendChild(tooltipDiv);
            pinDiv.appendChild(svgElement);

            // Event listeners
            pinDiv.addEventListener('mouseenter', () => {
                const tooltip = pinDiv.querySelector('div');
                tooltip.classList.remove('opacity-0', 'translate-y-2', 'pointer-events-none');
                pinDiv.style.transform = 'translate(-50%, -100%) scale(1.2)';
            });

            pinDiv.addEventListener('mouseleave', () => {
                const tooltip = pinDiv.querySelector('div');
                tooltip.classList.add('opacity-0', 'translate-y-2', 'pointer-events-none');
                pinDiv.style.transform = 'translate(-50%, -100%) scale(1)';
            });

            pinDiv.addEventListener('click', (e) => {
                e.stopPropagation();
                showInfoBox(pin.id, e.clientX, e.clientY);
            });

            pinDiv.addEventListener('touchstart', (e) => {
                e.stopPropagation();
                const touch = e.touches[0];
                createTouchRipple(touch.clientX, touch.clientY);
            });

            pinDiv.addEventListener('touchend', (e) => {
                e.stopPropagation();
                const touch = e.changedTouches[0];
                const currentTime = Date.now();
                if (currentTime - lastTouchTime < 300) {
                    showInfoBox(pin.id, touch.clientX, touch.clientY);
                }
                lastTouchTime = currentTime;
            });

            return pinDiv;
        }

        function renderPins() {
            try {
                console.log('Rendering pins...');
                // Clear pins container safely
                while (pinsContainer.firstChild) {
                    pinsContainer.removeChild(pinsContainer.firstChild);
                }
                pins.forEach(pin => {
                    pinsContainer.appendChild(createPinElement(pin));
                });
                console.log('Pins rendered successfully');
            } catch (error) {
                console.error('Error rendering pins:', error);
            }
        }

        // Info box functions
        function showInfoBox(locationId, x, y) {
            const location = locations[locationId];
            if (!location) return;

            // Close existing info box
            if (activeInfoBox) {
                activeInfoBox.remove();
            }

            const infoBox = document.createElement('div');
            infoBox.className = 'infobox pointer-events-auto';
            // Create info box content safely without innerHTML
            const closeButton = document.createElement('button');
            closeButton.className = 'infobox-close';
            closeButton.textContent = 'Ã—';
            closeButton.addEventListener('click', () => infoBox.remove());

            const titleElement = document.createElement('h3');
            titleElement.className = 'text-lg font-semibold text-white mb-2 pr-6';
            titleElement.textContent = location.title;

            const descriptionElement = document.createElement('p');
            descriptionElement.className = 'text-sm text-gray-300 leading-relaxed';
            descriptionElement.textContent = location.description;

            infoBox.appendChild(closeButton);
            infoBox.appendChild(titleElement);
            infoBox.appendChild(descriptionElement);

            // Get the actual pin position on screen (accounting for zoom and pan)
            const pin = pins.find(p => p.id === locationId);
            if (!pin) return;

            // Calculate the actual screen position of the pin
            const mapRect = mapContainer.getBoundingClientRect();
            const pinLeftPercent = parseFloat(pin.left) / 100;
            const pinTopPercent = parseFloat(pin.top) / 100;

            // Convert pin position to actual screen coordinates
            const pinScreenX = mapRect.left + translate.x + (pinLeftPercent * 1400 * scale);
            const pinScreenY = mapRect.top + translate.y + (pinTopPercent * 933 * scale);

            // Position the info box above the pin
            const { width, height } = window;
            const infoBoxWidth = 320; // Approximate width
            const infoBoxHeight = 150; // Approximate height

            // Center horizontally above the pin
            let left = pinScreenX - (infoBoxWidth / 2);
            let top = pinScreenY - infoBoxHeight - 20; // 20px gap above pin

            // Ensure info box stays within viewport with better edge detection
            if (left < 20) {
                // If it would go off the left, shift it right
                left = 20;
            } else if (left + infoBoxWidth > width - 20) {
                // If it would go off the right, shift it left
                left = width - infoBoxWidth - 20;
            }

            if (top < 20) {
                // If it would go off the top, show it below the pin instead
                top = pinScreenY + 20;
            } else if (top + infoBoxHeight > height - 20) {
                // If it would go off the bottom, adjust to fit
                top = height - infoBoxHeight - 20;
            }

            // Final safety check to ensure the info box is fully visible
            if (left < 20) left = 20;
            if (top < 20) top = 20;
            if (left + infoBoxWidth > width - 20) left = width - infoBoxWidth - 20;
            if (top + infoBoxHeight > height - 20) top = height - infoBoxHeight - 20;

            infoBox.style.left = left + 'px';
            infoBox.style.top = top + 'px';

            infoBoxContainer.appendChild(infoBox);
            activeInfoBox = infoBox;

            // Show animation
            setTimeout(() => {
                infoBox.classList.add('show');
            }, 10);

            // Auto-close after 8 seconds
            setTimeout(() => {
                if (infoBox.parentElement) {
                    infoBox.classList.remove('show');
                    setTimeout(() => {
                        if (infoBox.parentElement) {
                            infoBox.remove();
                            activeInfoBox = null;
                        }
                    }, 300);
                }
            }, 8000);
        }

        function closeInfoBox() {
            if (activeInfoBox) {
                activeInfoBox.classList.remove('show');
                setTimeout(() => {
                    if (activeInfoBox && activeInfoBox.parentElement) {
                        activeInfoBox.remove();
                        activeInfoBox = null;
                    }
                }, 300);
            }
        }

        // Map drag functions
        function handleMapDragStart(e) {
            if (e.target.closest('.pin-interactive')) return;

            // Close info box if clicking outside of it
            if (activeInfoBox && !activeInfoBox.contains(e.target)) {
                closeInfoBox();
                return;
            }

            e.preventDefault();
            isMapDragging = true;
            const coords = getEventCoords(e);
            dragStart = { x: coords.x, y: coords.y, translateX: translate.x, translateY: translate.y };

            // Create touch ripple
            createTouchRipple(coords.x, coords.y);
        }

        function handleDrag(e) {
            if (isMapDragging) {
                e.preventDefault();
                const coords = getEventCoords(e);
                translate.x = dragStart.translateX + (coords.x - dragStart.x);
                translate.y = dragStart.translateY + (coords.y - dragStart.y);
                updateMapTransform();
            }
        }

        function handleDragEnd() {
            isMapDragging = false;
        }

        // Touch gesture handling
        function handleTouchStart(e) {
            if (e.touches.length === 2) {
                const [t1, t2] = e.touches;
                const distance = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
                const centerX = (t1.clientX + t2.clientX) / 2;
                const centerY = (t1.clientY + t2.clientY) / 2;

                touchStart = {
                    distance: distance,
                    scale: scale,
                    centerX: centerX,
                    centerY: centerY
                };
            } else if (e.touches.length === 1) {
                // Check if touching outside info box
                const touch = e.touches[0];
                const elementAtTouch = document.elementFromPoint(touch.clientX, touch.clientY);

                if (activeInfoBox && !activeInfoBox.contains(elementAtTouch)) {
                    closeInfoBox();
                    return;
                }

                handleMapDragStart(e);
            }
        }

        function handleTouchMove(e) {
            if (e.touches.length === 2) {
                e.preventDefault();
                const [t1, t2] = e.touches;
                const currentDist = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);

                if (touchStart.distance > 0) {
                    const minScale = getMinScale();
                    const newScale = Math.max(minScale, Math.min(5, touchStart.scale * (currentDist / touchStart.distance)));
                    const scaleChange = newScale / scale;

                    const rect = mapContainer.getBoundingClientRect();
                    const centerX = touchStart.centerX - rect.left;
                    const centerY = touchStart.centerY - rect.top;

                    translate.x = centerX - (centerX - translate.x) * scaleChange;
                    translate.y = centerY - (centerY - translate.y) * scaleChange;
                    scale = newScale;
                    updateMapTransform();
                }
            } else if (e.touches.length === 1 && isMapDragging) {
                handleDrag(e);
            }
        }

        // Load pin positions from JSON file
        async function loadPinPositions() {
            try {
                console.log('Loading pin positions...');
                const response = await fetch('MAPPOSITIONS.JSON');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                pins = await response.json();
                console.log('Pins loaded:', pins.length);
                renderPins();
            } catch (error) {
                console.error('Error loading pin positions:', error);
                // Fallback to default positions if JSON loading fails
                pins = [
                    { id: 'hostels-11-12', label: 'Hostels 11 & 12', left: '8%', top: '35%', type: 'hostel' },
                    { id: 'senior-hostels', label: 'Senior Hostels', left: '8%', top: '65%', type: 'hostel' },
                    { id: 'new-girls-hostel', label: 'New Girls Hostel', left: '52%', top: '28%', type: 'hostel' },
                    { id: 'central-library', label: 'Central Library', left: '32%', top: '52%', type: 'academic' },
                    { id: 'new-academic', label: 'New Academic Block', left: '32%', top: '60%', type: 'academic' },
                    { id: 'fbs', label: 'FBS', left: '20%', top: '68%', type: 'academic' },
                    { id: 'fcse', label: 'FCSE', left: '32%', top: '78%', type: 'academic' },
                    { id: 'fmce', label: 'FMCE', left: '52%', top: '60%', type: 'academic' },
                    { id: 'fme', label: 'FME', left: '52%', top: '72%', type: 'academic' },
                    { id: 'giki-main', label: 'GIKI Main', left: '52%', top: '40%', type: 'admin' },
                    { id: 'oric', label: 'ORIC', left: '52%', top: '35%', type: 'admin' },
                    { id: 'brabers', label: 'Brabers Building', left: '47%', top: '38%', type: 'admin' },
                    { id: 'medical-center', label: 'Medical Center', left: '58%', top: '48%', type: 'medical' },
                    { id: 'faculty-club', label: 'Faculty Club', left: '18%', top: '42%', type: 'facility' },
                    { id: 'central-mess', label: 'Central Mess', left: '20%', top: '60%', type: 'dining' },
                    { id: 'tuck', label: 'Tuck', left: '68%', top: '52%', type: 'dining' },
                    { id: 'residential-villas', label: 'C-type Residential Villas', left: '78%', top: '18%', type: 'residential' },
                    { id: 'residential-area', label: 'Residential Area', left: '85%', top: '25%', type: 'residential' },
                    { id: 'helipad', label: 'Helipad', left: '42%', top: '18%', type: 'special' },
                    { id: 'sports-complex', label: 'Sports Complex', left: '8%', top: '88%', type: 'facility' },
                    { id: 'main-ground', label: 'Main Ground', left: '20%', top: '88%', type: 'facility' },
                    { id: 'student-mosque', label: 'Student Mosque', left: '18%', top: '78%', type: 'facility' },
                    { id: 'tuck-mosque', label: 'Tuck Mosque', left: '78%', top: '70%', type: 'facility' },
                    { id: 'residential-mosque', label: 'Residential Area Mosque', left: '85%', top: '30%', type: 'facility' },
                    { id: 'hbl-bank', label: 'HBL Bank', left: '68%', top: '68%', type: 'facility' },
                    { id: 'giki-school', label: 'GIKI School and College', left: '78%', top: '75%', type: 'academic' },
                    { id: 'admin-block', label: 'Admin Block', left: '32%', top: '88%', type: 'admin' },
                    { id: 'logik', label: 'LOGIK', left: '42%', top: '88%', type: 'admin' },
                    { id: 'giki-guest-house', label: 'GIKI Guest House', left: '58%', top: '88%', type: 'hostel' }
                ];
                renderPins();
            }
        }

        // Event listeners
        document.getElementById('zoomIn').addEventListener('click', zoomIn);
        document.getElementById('zoomOut').addEventListener('click', zoomOut);
        document.getElementById('resetView').addEventListener('click', resetView);



        // Mouse events
        mapContainer.addEventListener('mousedown', handleMapDragStart);
        document.addEventListener('mousemove', handleDrag);
        document.addEventListener('mouseup', handleDragEnd);

        // Touch events
        mapContainer.addEventListener('touchstart', handleTouchStart, { passive: false });
        mapContainer.addEventListener('touchmove', handleTouchMove, { passive: false });
        mapContainer.addEventListener('touchend', handleDragEnd);

        // Wheel zoom
        mapContainer.addEventListener('wheel', (e) => {
            e.preventDefault();
            const rect = mapContainer.getBoundingClientRect();
            const minScale = getMinScale();
            const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
            const newScale = Math.max(minScale, Math.min(5, scale * zoomFactor));
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            const scaleChange = newScale / scale;

            translate.x = mouseX - (mouseX - translate.x) * scaleChange;
            translate.y = mouseY - (mouseY - translate.y) * scaleChange;
            scale = newScale;
            updateMapTransform();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            switch (e.key) {
                case 'Escape':
                    closeInfoBox();
                    break;
                case '+':
                case '=':
                    e.preventDefault();
                    zoomIn();
                    break;
                case '-':
                    e.preventDefault();
                    zoomOut();
                    break;
                case 'Home':
                case 'r':
                    e.preventDefault();
                    resetView();
                    break;
            }
        });

        // Initialize with error handling
        try {
            console.log('Initializing map...');

            // Check if map image is loaded
            const mapImage = new Image();
            mapImage.onload = function () {
                console.log('Map image loaded, initializing...');
                resetView();
                loadPinPositions();
                console.log('Map initialized successfully');

                // Hide loading indicator after a short delay to ensure everything is rendered
                setTimeout(() => {
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    if (loadingIndicator) {
                        loadingIndicator.style.opacity = '0';
                        setTimeout(() => {
                            loadingIndicator.style.display = 'none';
                        }, 300);
                    }
                }, 1000);
            };

            mapImage.onerror = function () {
                console.error('Failed to load map image');
                // Set fallback background instead of throwing error
                const mapBackground = document.getElementById('mapBackground');
                if (mapBackground) {
                    mapBackground.style.backgroundImage = 'none';
                    mapBackground.style.backgroundColor = '#1f2937';
                    // Create fallback content safely without innerHTML
                    const fallbackContainer = document.createElement('div');
                    fallbackContainer.className = 'flex items-center justify-center h-full text-white';

                    const fallbackContent = document.createElement('div');
                    fallbackContent.className = 'text-center';

                    const emojiDiv = document.createElement('div');
                    emojiDiv.className = 'text-6xl mb-4';
                    emojiDiv.textContent = 'ðŸ—ºï¸';

                    const titleDiv = document.createElement('h2');
                    titleDiv.className = 'text-2xl font-bold mb-2';
                    titleDiv.textContent = 'Campus Map';

                    const descriptionDiv = document.createElement('p');
                    descriptionDiv.className = 'text-gray-300';
                    descriptionDiv.textContent = 'Map image unavailable, but pins are still functional';

                    fallbackContent.appendChild(emojiDiv);
                    fallbackContent.appendChild(titleDiv);
                    fallbackContent.appendChild(descriptionDiv);
                    fallbackContainer.appendChild(fallbackContent);

                    // Clear existing content and add fallback
                    while (mapBackground.firstChild) {
                        mapBackground.removeChild(mapBackground.firstChild);
                    }
                    mapBackground.appendChild(fallbackContainer);
                }
                // Continue with initialization
                resetView();
                loadPinPositions();

                // Hide loading indicator
                setTimeout(() => {
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    if (loadingIndicator) {
                        loadingIndicator.style.opacity = '0';
                        setTimeout(() => {
                            loadingIndicator.style.display = 'none';
                        }, 300);
                    }
                }, 1000);
            };

            mapImage.src = 'map.png';
        } catch (error) {
            console.error('Error initializing map:', error);
            // Hide loading indicator on error
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                // Create error content safely without innerHTML
                const errorContainer = document.createElement('div');
                errorContainer.className = 'text-center';

                const warningDiv = document.createElement('div');
                warningDiv.className = 'text-red-400 text-6xl mb-4';
                warningDiv.textContent = 'âš ï¸';

                const errorTitle = document.createElement('p');
                errorTitle.className = 'text-white text-lg mb-2';
                errorTitle.textContent = 'Failed to load map';

                const errorDescription = document.createElement('p');
                errorDescription.className = 'text-gray-300 text-sm';
                errorDescription.textContent = 'Please refresh the page or check your connection';

                const retryButton = document.createElement('button');
                retryButton.className = 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700';
                retryButton.textContent = 'Retry';
                retryButton.addEventListener('click', () => window.location.reload());

                errorContainer.appendChild(warningDiv);
                errorContainer.appendChild(errorTitle);
                errorContainer.appendChild(errorDescription);
                errorContainer.appendChild(retryButton);

                // Clear existing content and add error content
                while (loadingIndicator.firstChild) {
                    loadingIndicator.removeChild(loadingIndicator.firstChild);
                }
                loadingIndicator.appendChild(errorContainer);
            }
        }

        // Handle window resize
        window.addEventListener('resize', resetView);
    </script>
</body>

</html>